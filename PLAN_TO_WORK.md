# Follow SYSTEM_OVERVIEW.md and ARCHITECTURE_AND_COMPONENTS.md

# План работы (Work Plan)

## Обзор проекта
**bot-generic** — это микро-SaaS приложение на базе промптов с поддержкой нескольких каналов (Telegram, Web) и интегрированной системой управления пользователями, биллингом и политиками.

---

## Фаза 1: Инфраструктура и базовая конфигурация

### 1.1 Настройка основной конфигурации
- [ ] Завершить конфигурацию приложения в `core/config.py`
- [ ] Установить переменные окружения (API ключи, DB подключение)
- [ ] Создать `.env` файл с примерами переменных
- [ ] Запустить инициализацию базы данных

### 1.2 Настройка базы данных
- [ ] Реализовать подключение к БД в `core/database.py`
- [ ] Создать миграции для всех моделей
- [ ] Инициализировать основные таблицы (users, sessions, billing, usage)
- [ ] Добавить индексы для оптимизации запросов

### 1.3 Система безопасности
- [ ] Завершить реализацию `core/security.py`
- [ ] Настроить JWT/токены аутентификации
- [ ] Реализовать хеширование паролей
- [ ] Добавить CORS и защиту от CSRF атак

---

## Фаза 2: Модели данных и ORM

### 2.1 Определение моделей
- [ ] Создать модели в `models/__init__.py`:
  - User (пользователи)
  - Organization (организации)
  - BillingAccount (биллинг)
  - UsageRecord (отслеживание использования)
  - Agent (агенты/боты)
  - PolicyRule (политики доступа)
  - Session (сессии)

### 2.2 Валидация данных
- [ ] Добавить Pydantic схемы для валидации
- [ ] Создать кастомные валидаторы
- [ ] Реализовать сериализацию/десериализацию

---

## Фаза 3: Аутентификация и авторизация

### 3.1 Маршруты аутентификации
- [ ] Реализовать `auth/router.py`:
  - POST /auth/register - регистрация
  - POST /auth/login - вход
  - POST /auth/refresh - обновление токена
  - POST /auth/logout - выход
  - GET /auth/profile - профиль пользователя

### 3.2 Управление доступом
- [ ] Создать middleware для проверки токенов
- [ ] Реализовать role-based access control (RBAC)
- [ ] Добавить проверки прав доступа к ресурсам

---

## Фаза 4: Система управления каналами

### 4.1 Базовая архитектура
- [ ] Завершить `channels/base.py` с интерфейсом Channel
- [ ] Реализовать abstract methods для всех каналов
- [ ] Добавить логирование и обработку ошибок

### 4.2 Telegram канал
- [ ] Реализовать `channels/telegram.py`:
  - Подключение к Telegram Bot API
  - Получение сообщений
  - Отправка сообщений пользователям
  - Обработка коллбэков
  - Управление медиафайлами

### 4.3 Web канал
- [ ] Реализовать `channels/web.py`:
  - REST API endpoints для web клиента
  - WebSocket поддержка для реал-тайм общения
  - Сессионное управление

### 4.4 Тестирование каналов
- [ ] Unit тесты для каждого канала
- [ ] Интеграционные тесты
- [ ] Mock тесты для внешних API

---

## Фаза 5: Система промптов и агентов

### 5.1 Модели промптов
- [ ] Завершить `prompts/models.py`:
  - Структура промпта
  - Параметры и переменные
  - Версионирование промптов

### 5.2 Рантайм агентов
- [ ] Реализовать `agents/runtime.py`:
  - Загрузка и выполнение агентов
  - Управление состоянием агента
  - Обработка ошибок и таймауты
  - Логирование и мониторинг

### 5.3 Интеграция с LLM
- [ ] Настроить подключение к OpenAI API (или другому провайдеру)
- [ ] Реализовать обработку промптов
- [ ] Добавить кэширование ответов
- [ ] Обработка потоковых ответов

---

## Фаза 6: Система политик

### 6.1 Engine политик
- [ ] Реализовать `policy/engine.py`:
  - Загрузка и парсинг политик
  - Проверка прав доступа
  - Управление ограничениями

### 6.2 Типы политик
- [ ] Создать политики:
  - Rate limiting
  - Resource access
  - User quotas
  - Feature flags

---

## Фаза 7: Отслеживание использования

### 7.1 Трекер использования
- [ ] Реализовать `usage/tracker.py`:
  - Логирование использования API
  - Подсчет потребленных ресурсов
  - Сохранение в БД
  - Генерация отчетов

### 7.2 Метрики
- [ ] Отслеживать:
  - Количество запросов
  - Использование токенов LLM
  - Время отклика
  - Ошибки

---

## Фаза 8: Система биллинга

### 8.1 Маршруты биллинга
- [ ] Реализовать `billing/router.py`:
  - GET /billing/account - информация о биллинге
  - GET /billing/usage - использование и затраты
  - POST /billing/payment - обработка платежа
  - GET /billing/history - история платежей
  - POST /billing/subscribe - подписка на план

### 8.2 Платежные системы
- [ ] Интегрировать Paddle
- [ ] Реализовать управление подписками
- [ ] Автоматические платежи
- [ ] Обработка webhook событий от Paddle

### 8.2.1 Планы подписки (Subscription Plans)
- [ ] Создать базовые планы подписки:
  - **Daily** (День) - $0.99/день
    - Ограничение: 100 запросов в день
    - Поддержка: Email
  - **Weekly** (Неделя) - $4.99/неделя
    - Ограничение: 1,000 запросов в неделю
    - Поддержка: Email + Chat
  - **Monthly** (Месяц) - $19.99/месяц
    - Ограничение: 10,000 запросов в месяц
    - Поддержка: Email + Chat + Priority
    - Включено: API доступ
  - **Yearly** (Год) - $199.99/год
    - Ограничение: 150,000 запросов в год
    - Поддержка: Email + Chat + Priority + Phone
    - Включено: API доступ + Advanced analytics
    - Скидка: -17% от месячной цены
- [ ] Реализовать логику переключения между планами
- [ ] Добавить пробный период (14 дней)
- [ ] Обработка отмены подписки
- [ ] Автоматическое продление подписки

### 8.3 Расчеты и отчеты
- [ ] Расчет стоимости использования
- [ ] Генерация инвойсов
- [ ] Отправка уведомлений о платежах

---

## Фаза 9: Панель администратора

### 9.1 Маршруты администратора
- [ ] Реализовать `admin/router.py`:
  - GET /admin/users - список пользователей
  - GET /admin/users/{id} - информация пользователя
  - PUT /admin/users/{id} - изменение пользователя
  - DELETE /admin/users/{id} - удаление пользователя
  - GET /admin/stats - статистика системы
  - GET /admin/logs - логи системы

### 9.2 Управление системой
- [ ] Создание и удаление пользователей (администратором)
- [ ] Просмотр использования и статистики
- [ ] Управление политиками
- [ ] Система уведомлений

---

## Фаза 10: Тестирование и документация

### 10.1 Unit тесты
- [ ] Написать тесты для всех модулей
- [ ] Добавить fixtures и mocks
- [ ] Достичь минимум 80% покрытия кода

### 10.2 Интеграционные тесты
- [ ] Тестирование API endpoints
- [ ] Тестирование интеграций с внешними сервисами
- [ ] E2E тесты критических потоков

### 10.3 Документация
- [ ] API документация (Swagger/OpenAPI)
- [ ] Документация по настройке
- [ ] Гайды для разработчиков
- [ ] Гайды для пользователей

---

## Фаза 11: Развертывание и производство

### 11.1 Containerization
- [ ] Создать Dockerfile
- [ ] Настроить Docker Compose для локальной разработки
- [ ] Оптимизировать образ для production

### 11.2 CI/CD
- [ ] Настроить GitHub Actions (или другой CI/CD)
- [ ] Автоматические тесты при push
- [ ] Автоматическое развертывание

### 11.3 Мониторинг и логирование
- [ ] Настроить логирование (ELK, Sentry и т.д.)
- [ ] Добавить метрики (Prometheus, Grafana)
- [ ] Настроить алерты на критические события

### 11.4 Production deployment
- [ ] Подготовить сервер
- [ ] Настроить reverse proxy (Nginx)
- [ ] SSL/TLS сертификаты
- [ ] Автоматические резервные копии

---

## Фаза 12: Оптимизация и улучшения

### 12.1 Производительность
- [ ] Кэширование (Redis)
- [ ] Оптимизация БД запросов
- [ ] CDN для статических файлов
- [ ] Асинхронная обработка задач (Celery)

### 12.2 Масштабируемость
- [ ] Микросервисная архитектура (если нужна)
- [ ] Load balancing
- [ ] Горизонтальное масштабирование

### 12.3 Безопасность
- [ ] Регулярные security audits
- [ ] Обновление зависимостей
- [ ] Penetration testing
- [ ] DDoS protection

---

## Фаза 13: Мультиязычность (I18n)

### 13.1 Локаль пользователя
- [ ] Добавить поле `locale` в модели пользователя (БД), дефолт `en`
- [ ] Хранить локаль на уровне пользователя и учитывать в ответах
- [ ] Конфигурация `supported_locales` в настройках

### 13.2 API для смены локали
- [ ] `PUT /auth/locale` — смена локали текущего пользователя
- [ ] Расширить `PUT /auth/profile` для установки `locale`
- [ ] Валидация по списку поддерживаемых локалей

### 13.3 Тексты и переводы
- [ ] Структура ресурсов переводов для UI/бота
- [ ] Базовые ключи сообщений (help/start/profile)
- [ ] Фолбэк на дефолтную локаль при отсутствии ключа

### 13.4 Интеграция каналов
- [ ] Telegram: ответы по локали пользователя
- [ ] Web: локализованные строки, выбор локали в профиле


## Приоритетные задачи

**Высокий приоритет (Must have):**
1. Настройка БД и моделей данных
2. Система аутентификации
3. Telegram канал
4. Система промптов и агентов
5. API endpoints

**Средний приоритет (Should have):**
1. Web канал
2. Система биллинга
3. Политики и permissions
4. Мониторинг использования

**Низкий приоритет (Nice to have):**
1. Панель администратора (advanced features)
2. Микросервисная архитектура
3. Advanced аналитика

---

## Сроки (Estimated Timeline)

| Фаза | Срок |
|------|------|
| 1-3 (Инфра, модели, аутентификация) | 2-3 недели |
| 4-5 (Каналы, промпты, агенты) | 3-4 недели |
| 6-8 (Политики, биллинг, трекинг) | 2-3 недели |
| 9-10 (Администрация, тесты, документация) | 2-3 недели |
| 11-12 (Deployment, оптимизация) | 2-3 недели |
| **Итого** | **~12-16 недель** |

---

## Инструменты и технологии

- **Backend Framework**: FastAPI
- **Database**: PostgreSQL + SQLAlchemy ORM
- **Cache**: Redis
- **Task Queue**: Celery
- **Authentication**: JWT
- **Payment**: Paddle API
- **LLM**: OpenAI API
- **Messaging**: Telegram Bot API
- **Monitoring**: Sentry + Prometheus + Grafana
- **Testing**: pytest
- **Documentation**: Swagger/OpenAPI
- **Deployment**: Docker + Kubernetes (optional)
- **CI/CD**: GitHub Actions

---

## Знания и ресурсы

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Telegram Bot API](https://core.telegram.org/bots)
- [OpenAI API](https://platform.openai.com/docs)
- [Paddle API](https://developer.paddle.com/api-reference/overview)
- [Paddle Python SDK](https://github.com/PaddleHQ/paddle-python-sdk)

---

**Последнее обновление**: 11 января 2026
**Версия плана**: 1.0
