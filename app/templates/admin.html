<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - {{ t('site_name') }}</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2.0">
    <link rel="stylesheet" href="/static/css/admin.css?v=1.0">
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">{{ t('site_name') }} Admin</a>
            <div class="nav-right">
                <a href="/dashboard" class="btn btn-secondary">User Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </nav>
    </header>

    <div class="admin-container">
        <div id="alertContainer"></div>
        
        <div class="admin-header">
            <h1>Admin Panel</h1>
            <div class="section-subtitle">
                Logged in as <strong id="adminName">Admin</strong>
            </div>
        </div>

        <div class="admin-tabs" role="tablist" aria-label="Admin sections">
            <button class="admin-tab active" onclick="switchTab('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard">Dashboard</button>
            <button class="admin-tab" onclick="switchTab('agents')" role="tab" aria-selected="false" aria-controls="agents">Agents</button>
            <button class="admin-tab" onclick="switchTab('prompts')" role="tab" aria-selected="false" aria-controls="prompts">Prompts</button>
            <button class="admin-tab" onclick="switchTab('users')" role="tab" aria-selected="false" aria-controls="users">Users</button>
            <button class="admin-tab" onclick="switchTab('subscriptions')" role="tab" aria-selected="false" aria-controls="subscriptions">Subscriptions</button>
            <button class="admin-tab" onclick="switchTab('plans')" role="tab" aria-selected="false" aria-controls="plans">Plans</button>
            <button class="admin-tab" onclick="switchTab('policies')" role="tab" aria-selected="false" aria-controls="policies">Policies</button>
            <button class="admin-tab" onclick="switchTab('organizations')" role="tab" aria-selected="false" aria-controls="organizations">Organizations</button>
            <button class="admin-tab" onclick="switchTab('llm-models')" role="tab" aria-selected="false" aria-controls="llm-models">LLM Models</button>
            <button class="admin-tab" onclick="switchTab('logs')" role="tab" aria-selected="false" aria-controls="logs">Usage Logs</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active" role="tabpanel" aria-labelledby="dashboard-tab">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Loading statistics</div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents" class="tab-content" role="tabpanel" aria-labelledby="agents-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Agent Management</h2>
                    <button onclick="loadAgentModelsForSelect('agentModel'); openModal('createAgentModal')" class="btn-primary">+ Create New Agent</button>
                </div>
                <div id="agentsTable" class="loading">Loading agents...</div>
            </div>
        </div>

        <!-- Prompts Tab -->
        <div id="prompts" class="tab-content" role="tabpanel" aria-labelledby="prompts-tab">
            <div class="data-table">
                <h2>Prompt Versions Management</h2>
                <div class="form-group">
                    <label>Select Agent</label>
                    <select id="agentSelect" onchange="loadAgentPrompts()">
                        <option value="">-- Choose an agent --</option>
                    </select>
                </div>
                <div id="promptsList" class="hidden">
                    <div class="section-header">
                        <button onclick="openModal('createPromptModal')" class="btn-primary">+ Create New Prompt Version</button>
                    </div>
                    <div id="promptsTable" class="loading">Loading prompts</div>
                </div>
            </div>
        </div>
        <div id="users" class="tab-content" role="tabpanel" aria-labelledby="users-tab">
            <div class="data-table">
                <h2>User Management</h2>
                <div id="usersTable" class="loading">Loading users</div>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions" class="tab-content" role="tabpanel" aria-labelledby="subscriptions-tab">
            <div class="data-table">
                <h2>Subscription Management</h2>
                <div id="subscriptionsTable" class="loading">Loading subscriptions</div>
            </div>
        </div>

        <!-- Plans Tab -->
        <div id="plans" class="tab-content" role="tabpanel" aria-labelledby="plans-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Subscription Plans</h2>
                    <button onclick="openModal('createPlanModal')" class="btn-primary">+ Create New Plan</button>
                </div>
                <div id="plansTable" class="loading">Loading plans</div>
            </div>
        </div>
        
        <!-- Policies Tab -->
        <div id="policies" class="tab-content" role="tabpanel" aria-labelledby="policies-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Policies</h2>
                    <button onclick="openModal('createPolicyModal')" class="btn-primary">+ Create New Policy</button>
                </div>
                <div id="policiesTable" class="loading">Loading policies</div>
            </div>
        </div>

        <!-- Organizations Tab -->
        <div id="organizations" class="tab-content" role="tabpanel" aria-labelledby="organizations-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Organizations</h2>
                    <button onclick="openModal('createOrgModal')" class="btn-primary">+ Create New Organization</button>
                </div>
                <div id="organizationsTable" class="loading">Loading organizations</div>
            </div>
        </div>

        <!-- LLM Models Tab -->
        <div id="llm-models" class="tab-content" role="tabpanel" aria-labelledby="llm-models-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>LLM Models</h2>
                    <button class="btn-primary" onclick="showCreateLLMModelModal()">+ Add Model</button>
                </div>
                <div id="llmModelsTable" class="loading">Loading LLM models</div>
            </div>
        </div>

        <!-- Usage Logs Tab -->
        <div id="logs" class="tab-content" role="tabpanel" aria-labelledby="logs-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Usage Logs</h2>
                    <div class="logs-filters">
                        <input type="text" id="logsSearch" placeholder="Search by endpoint or user..." onkeyup="filterLogs()">
                        <select id="logsDays" onchange="loadLogs()">
                            <option value="1">Last 24 hours</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <input type="number" id="logsLimit" min="10" max="500" value="100" placeholder="Limit" onchange="loadLogs()" style="width: 100px;">
                        <button onclick="loadLogs()" class="btn-secondary">Refresh</button>
                    </div>
                </div>
                <div id="logsTable" class="loading">Loading logs...</div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-bottom">
                <p>&copy; 2024 {{ t('site_name') }}. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editUserEmail" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="editUserActive"> Active
                </label>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="editUserAdmin"> Admin
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn-primary" onclick="saveUserChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editSubscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Subscription</h2>
                <button class="modal-close" onclick="closeModal('editSubscriptionModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization</label>
                <input type="text" id="editSubsOrg" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Plan</label>
                <select id="editSubsPlan">
                    <option value="">Loading plans...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editSubsStatus">
                    <option value="active">Active</option>
                    <option value="trialing">Trialing</option>
                    <option value="canceled">Canceled</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editSubscriptionModal')">Cancel</button>
                <button class="btn-primary" onclick="saveSubscriptionChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Plan</h2>
                <button class="modal-close" onclick="closeModal('editPlanModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="editPlanName">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="editPlanPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="editPlanInterval">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Requests</label>
                    <input type="number" id="editPlanMaxRequests" min="1">
                </div>
                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="editPlanMaxTokens" min="1">
                </div>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanApiAccess"> API Access
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanPrioritySupport"> Priority
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanAdvancedAnalytics"> Advanced
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editPlanModal')">Cancel</button>
                <button class="btn-primary" onclick="savePlanChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Agent</h2>
                <button class="modal-close" onclick="closeModal('editAgentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="editAgentName">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editAgentDescription" placeholder="What does this agent do?"></textarea>
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="editAgentSystemPrompt" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Model</label>
                    <select id="editAgentModel">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Temperature</label>
                    <input type="number" id="editAgentTemperature" min="0" max="2" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" id="editAgentMaxTokens" min="1">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editAgentActive"> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editAgentPublic"> Public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editAgentModal')">Cancel</button>
                <button class="btn-primary" onclick="saveAgentChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Agent</h2>
                <button class="modal-close" onclick="closeModal('createAgentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="agentName" placeholder="e.g., Customer Support Bot">
            </div>
            <div class="form-group">
                <label>Slug (URL-friendly identifier)</label>
                <input type="text" id="agentSlug" placeholder="e.g., support-bot">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="agentDescription" placeholder="What does this agent do?"></textarea>
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="agentSystemPrompt" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Model</label>
                    <select id="agentModel">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Temperature</label>
                    <input type="number" id="agentTemperature" min="0" max="2" step="0.1" value="0.7">
                </div>
            </div>
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" id="agentMaxTokens" min="1" value="2000">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="agentActive" checked> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="agentPublic"> Public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn-primary" onclick="createAgent()">Create Agent</button>
            </div>
        </div>
    </div>

    <!-- Create Prompt Modal -->
    <div id="createPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Prompt Version</h2>
                <button class="modal-close" onclick="closeModal('createPromptModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Prompt Name</label>
                <input type="text" id="promptName" placeholder="e.g., Welcome Message">
            </div>
            <div class="form-group">
                <label>Version</label>
                <input type="text" id="promptVersion" placeholder="1.0.0" value="1.0.0">
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="promptSystem" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-group">
                <label>User Template</label>
                <textarea id="promptTemplate" placeholder="Hello {name}, how can I help?"></textarea>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="promptActive"> Set as Active
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPromptModal')">Cancel</button>
                <button class="btn-primary" onclick="createPrompt()">Create Prompt</button>
            </div>
        </div>
    </div>

    <!-- Create Plan Modal -->
    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Plan</h2>
                <button class="modal-close" onclick="closeModal('createPlanModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="planName" placeholder="e.g., Professional Plan">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="planPrice" placeholder="9.99" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="planInterval">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Requests</label>
                    <input type="number" id="planMaxRequests" placeholder="10000" min="1">
                </div>
                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="planMaxTokens" placeholder="4000" min="1">
                </div>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planApiAccess"> API Access
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planPrioritySupport"> Priority
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planAdvancedAnalytics"> Analytics
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPlanModal')">Cancel</button>
                <button class="btn-primary" onclick="createPlan()">Create Plan</button>
            </div>
        </div>
    </div>

    <!-- Create Policy Modal -->
    <div id="createPolicyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Policy</h2>
                <button class="modal-close" onclick="closeModal('createPolicyModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Policy Name</label>
                <input type="text" id="policyName" placeholder="e.g., Free Plan Policy">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="policyDescription" placeholder="Policy description"></textarea>
            </div>
            <div class="form-group">
                <label>Max Requests Per Minute</label>
                <input type="number" id="policyMaxRequests" value="60">
            </div>
            <div class="form-group">
                <label>Max Tokens Per Request</label>
                <input type="number" id="policyMaxTokens" value="4000">
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPolicyModal')">Cancel</button>
                <button class="btn-primary" onclick="createPolicy()">Create Policy</button>
            </div>
        </div>
    </div>

    <!-- Create LLM Model Modal -->
    <div id="createLLMModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New LLM Model</h2>
                <button class="modal-close" onclick="closeModal('createLLMModelModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Model Name (identifier)</label>
                <input type="text" id="llmModelName" placeholder="e.g., gpt-4, claude-3-sonnet">
            </div>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="llmModelDisplayName" placeholder="e.g., GPT-4 (OpenAI)">
            </div>
            <div class="form-group">
                <label>Provider</label>
                <select id="llmModelProvider">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="google">Google</option>
                </select>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="llmModelApiKey" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label>API Base URL (optional)</label>
                <input type="text" id="llmModelApiBaseUrl" placeholder="https://api.openai.com/v1">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Tokens Limit</label>
                    <input type="number" id="llmModelMaxTokensLimit" min="1" value="4000" placeholder="4000">
                </div>
                <div class="form-group">
                    <label>Context Window</label>
                    <input type="number" id="llmModelContextWindow" min="1" value="8000" placeholder="8000">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="llmModelActive" checked> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="llmModelIsDefault"> Set as Default
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createLLMModelModal')">Cancel</button>
                <button class="btn-primary" onclick="createLLMModel()">Create Model</button>
            </div>
        </div>
    </div>

    <!-- Edit LLM Model Modal -->
    <div id="editLLMModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit LLM Model</h2>
                <button class="modal-close" onclick="closeModal('editLLMModelModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="editLLMModelName" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="editLLMModelDisplayName">
            </div>
            <div class="form-group">
                <label>Provider</label>
                <input type="text" id="editLLMModelProvider" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>API Key (leave empty to keep current)</label>
                <input type="password" id="editLLMModelApiKey" placeholder="••••••••">
            </div>
            <div class="form-group">
                <label>API Base URL (optional)</label>
                <input type="text" id="editLLMModelApiBaseUrl">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Tokens Limit</label>
                    <input type="number" id="editLLMModelMaxTokensLimit" min="1">
                </div>
                <div class="form-group">
                    <label>Context Window</label>
                    <input type="number" id="editLLMModelContextWindow" min="1">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editLLMModelActive"> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editLLMModelIsDefault"> Set as Default
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editLLMModelModal')">Cancel</button>
                <button class="btn-primary" onclick="saveLLMModelChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Organization Modal -->
    <div id="createOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Organization</h2>
                <button class="modal-close" onclick="closeModal('createOrgModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization Name</label>
                <input type="text" id="orgName" placeholder="e.g., Acme Corp">
            </div>
            <div class="form-group">
                <label>Slug (URL-friendly identifier)</label>
                <input type="text" id="orgSlug" placeholder="e.g., acme-corp">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="orgDescription" placeholder="Organization description"></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Users</label>
                    <input type="number" id="orgMaxUsers" min="1" value="10">
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="orgActive" checked> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createOrgModal')">Cancel</button>
                <button class="btn-primary" onclick="createOrg()">Create Organization</button>
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div id="editOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Organization</h2>
                <button class="modal-close" onclick="closeModal('editOrgModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization Name</label>
                <input type="text" id="editOrgName">
            </div>
            <div class="form-group">
                <label>Slug</label>
                <input type="text" id="editOrgSlug" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editOrgDescription"></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Users</label>
                    <input type="number" id="editOrgMaxUsers" min="1">
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editOrgActive"> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editOrgModal')">Cancel</button>
                <button class="btn-primary" onclick="saveOrgChanges()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentTab = 'dashboard';
        let editingUserId = null;
        let editingSubscriptionId = null;
        let editingPlanId = null;

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            try {
                const response = await fetch(API_BASE + endpoint, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 403) {
                    showAlert('Access denied. Admin privileges required.', 'error');
                    return null;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            event.target.classList.add('active');
            event.target.setAttribute('aria-selected', 'true');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab data
            loadTabData(tabName);
        }

        // Load tab data
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'agents':
                    await loadAgents();
                    break;
                case 'prompts':
                    await loadAgentsDropdown();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'subscriptions':
                    await loadSubscriptions();
                    break;
                case 'plans':
                    await loadPlans();
                    break;
                case 'policies':
                    await loadPolicies();
                    break;
                case 'organizations':
                    await loadOrganizations();
                    break;
                case 'llm-models':
                    await loadLLMModels();
                    break;
                case 'logs':
                    await loadLogs();
                    break;
            }
        }

        // Load dashboard statistics
        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/dashboard/stats');
                
                if (!stats) return;
                
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">${stats.total_users || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Subscriptions</h3>
                        <div class="value">${stats.active_subscriptions || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Organizations</h3>
                        <div class="value">${stats.total_organizations || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Month)</h3>
                        <div class="value">$${parseFloat(stats.revenue_month || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Today)</h3>
                        <div class="value">$${parseFloat(stats.revenue_today || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>API Requests (Month)</h3>
                        <div class="value">${stats.api_requests_month || 0}</div>
                    </div>
                `;
                
                document.getElementById('statsGrid').innerHTML = statsHtml;
            } catch (error) {
                showAlert('Failed to load statistics: ' + error.message, 'error');
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const users = await apiCall('/admin/users');
                
                if (!users || users.length === 0) {
                    document.getElementById('usersTable').innerHTML = '<div class="empty-state">No users found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    const statusBadge = user.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const roleBadge = user.is_superuser ? 
                        '<span class="badge badge-admin">Admin</span>' : 
                        '<span class="badge">User</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.email}</td>
                            <td>${user.username || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${roleBadge}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editUser(${user.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load users: ' + error.message, 'error');
            }
        }

        // Load subscriptions
        async function loadSubscriptions() {
            try {
                const subs = await apiCall('/admin/subscriptions');
                
                if (!subs || subs.length === 0) {
                    document.getElementById('subscriptionsTable').innerHTML = '<div class="empty-state">No subscriptions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Organization</th>
                                <th>Users</th>
                                <th>Plan</th>
                                <th>Status</th>
                                <th>Total Spent</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                subs.forEach(sub => {
                    const statusClass = sub.status === 'active' ? 'badge-active' : 
                                       sub.status === 'canceled' ? 'badge-inactive' : 'badge-pending';
                    
                    tableHtml += `
                        <tr>
                            <td>${sub.id}</td>
                            <td>${sub.organization_name} (#${sub.organization_id})</td>
                            <td>${sub.user_count || 0}</td>
                            <td>${sub.plan_name || 'Free'}</td>
                            <td><span class="badge ${statusClass}">${sub.status}</span></td>
                            <td>$${parseFloat(sub.total_spent || 0).toFixed(2)}</td>
                            <td>${new Date(sub.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editSubscription(${sub.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteSubscription(${sub.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('subscriptionsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load subscriptions: ' + error.message, 'error');
            }
        }

        // Load plans
        async function loadPlans() {
            try {
                const plans = await apiCall('/admin/plans');
                
                if (!plans || plans.length === 0) {
                    document.getElementById('plansTable').innerHTML = '<div class="empty-state">No plans found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Interval</th>
                                <th>Max Requests</th>
                                <th>Max Tokens</th>
                                <th>Features</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                plans.forEach(plan => {
                    const features = [];
                    if (plan.has_api_access) features.push('API');
                    if (plan.has_priority_support) features.push('Support');
                    if (plan.has_advanced_analytics) features.push('Analytics');
                    
                    tableHtml += `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>$${parseFloat(plan.price).toFixed(2)}</td>
                            <td>${plan.interval}</td>
                            <td>${plan.max_requests_per_interval}</td>
                            <td>${plan.max_tokens_per_request}</td>
                            <td>${features.length ? features.join(', ') : 'None'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="managePlanAgents(${plan.id})">Agents</button>
                                    <button class="btn-small btn-edit" onclick="editPlan(${plan.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deletePlan(${plan.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('plansTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load plans: ' + error.message, 'error');
            }
        }

        // Load policies
        async function loadPolicies() {
            try {
                const policies = await apiCall('/admin/policies');
                
                if (!policies || policies.length === 0) {
                    document.getElementById('policiesTable').innerHTML = '<div class="empty-state">No policies found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Target</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                policies.forEach(policy => {
                    const statusBadge = policy.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${policy.id}</td>
                            <td>${policy.name}</td>
                            <td>${policy.rule_type}</td>
                            <td>${policy.target_resource}</td>
                            <td>${policy.priority}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-delete" onclick="deletePolicy(${policy.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('policiesTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load policies: ' + error.message, 'error');
            }
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                document.getElementById('organizationsTable').innerHTML = '<div class="loading">Loading organizations</div>';
                const orgs = await apiCall('/admin/organizations');
                
                if (!orgs || orgs.length === 0) {
                    document.getElementById('organizationsTable').innerHTML = '<div class="empty-state">No organizations found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Members</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orgs.forEach(org => {
                    tableHtml += `
                        <tr>
                            <td>${org.id}</td>
                            <td>${org.name}</td>
                            <td><code>${org.slug}</code></td>
                            <td>${org.member_count || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editOrg(${org.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteOrg(${org.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('organizationsTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('organizationsTable').innerHTML = `<div class="error">Failed to load organizations: ${error.message}</div>`;
            }
        }

        // User functions
        async function editUser(userId) {
            try {
                editingUserId = userId;
                const user = await apiCall(`/admin/users/${userId}`);
                
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserActive').checked = user.is_active;
                document.getElementById('editUserAdmin').checked = user.is_superuser;
                openModal('editUserModal');
            } catch (error) {
                showAlert('Failed to load user details: ' + error.message, 'error');
            }
        }

        async function saveUserChanges() {
            try {
                await apiCall(`/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_active: document.getElementById('editUserActive').checked,
                        is_superuser: document.getElementById('editUserAdmin').checked
                    })
                });
                
                showAlert('User updated successfully');
                closeModal('editUserModal');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to update user: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action marks the user as inactive.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/users/${userId}`, { method: 'DELETE' });
                showAlert('User deleted successfully');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to delete user: ' + error.message, 'error');
            }
        }

        // Subscription functions
        async function editSubscription(subId) {
            try {
                editingSubscriptionId = subId;
                
                // Load full subscription details
                const sub = await apiCall(`/admin/subscriptions/${subId}`);
                
                // Load plans into dropdown
                const plans = await apiCall('/admin/plans');
                const planSelect = document.getElementById('editSubsPlan');
                planSelect.innerHTML = '';
                
                if (plans && plans.length > 0) {
                    plans.forEach(plan => {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.textContent = `${plan.name} - $${plan.price}/${plan.interval}`;
                        if (plan.id === sub.plan_id) {
                            option.selected = true;
                        }
                        planSelect.appendChild(option);
                    });
                } else {
                    planSelect.innerHTML = '<option value="">No plans available</option>';
                }
                
                document.getElementById('editSubsOrg').value = sub.organization_name;
                document.getElementById('editSubsStatus').value = sub.status;
                
                openModal('editSubscriptionModal');
            } catch (error) {
                showAlert('Failed to load subscription details: ' + error.message, 'error');
            }
        }

        async function saveSubscriptionChanges() {
            try {
                const planId = parseInt(document.getElementById('editSubsPlan').value);
                const status = document.getElementById('editSubsStatus').value;
                
                const updateData = {
                    subscription_status: status
                };
                
                if (planId) {
                    updateData.subscription_plan_id = planId;
                }
                
                await apiCall(`/admin/subscriptions/${editingSubscriptionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                showAlert('Subscription updated successfully');
                closeModal('editSubscriptionModal');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to update subscription: ' + error.message, 'error');
            }
        }

        async function deleteSubscription(subId) {
            if (!confirm('Are you sure you want to delete this subscription? This will cancel it.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/subscriptions/${subId}`, { method: 'DELETE' });
                showAlert('Subscription deleted successfully');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to delete subscription: ' + error.message, 'error');
            }
        }

        // Plan functions
        async function createPlan() {
            const name = document.getElementById('planName').value;
            const price = parseFloat(document.getElementById('planPrice').value);
            const interval = document.getElementById('planInterval').value;
            const maxRequests = parseInt(document.getElementById('planMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('planMaxTokens').value);
            
            if (!name || !price || !maxRequests || !maxTokens) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/plans', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        price,
                        interval,
                        currency: 'USD',
                        max_requests_per_interval: maxRequests,
                        max_tokens_per_request: maxTokens,
                        has_api_access: document.getElementById('planApiAccess').checked,
                        has_priority_support: document.getElementById('planPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('planAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan created successfully');
                document.getElementById('planName').value = '';
                document.getElementById('planPrice').value = '';
                document.getElementById('planMaxRequests').value = '';
                document.getElementById('planMaxTokens').value = '';
                document.getElementById('planApiAccess').checked = false;
                document.getElementById('planPrioritySupport').checked = false;
                document.getElementById('planAdvancedAnalytics').checked = false;
                
                closeModal('createPlanModal');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to create plan: ' + error.message, 'error');
            }
        }

        async function editPlan(planId) {
            try {
                const plans = await apiCall('/admin/plans');
                const plan = plans.find(p => p.id === planId);
                
                if (!plan) {
                    showAlert('Plan not found', 'error');
                    return;
                }
                
                editingPlanId = planId;
                document.getElementById('editPlanName').value = plan.name;
                document.getElementById('editPlanPrice').value = plan.price;
                document.getElementById('editPlanInterval').value = plan.interval;
                document.getElementById('editPlanMaxRequests').value = plan.max_requests_per_interval;
                document.getElementById('editPlanMaxTokens').value = plan.max_tokens_per_request;
                document.getElementById('editPlanApiAccess').checked = plan.has_api_access;
                document.getElementById('editPlanPrioritySupport').checked = plan.has_priority_support;
                document.getElementById('editPlanAdvancedAnalytics').checked = plan.has_advanced_analytics;
                openModal('editPlanModal');
            } catch (error) {
                showAlert('Failed to load plan: ' + error.message, 'error');
            }
        }

        async function savePlanChanges() {
            try {
                await apiCall(`/admin/plans/${editingPlanId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editPlanName').value,
                        price: parseFloat(document.getElementById('editPlanPrice').value),
                        interval: document.getElementById('editPlanInterval').value,
                        currency: 'USD',
                        max_requests_per_interval: parseInt(document.getElementById('editPlanMaxRequests').value),
                        max_tokens_per_request: parseInt(document.getElementById('editPlanMaxTokens').value),
                        has_api_access: document.getElementById('editPlanApiAccess').checked,
                        has_priority_support: document.getElementById('editPlanPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('editPlanAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan updated successfully');
                closeModal('editPlanModal');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to update plan: ' + error.message, 'error');
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Are you sure you want to delete this plan?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/plans/${planId}`, { method: 'DELETE' });
                showAlert('Plan deleted successfully');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to delete plan: ' + error.message, 'error');
            }
        }

        // Manage plan-agent relationships
        async function managePlanAgents(planId) {
            try {
                // Load plan details, all agents and plan's current agents
                const [plan, allAgents, planAgentIds] = await Promise.all([
                    apiCall(`/admin/plans/${planId}`),
                    apiCall('/admin/agents'),
                    apiCall(`/admin/plans/${planId}/agents`)
                ]);
                
                let html = `
                    <div>
                        <h3>Manage Agents for "${plan.name}"</h3>
                        <p class="section-subtitle">Select which agents are included in this plan:</p>
                `;
                
                allAgents.forEach(agent => {
                    const isIncluded = planAgentIds.includes(agent.id);
                    html += `
                        <div class="agent-list-item">
                            <div class="agent-list-item-info">
                                <strong>${agent.name}</strong>
                                <div class="agent-description">${agent.description || 'No description'}</div>
                            </div>
                            <button 
                                class="${isIncluded ? 'btn-small btn-delete' : 'btn-small btn-primary'}" 
                                onclick="${isIncluded ? `removePlanAgent(${planId}, ${agent.id})` : `addPlanAgent(${planId}, ${agent.id})`}">
                                ${isIncluded ? 'Remove' : 'Add'}
                            </button>
                        </div>
                    `;
                });
                
                html += `
                        <button class="btn-primary" onclick="closeModal('planAgentsModal')">Done</button>
                    </div>
                `;
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('planAgentsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'planAgentsModal';
                    modal.className = 'modal';
                    modal.innerHTML = '<div class="modal-content" id="planAgentsContent"></div>';
                    document.body.appendChild(modal);
                }
                
                document.getElementById('planAgentsContent').innerHTML = html;
                openModal('planAgentsModal');
            } catch (error) {
                showAlert('Failed to load plan agents: ' + error.message, 'error');
            }
        }

        async function addPlanAgent(planId, agentId) {
            try {
                await apiCall(`/admin/plans/${planId}/agents/${agentId}`, { method: 'POST' });
                showAlert('Agent added to plan');
                await managePlanAgents(planId); // Refresh
            } catch (error) {
                showAlert('Failed to add agent: ' + error.message, 'error');
            }
        }

        async function removePlanAgent(planId, agentId) {
            try {
                await apiCall(`/admin/plans/${planId}/agents/${agentId}`, { method: 'DELETE' });
                showAlert('Agent removed from plan');
                await managePlanAgents(planId); // Refresh
            } catch (error) {
                showAlert('Failed to remove agent: ' + error.message, 'error');
            }
        }

        // Policy functions
        async function createPolicy() {
            const name = document.getElementById('policyName').value;
            const description = document.getElementById('policyDescription').value;
            const maxRequests = parseInt(document.getElementById('policyMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('policyMaxTokens').value);
            
            if (!name) {
                showAlert('Policy name is required', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/policies', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        rule_type: 'rate_limit',
                        target_resource: '*',
                        target_role: 'user',
                        config: { maxRequests, maxTokens }
                    })
                });
                
                showAlert('Policy created successfully');
                document.getElementById('policyName').value = '';
                document.getElementById('policyDescription').value = '';
                
                closeModal('createPolicyModal');
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to create policy: ' + error.message, 'error');
            }
        }

        async function deletePolicy(id) {
            if (!confirm('Are you sure you want to delete this policy?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/policies/${id}`, { method: 'DELETE' });
                showAlert('Policy deleted successfully');
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to delete policy: ' + error.message, 'error');
            }
        }

        // Agent functions
        async function loadAgents() {
            try {
                document.getElementById('agentsTable').innerHTML = '<div class="loading">Loading agents</div>';
                const agents = await apiCall('/admin/agents?active_only=false');
                
                if (!agents || agents.length === 0) {
                    document.getElementById('agentsTable').innerHTML = '<div class="empty-state">No agents found</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                agents.forEach(agent => {
                    const statusBadge = agent.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const createdDate = new Date(agent.created_at).toLocaleDateString();
                    
                    html += `
                        <tr>
                            <td>${agent.id}</td>
                            <td>${agent.name}</td>
                            <td>${agent.slug}</td>
                            <td>${agent.model_name}</td>
                            <td>${statusBadge}</td>
                            <td>${createdDate}</td>
                            <td>
                                <button onclick="editAgent(${agent.id})" class="btn-small">Edit</button>
                                <button onclick="deleteAgent(${agent.id})" class="btn-small btn-danger">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('agentsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('agentsTable').innerHTML = `<div class="error">Failed to load agents: ${error.message}</div>`;
            }
        }

        async function loadAgentModelsForSelect(selectId) {
            try {
                const models = await apiCall('/admin/llm-models');
                const selectElement = document.getElementById(selectId);
                selectElement.innerHTML = '';
                
                if (models && models.length > 0) {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.setAttribute('data-id', model.id);
                        option.textContent = model.display_name || model.name;
                        selectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No models available';
                    selectElement.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                const selectElement = document.getElementById(selectId);
                selectElement.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        async function createAgent() {
            const name = document.getElementById('agentName').value.trim();
            const slug = document.getElementById('agentSlug').value.trim();
            const description = document.getElementById('agentDescription').value.trim();
            const systemPrompt = document.getElementById('agentSystemPrompt').value.trim();
            const modelSelect = document.getElementById('agentModel');
            const modelName = modelSelect.value;
            const llmModelId = parseInt(modelSelect.selectedOptions[0].getAttribute('data-id'));
            const temperature = parseFloat(document.getElementById('agentTemperature').value);
            const maxTokens = parseInt(document.getElementById('agentMaxTokens').value);
            const isActive = document.getElementById('agentActive').checked;
            const isPublic = document.getElementById('agentPublic').checked;
            
            if (!name || !slug) {
                showAlert('Name and slug are required', 'error');
                return;
            }
            
            if (isNaN(temperature) || isNaN(maxTokens) || isNaN(llmModelId)) {
                showAlert('Temperature, max tokens, and model must be valid', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/agents', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        slug,
                        description: description || null,
                        system_prompt: systemPrompt || 'You are a helpful assistant',
                        llm_model_id: llmModelId,
                        model_name: modelName,
                        temperature,
                        max_tokens: maxTokens,
                        is_active: isActive,
                        is_public: isPublic
                    })
                });
                
                showAlert('Agent created successfully');
                document.getElementById('agentName').value = '';
                document.getElementById('agentSlug').value = '';
                document.getElementById('agentDescription').value = '';
                document.getElementById('agentSystemPrompt').value = '';
                document.getElementById('agentModel').value = 'gpt-4';
                document.getElementById('agentTemperature').value = '0.7';
                document.getElementById('agentMaxTokens').value = '2000';
                document.getElementById('agentActive').checked = true;
                document.getElementById('agentPublic').checked = false;
                
                closeModal('createAgentModal');
                await loadAgents();
            } catch (error) {
                showAlert('Failed to create agent: ' + error.message, 'error');
            }
        }

        let editingAgentId = null;

        async function editAgent(agentId) {
            try {
                // Load models into select before opening modal
                await loadAgentModelsForSelect('editAgentModel');
                
                const agent = await apiCall(`/admin/agents/${agentId}`);
                
                editingAgentId = agentId;
                document.getElementById('editAgentName').value = agent.name;
                document.getElementById('editAgentDescription').value = agent.description || '';
                document.getElementById('editAgentSystemPrompt').value = agent.system_prompt || '';
                // Set model by llm_model_id
                const modelSelect = document.getElementById('editAgentModel');
                Array.from(modelSelect.options).forEach(option => {
                    if (parseInt(option.getAttribute('data-id')) === agent.llm_model_id) {
                        option.selected = true;
                    }
                });
                document.getElementById('editAgentTemperature').value = agent.temperature;
                document.getElementById('editAgentMaxTokens').value = agent.max_tokens;
                document.getElementById('editAgentActive').checked = agent.is_active;
                document.getElementById('editAgentPublic').checked = agent.is_public;
                
                openModal('editAgentModal');
            } catch (error) {
                showAlert('Failed to load agent: ' + error.message, 'error');
            }
        }

        async function saveAgentChanges() {
            if (!editingAgentId) return;
            
            try {
                const modelSelect = document.getElementById('editAgentModel');
                const modelName = modelSelect.value;
                const llmModelId = parseInt(modelSelect.selectedOptions[0].getAttribute('data-id'));
                
                await apiCall(`/admin/agents/${editingAgentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editAgentName').value,
                        description: document.getElementById('editAgentDescription').value || null,
                        system_prompt: document.getElementById('editAgentSystemPrompt').value || null,
                        llm_model_id: llmModelId,
                        model_name: modelName,
                        temperature: parseFloat(document.getElementById('editAgentTemperature').value),
                        max_tokens: parseInt(document.getElementById('editAgentMaxTokens').value),
                        is_active: document.getElementById('editAgentActive').checked,
                        is_public: document.getElementById('editAgentPublic').checked
                    })
                });
                
                showAlert('Agent updated successfully');
                closeModal('editAgentModal');
                editingAgentId = null;
                await loadAgents();
            } catch (error) {
                showAlert('Failed to update agent: ' + error.message, 'error');
            }
        }

        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}`, { method: 'DELETE' });
                showAlert('Agent deleted successfully');
                await loadAgents();
            } catch (error) {
                showAlert('Failed to delete agent: ' + error.message, 'error');
            }
        }

        // Prompt functions
        async function loadAgentsDropdown() {
            try {
                const agents = await apiCall('/agents');
                const select = document.getElementById('agentSelect');
                
                if (!agents || agents.length === 0) {
                    select.innerHTML = '<option value="">No agents available</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">-- Choose an agent --</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Failed to load agents: ' + error.message, 'error');
            }
        }

        async function loadAgentPrompts() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                document.getElementById('promptsList').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('promptsList').style.display = 'block';
                document.getElementById('promptsTable').innerHTML = '<div class="loading">Loading prompts</div>';
                
                const prompts = await apiCall(`/admin/agents/${agentId}/prompts`);
                
                if (!prompts || prompts.length === 0) {
                    document.getElementById('promptsTable').innerHTML = '<div class="empty-state">No prompt versions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>System Prompt</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                prompts.forEach(prompt => {
                    const statusBadge = prompt.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const systemPreview = prompt.system_prompt.substring(0, 50) + (prompt.system_prompt.length > 50 ? '...' : '');
                    
                    tableHtml += `
                        <tr>
                            <td>${prompt.name}</td>
                            <td>${prompt.version}</td>
                            <td>${systemPreview}</td>
                            <td>${statusBadge}</td>
                            <td>${new Date(prompt.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    ${!prompt.is_active ? `<button class="btn-small btn-view" onclick="activatePrompt(${prompt.id})">Activate</button>` : ''}
                                    <button class="btn-small btn-delete" onclick="deletePrompt(${prompt.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('promptsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load prompts: ' + error.message, 'error');
            }
        }

        async function createPrompt() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                showAlert('Please select an agent first', 'error');
                return;
            }
            
            const name = document.getElementById('promptName').value;
            const version = document.getElementById('promptVersion').value || '1.0.0';
            const systemPrompt = document.getElementById('promptSystem').value;
            const userTemplate = document.getElementById('promptTemplate').value;
            const isActive = document.getElementById('promptActive').checked;
            
            if (!name || !systemPrompt || !userTemplate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}/prompts`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        version,
                        system_prompt: systemPrompt,
                        user_template: userTemplate,
                        variables: [],
                        is_active: isActive
                    })
                });
                
                showAlert('Prompt version created successfully');
                document.getElementById('promptName').value = '';
                document.getElementById('promptVersion').value = '1.0.0';
                document.getElementById('promptSystem').value = '';
                document.getElementById('promptTemplate').value = '';
                document.getElementById('promptActive').checked = false;
                
                closeModal('createPromptModal');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to create prompt: ' + error.message, 'error');
            }
        }

        async function activatePrompt(promptId) {
            if (!confirm('Are you sure you want to activate this prompt version? The current active version will be deactivated.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}/activate`, {
                    method: 'POST'
                });
                
                showAlert('Prompt version activated successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to activate prompt: ' + error.message, 'error');
            }
        }

        async function deletePrompt(promptId) {
            if (!confirm('Are you sure you want to delete this prompt version?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}`, { method: 'DELETE' });
                showAlert('Prompt version deleted successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to delete prompt: ' + error.message, 'error');
            }
        }
        function viewOrg(id) {
            window.open(`/admin/organizations/${id}`, '_blank');
        }

        async function createOrg() {
            const name = document.getElementById('orgName').value.trim();
            const slug = document.getElementById('orgSlug').value.trim();
            const description = document.getElementById('orgDescription').value.trim();
            const maxUsers = parseInt(document.getElementById('orgMaxUsers').value);
            const isActive = document.getElementById('orgActive').checked;

            if (!name || !slug) {
                showAlert('Name and slug are required', 'error');
                return;
            }

            try {
                await apiCall('/admin/organizations', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        slug,
                        description: description || null,
                        max_users: maxUsers,
                        is_active: isActive
                    })
                });

                showAlert('Organization created successfully', 'success');
                closeModal('createOrgModal');
                
                // Reset form
                document.getElementById('orgName').value = '';
                document.getElementById('orgSlug').value = '';
                document.getElementById('orgDescription').value = '';
                document.getElementById('orgMaxUsers').value = '10';
                document.getElementById('orgActive').checked = true;
                
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to create organization: ${error.message}`, 'error');
            }
        }

        let editingOrgId = null;

        async function editOrg(id) {
            try {
                const org = await apiCall(`/admin/organizations/${id}`);
                
                editingOrgId = id;
                document.getElementById('editOrgName').value = org.name;
                document.getElementById('editOrgSlug').value = org.slug;
                document.getElementById('editOrgDescription').value = org.description || '';
                document.getElementById('editOrgMaxUsers').value = org.max_users || 10;
                document.getElementById('editOrgActive').checked = org.is_active !== false;
                
                openModal('editOrgModal');
            } catch (error) {
                showAlert(`Failed to load organization: ${error.message}`, 'error');
            }
        }

        async function saveOrgChanges() {
            if (!editingOrgId) return;

            const name = document.getElementById('editOrgName').value.trim();
            const description = document.getElementById('editOrgDescription').value.trim();
            const maxUsers = parseInt(document.getElementById('editOrgMaxUsers').value);
            const isActive = document.getElementById('editOrgActive').checked;

            if (!name) {
                showAlert('Name is required', 'error');
                return;
            }

            try {
                await apiCall(`/admin/organizations/${editingOrgId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        max_users: maxUsers,
                        is_active: isActive
                    })
                });

                showAlert('Organization updated successfully', 'success');
                closeModal('editOrgModal');
                editingOrgId = null;
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to update organization: ${error.message}`, 'error');
            }
        }

        async function deleteOrg(id) {
            if (!confirm('Are you sure you want to delete this organization? This will fail if any users belong to it.')) {
                return;
            }

            try {
                await apiCall(`/admin/organizations/${id}`, { method: 'DELETE' });
                showAlert('Organization deleted successfully', 'success');
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to delete organization: ${error.message}`, 'error');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
        }

        async function loadCurrentUser() {
            try {
                const user = await apiCall('/auth/me');
                if (user) {
                    document.getElementById('adminName').textContent = user.email;
                    if (!user.is_superuser) {
                        showAlert('Warning: You do not have admin privileges', 'warning');
                    }
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // LLM Models functions
        let editingLLMModelId = null;

        async function loadLLMModels() {
            try {
                document.getElementById('llmModelsTable').innerHTML = '<div class="loading">Loading LLM models</div>';
                const models = await apiCall('/admin/llm-models');
                
                if (!models || models.length === 0) {
                    document.getElementById('llmModelsTable').innerHTML = '<div class="empty-state">No LLM models found</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Provider</th>
                                <th>API Key</th>
                                <th>Max Tokens</th>
                                <th>Context</th>
                                <th>Status</th>
                                <th>Default</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                models.forEach(model => {
                    const statusBadge = model.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const defaultBadge = model.is_default ? 
                        '<span class="badge badge-active">Default</span>' : '';
                    
                    html += `
                        <tr>
                            <td>${model.id}</td>
                            <td>${model.display_name || model.name}</td>
                            <td>${model.provider}</td>
                            <td><code>${model.api_key}</code></td>
                            <td>${model.max_tokens_limit.toLocaleString()}</td>
                            <td>${model.context_window.toLocaleString()}</td>
                            <td>${statusBadge}</td>
                            <td>${defaultBadge}</td>
                            <td>
                                <button onclick="editLLMModel(${model.id})" class="btn-small btn-edit">Edit</button>
                                <button onclick="deleteLLMModel(${model.id})" class="btn-small btn-delete">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('llmModelsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('llmModelsTable').innerHTML = `<div class="error">Failed to load LLM models: ${error.message}</div>`;
            }
        }

        function showCreateLLMModelModal() {
            document.getElementById('createLLMModelModal').classList.add('active');
        }

        async function createLLMModel() {
            const name = document.getElementById('llmModelName').value.trim();
            const displayName = document.getElementById('llmModelDisplayName').value.trim();
            const provider = document.getElementById('llmModelProvider').value;
            const apiKey = document.getElementById('llmModelApiKey').value.trim();
            const apiBaseUrl = document.getElementById('llmModelApiBaseUrl').value.trim() || null;
            const maxTokensLimit = parseInt(document.getElementById('llmModelMaxTokensLimit').value);
            const contextWindow = parseInt(document.getElementById('llmModelContextWindow').value);
            const isActive = document.getElementById('llmModelActive').checked;
            const isDefault = document.getElementById('llmModelIsDefault').checked;

            if (!name || !displayName || !apiKey) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                await apiCall('/admin/llm-models', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        display_name: displayName,
                        provider,
                        api_key: apiKey,
                        api_base_url: apiBaseUrl,
                        max_tokens_limit: maxTokensLimit,
                        context_window: contextWindow,
                        is_active: isActive,
                        is_default: isDefault
                    })
                });

                showAlert('LLM model created successfully', 'success');
                closeModal('createLLMModelModal');
                
                // Reset form
                document.getElementById('llmModelName').value = '';
                document.getElementById('llmModelDisplayName').value = '';
                document.getElementById('llmModelApiKey').value = '';
                document.getElementById('llmModelApiBaseUrl').value = '';
                document.getElementById('llmModelMaxTokensLimit').value = '4000';
                document.getElementById('llmModelContextWindow').value = '8000';
                document.getElementById('llmModelActive').checked = true;
                document.getElementById('llmModelIsDefault').checked = false;
                
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to create LLM model: ${error.message}`, 'error');
            }
        }

        async function editLLMModel(id) {
            try {
                const model = await apiCall(`/admin/llm-models/${id}`);
                
                editingLLMModelId = id;
                document.getElementById('editLLMModelName').value = model.name;
                document.getElementById('editLLMModelDisplayName').value = model.display_name || model.name;
                document.getElementById('editLLMModelProvider').value = model.provider;
                document.getElementById('editLLMModelApiKey').value = '';  // Don't show existing key
                document.getElementById('editLLMModelApiBaseUrl').value = model.api_base_url || '';
                document.getElementById('editLLMModelMaxTokensLimit').value = model.max_tokens_limit;
                document.getElementById('editLLMModelContextWindow').value = model.context_window;
                document.getElementById('editLLMModelActive').checked = model.is_active;
                document.getElementById('editLLMModelIsDefault').checked = model.is_default;
                
                document.getElementById('editLLMModelModal').classList.add('active');
            } catch (error) {
                showAlert(`Failed to load LLM model: ${error.message}`, 'error');
            }
        }

        async function saveLLMModelChanges() {
            if (!editingLLMModelId) return;

            const displayName = document.getElementById('editLLMModelDisplayName').value.trim();
            const apiKey = document.getElementById('editLLMModelApiKey').value.trim();
            const apiBaseUrl = document.getElementById('editLLMModelApiBaseUrl').value.trim() || null;
            const maxTokensLimit = parseInt(document.getElementById('editLLMModelMaxTokensLimit').value);
            const contextWindow = parseInt(document.getElementById('editLLMModelContextWindow').value);
            const isActive = document.getElementById('editLLMModelActive').checked;
            const isDefault = document.getElementById('editLLMModelIsDefault').checked;

            try {
                const updateData = {
                    display_name: displayName,
                    api_base_url: apiBaseUrl,
                    max_tokens_limit: maxTokensLimit,
                    context_window: contextWindow,
                    is_active: isActive,
                    is_default: isDefault
                };

                // Only include api_key if it was changed
                if (apiKey) {
                    updateData.api_key = apiKey;
                }

                await apiCall(`/admin/llm-models/${editingLLMModelId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                showAlert('LLM model updated successfully', 'success');
                closeModal('editLLMModelModal');
                editingLLMModelId = null;
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to update LLM model: ${error.message}`, 'error');
            }
        }

        async function deleteLLMModel(id) {
            if (!confirm('Are you sure you want to delete this LLM model? This will fail if any agents are using it.')) {
                return;
            }

            try {
                await apiCall(`/admin/llm-models/${id}`, { method: 'DELETE' });
                showAlert('LLM model deleted successfully', 'success');
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to delete LLM model: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadDashboard();
            await loadAgents();
            await loadAgentsDropdown();
        });

        // Usage Logs Functions
        let allLogs = [];

        async function loadLogs() {
            try {
                const days = document.getElementById('logsDays').value || 7;
                const limit = document.getElementById('logsLimit').value || 100;
                
                const response = await apiCall(`/billing/usage-records?days=${days}&limit=${limit}`, { method: 'GET' });
                
                if (!response || !Array.isArray(response)) {
                    document.getElementById('logsTable').innerHTML = '<p class="error">No logs found</p>';
                    return;
                }

                // Sort by created_at descending (newest first)
                allLogs = response.sort((a, b) => {
                    const dateA = new Date(a.created_at);
                    const dateB = new Date(b.created_at);
                    return dateB - dateA;
                });

                displayLogs(allLogs);
            } catch (error) {
                document.getElementById('logsTable').innerHTML = `<p class="error">Error loading logs: ${error.message}</p>`;
            }
        }

        function displayLogs(logs) {
            if (!logs || logs.length === 0) {
                document.getElementById('logsTable').innerHTML = '<p class="no-data">No logs found</p>';
                return;
            }

            let html = `
                <table class="data-grid">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Endpoint</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Response Time (ms)</th>
                            <th>Tokens</th>
                            <th>Cost</th>
                            <th>User</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            logs.forEach(log => {
                const date = new Date(log.created_at);
                const timeStr = date.toLocaleString();
                const statusClass = log.status_code >= 400 ? 'error' : log.status_code >= 300 ? 'warning' : 'success';
                const tokens = log.total_tokens || 0;
                const cost = log.cost ? parseFloat(log.cost).toFixed(4) : '0.0000';
                const errorMsg = log.error_message ? `<span title="${log.error_message}">Error</span>` : '-';

                html += `
                    <tr>
                        <td><small>${timeStr}</small></td>
                        <td><code>${log.endpoint || '-'}</code></td>
                        <td>${log.method || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${log.status_code}</span></td>
                        <td>${log.response_time_ms}ms</td>
                        <td>${tokens}</td>
                        <td>$${cost}</td>
                        <td><small>${log.user_id || '-'}</small></td>
                        <td>${errorMsg}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('logsTable').innerHTML = html;
        }

        function filterLogs() {
            const searchText = document.getElementById('logsSearch').value.toLowerCase();
            
            if (!searchText) {
                displayLogs(allLogs);
                return;
            }

            const filtered = allLogs.filter(log => {
                const endpoint = (log.endpoint || '').toLowerCase();
                const userId = String(log.user_id || '').toLowerCase();
                const errorMsg = (log.error_message || '').toLowerCase();
                
                return endpoint.includes(searchText) || 
                       userId.includes(searchText) || 
                       errorMsg.includes(searchText);
            });

            displayLogs(filtered);
        }
    </script>
</body>
</html>