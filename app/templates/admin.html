<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - {{ t('site_name') }}</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2.0">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .admin-header h1 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .admin-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .admin-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .admin-tab:hover {
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.875rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-card .trend {
            font-size: 0.875rem;
            color: #10b981;
            margin-top: 0.5rem;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .data-table h2 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            color: #666;
            font-weight: 600;
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-admin {
            background: #cce5ff;
            color: #004085;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn-small:hover {
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-delete {
            background: #ffebee;
            color: #c62828;
        }
        
        .btn-view {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .btn-danger {
            background: #ffcdd2;
            color: #b71c1c;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.125rem;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: var(--text-color);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Search and Pagination */
        .table-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .pagination {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:hover {
            background: #f5f5f5;
        }

        .pagination button.active:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">{{ t('site_name') }} Admin</a>
            <div class="nav-right">
                <a href="/dashboard" class="btn btn-secondary">User Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </nav>
    </header>

    <div class="admin-container">
        <div id="alertContainer"></div>
        
        <div class="admin-header">
            <h1>Admin Panel</h1>
            <div style="color: #666; font-size: 0.875rem;">
                Logged in as <strong id="adminName">Admin</strong>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="admin-tab" onclick="switchTab('agents')">Agents</button>
            <button class="admin-tab" onclick="switchTab('prompts')">Prompts</button>
            <button class="admin-tab" onclick="switchTab('users')">Users</button>
            <button class="admin-tab" onclick="switchTab('subscriptions')">Subscriptions</button>
            <button class="admin-tab" onclick="switchTab('plans')">Plans</button>
            <button class="admin-tab" onclick="switchTab('policies')">Policies</button>
            <button class="admin-tab" onclick="switchTab('organizations')">Organizations</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Loading statistics</div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents" class="tab-content">
            <div class="data-table">
                <h2>Agent Management</h2>
                <div class="form-section" style="margin-bottom: 2rem;">
                    <h3>Create New Agent</h3>
                    <div class="form-group">
                        <label>Agent Name</label>
                        <input type="text" id="agentName" placeholder="e.g., Customer Support Bot">
                    </div>
                    <div class="form-group">
                        <label>Slug (URL-friendly identifier)</label>
                        <input type="text" id="agentSlug" placeholder="e.g., support-bot">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="agentDescription" placeholder="What does this agent do?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <select id="agentModel">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Temperature (0-2, higher = more creative)</label>
                        <input type="number" id="agentTemperature" min="0" max="2" step="0.1" value="0.7">
                    </div>
                    <div class="form-group">
                        <label>Max Tokens</label>
                        <input type="number" id="agentMaxTokens" min="1" value="2000">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="agentActive" checked> Active
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="agentPublic"> Public (visible to users)
                        </label>
                    </div>
                    <button onclick="createAgent()" class="btn-primary">Create Agent</button>
                </div>

                <h3>Agents List</h3>
                <div id="agentsTable" class="loading">Loading agents...</div>
            </div>
        </div>

        <!-- Prompts Tab -->
        <div id="prompts" class="tab-content">
            <div class="data-table">
                <h2>Prompt Versions Management</h2>
                <div class="form-group">
                    <label>Select Agent</label>
                    <select id="agentSelect" onchange="loadAgentPrompts()">
                        <option value="">-- Choose an agent --</option>
                    </select>
                </div>
                <div id="promptsList" style="display:none;">
                    <div class="form-section" style="margin-bottom: 2rem;">
                        <h3>Create New Prompt Version</h3>
                        <div class="form-group">
                            <label>Prompt Name</label>
                            <input type="text" id="promptName" placeholder="e.g., Welcome Message">
                        </div>
                        <div class="form-group">
                            <label>Version</label>
                            <input type="text" id="promptVersion" placeholder="1.0.0" value="1.0.0">
                        </div>
                        <div class="form-group">
                            <label>System Prompt</label>
                            <textarea id="promptSystem" placeholder="You are a helpful assistant..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>User Template</label>
                            <textarea id="promptTemplate" placeholder="Hello {name}, how can I help?"></textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="promptActive"> Set as Active
                            </label>
                        </div>
                        <button onclick="createPrompt()" class="btn-primary">Create Prompt Version</button>
                    </div>
                    <div id="promptsTable" class="loading">Loading prompts</div>
                </div>
            </div>
        </div>
        <div id="users" class="tab-content">
            <div class="data-table">
                <h2>User Management</h2>
                <div id="usersTable" class="loading">Loading users</div>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions" class="tab-content">
            <div class="data-table">
                <h2>Subscription Management</h2>
                <div id="subscriptionsTable" class="loading">Loading subscriptions</div>
            </div>
        </div>

        <!-- Plans Tab -->
        <div id="plans" class="tab-content">
            <div class="form-section">
                <h2>Create New Plan</h2>
                <div class="form-group">
                    <label>Plan Name</label>
                    <input type="text" id="planName" placeholder="e.g., Professional Plan">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" id="planPrice" placeholder="9.99" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Interval</label>
                        <select id="planInterval">
                            <option value="MONTHLY">Monthly</option>
                            <option value="YEARLY">Yearly</option>
                            <option value="WEEKLY">Weekly</option>
                            <option value="DAILY">Daily</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Max Requests Per Interval</label>
                        <input type="number" id="planMaxRequests" placeholder="10000" min="1">
                    </div>
                    <div class="form-group">
                        <label>Max Tokens Per Request</label>
                        <input type="number" id="planMaxTokens" placeholder="4000" min="1">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                            <input type="checkbox" id="planApiAccess"> API Access
                        </label>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                            <input type="checkbox" id="planPrioritySupport"> Priority Support
                        </label>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                            <input type="checkbox" id="planAdvancedAnalytics"> Advanced Analytics
                        </label>
                    </div>
                </div>
                <button onclick="createPlan()" class="btn-primary">Create Plan</button>
            </div>
            
            <div class="data-table">
                <h2>Existing Plans</h2>
                <div id="plansTable" class="loading">Loading plans</div>
            </div>
        </div>
        <div id="policies" class="tab-content">
            <div class="form-section">
                <h2>Create New Policy</h2>
                <div class="form-group">
                    <label>Policy Name</label>
                    <input type="text" id="policyName" placeholder="e.g., Free Plan Policy">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="policyDescription" placeholder="Policy description"></textarea>
                </div>
                <div class="form-group">
                    <label>Max Requests Per Minute</label>
                    <input type="number" id="policyMaxRequests" value="60">
                </div>
                <div class="form-group">
                    <label>Max Tokens Per Request</label>
                    <input type="number" id="policyMaxTokens" value="4000">
                </div>
                <button onclick="createPolicy()" class="btn-primary">Create Policy</button>
            </div>
            
            <div class="data-table">
                <h2>Existing Policies</h2>
                <div id="policiesTable" class="loading">Loading policies</div>
            </div>
        </div>

        <!-- Organizations Tab -->
        <div id="organizations" class="tab-content">
            <div class="data-table">
                <h2>Organizations</h2>
                <div id="organizationsTable" class="loading">Loading organizations</div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-bottom">
                <p>&copy; 2024 {{ t('site_name') }}. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editUserEmail" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="editUserActive"> Active
                </label>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="editUserAdmin"> Admin
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn-primary" onclick="saveUserChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editSubscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Subscription</h2>
                <button class="modal-close" onclick="closeModal('editSubscriptionModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization</label>
                <input type="text" id="editSubsOrg" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editSubsStatus">
                    <option value="active">Active</option>
                    <option value="canceled">Canceled</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editSubscriptionModal')">Cancel</button>
                <button class="btn-primary" onclick="saveSubscriptionChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Plan</h2>
                <button class="modal-close" onclick="closeModal('editPlanModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="editPlanName">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="editPlanPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="editPlanInterval">
                        <option value="MONTHLY">Monthly</option>
                        <option value="YEARLY">Yearly</option>
                        <option value="WEEKLY">Weekly</option>
                        <option value="DAILY">Daily</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Max Requests</label>
                    <input type="number" id="editPlanMaxRequests" min="1">
                </div>
                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="editPlanMaxTokens" min="1">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                        <input type="checkbox" id="editPlanApiAccess"> API Access
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                        <input type="checkbox" id="editPlanPrioritySupport"> Priority
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                        <input type="checkbox" id="editPlanAdvancedAnalytics"> Advanced
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editPlanModal')">Cancel</button>
                <button class="btn-primary" onclick="savePlanChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Agent</h2>
                <button class="modal-close" onclick="closeModal('editAgentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="editAgentName">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editAgentDescription" placeholder="What does this agent do?"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Model</label>
                    <select id="editAgentModel">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Temperature</label>
                    <input type="number" id="editAgentTemperature" min="0" max="2" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" id="editAgentMaxTokens" min="1">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                        <input type="checkbox" id="editAgentActive"> Active
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0; font-weight: normal;">
                        <input type="checkbox" id="editAgentPublic"> Public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editAgentModal')">Cancel</button>
                <button class="btn-primary" onclick="saveAgentChanges()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentTab = 'dashboard';
        let editingUserId = null;
        let editingSubscriptionId = null;
        let editingPlanId = null;

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            try {
                const response = await fetch(API_BASE + endpoint, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 403) {
                    showAlert('Access denied. Admin privileges required.', 'error');
                    return null;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab data
            loadTabData(tabName);
        }

        // Load tab data
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'agents':
                    await loadAgents();
                    break;
                case 'prompts':
                    await loadAgentsDropdown();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'subscriptions':
                    await loadSubscriptions();
                    break;
                case 'plans':
                    await loadPlans();
                    break;
                case 'policies':
                    await loadPolicies();
                    break;
                case 'organizations':
                    await loadOrganizations();
                    break;
            }
        }

        // Load dashboard statistics
        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/dashboard/stats');
                
                if (!stats) return;
                
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">${stats.total_users || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Subscriptions</h3>
                        <div class="value">${stats.active_subscriptions || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Organizations</h3>
                        <div class="value">${stats.total_organizations || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Month)</h3>
                        <div class="value">$${parseFloat(stats.revenue_month || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Today)</h3>
                        <div class="value">$${parseFloat(stats.revenue_today || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>API Requests (Month)</h3>
                        <div class="value">${stats.api_requests_month || 0}</div>
                    </div>
                `;
                
                document.getElementById('statsGrid').innerHTML = statsHtml;
            } catch (error) {
                showAlert('Failed to load statistics: ' + error.message, 'error');
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const users = await apiCall('/admin/users');
                
                if (!users || users.length === 0) {
                    document.getElementById('usersTable').innerHTML = '<div class="empty-state">No users found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    const statusBadge = user.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const roleBadge = user.is_superuser ? 
                        '<span class="badge badge-admin">Admin</span>' : 
                        '<span class="badge">User</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.email}</td>
                            <td>${user.username || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${roleBadge}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editUser(${user.id}, '${user.email}', ${user.is_active}, ${user.is_superuser})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load users: ' + error.message, 'error');
            }
        }

        // Load subscriptions
        async function loadSubscriptions() {
            try {
                const subs = await apiCall('/admin/subscriptions');
                
                if (!subs || subs.length === 0) {
                    document.getElementById('subscriptionsTable').innerHTML = '<div class="empty-state">No subscriptions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Organization</th>
                                <th>Users</th>
                                <th>Plan</th>
                                <th>Status</th>
                                <th>Total Spent</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                subs.forEach(sub => {
                    const statusClass = sub.status === 'active' ? 'badge-active' : 
                                       sub.status === 'canceled' ? 'badge-inactive' : 'badge-pending';
                    
                    tableHtml += `
                        <tr>
                            <td>${sub.id}</td>
                            <td>${sub.organization_name} (#${sub.organization_id})</td>
                            <td>${sub.user_count || 0}</td>
                            <td>${sub.plan_name || 'Free'}</td>
                            <td><span class="badge ${statusClass}">${sub.status}</span></td>
                            <td>$${parseFloat(sub.total_spent || 0).toFixed(2)}</td>
                            <td>${new Date(sub.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editSubscription(${sub.id}, '${sub.organization_name}', '${sub.status}')">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteSubscription(${sub.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('subscriptionsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load subscriptions: ' + error.message, 'error');
            }
        }

        // Load plans
        async function loadPlans() {
            try {
                const plans = await apiCall('/admin/plans');
                
                if (!plans || plans.length === 0) {
                    document.getElementById('plansTable').innerHTML = '<div class="empty-state">No plans found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Interval</th>
                                <th>Max Requests</th>
                                <th>Max Tokens</th>
                                <th>Features</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                plans.forEach(plan => {
                    const features = [];
                    if (plan.has_api_access) features.push('API');
                    if (plan.has_priority_support) features.push('Support');
                    if (plan.has_advanced_analytics) features.push('Analytics');
                    
                    tableHtml += `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>$${parseFloat(plan.price).toFixed(2)}</td>
                            <td>${plan.interval}</td>
                            <td>${plan.max_requests_per_interval}</td>
                            <td>${plan.max_tokens_per_request}</td>
                            <td>${features.length ? features.join(', ') : 'None'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editPlan(${plan.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deletePlan(${plan.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('plansTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load plans: ' + error.message, 'error');
            }
        }

        // Load policies
        async function loadPolicies() {
            try {
                const policies = await apiCall('/admin/policies');
                
                if (!policies || policies.length === 0) {
                    document.getElementById('policiesTable').innerHTML = '<div class="empty-state">No policies found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Target</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                policies.forEach(policy => {
                    const statusBadge = policy.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${policy.id}</td>
                            <td>${policy.name}</td>
                            <td>${policy.rule_type}</td>
                            <td>${policy.target_resource}</td>
                            <td>${policy.priority}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-delete" onclick="deletePolicy(${policy.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('policiesTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load policies: ' + error.message, 'error');
            }
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                const orgs = await apiCall('/admin/organizations');
                
                if (!orgs || orgs.length === 0) {
                    document.getElementById('organizationsTable').innerHTML = '<div class="empty-state">No organizations found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Members</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orgs.forEach(org => {
                    tableHtml += `
                        <tr>
                            <td>${org.id}</td>
                            <td>${org.name}</td>
                            <td>${org.slug}</td>
                            <td>${org.member_count || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-view" onclick="viewOrg(${org.id})">View</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('organizationsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load organizations: ' + error.message, 'error');
            }
        }

        // User functions
        function editUser(userId, email, isActive, isAdmin) {
            editingUserId = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserActive').checked = isActive;
            document.getElementById('editUserAdmin').checked = isAdmin;
            openModal('editUserModal');
        }

        async function saveUserChanges() {
            try {
                await apiCall(`/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_active: document.getElementById('editUserActive').checked,
                        is_superuser: document.getElementById('editUserAdmin').checked
                    })
                });
                
                showAlert('User updated successfully');
                closeModal('editUserModal');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to update user: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action marks the user as inactive.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/users/${userId}`, { method: 'DELETE' });
                showAlert('User deleted successfully');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to delete user: ' + error.message, 'error');
            }
        }

        // Subscription functions
        function editSubscription(subId, orgName, status) {
            editingSubscriptionId = subId;
            document.getElementById('editSubsOrg').value = orgName;
            document.getElementById('editSubsStatus').value = status;
            openModal('editSubscriptionModal');
        }

        async function saveSubscriptionChanges() {
            try {
                await apiCall(`/admin/subscriptions/${editingSubscriptionId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        subscription_status: document.getElementById('editSubsStatus').value
                    })
                });
                
                showAlert('Subscription updated successfully');
                closeModal('editSubscriptionModal');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to update subscription: ' + error.message, 'error');
            }
        }

        async function deleteSubscription(subId) {
            if (!confirm('Are you sure you want to delete this subscription? This will cancel it.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/subscriptions/${subId}`, { method: 'DELETE' });
                showAlert('Subscription deleted successfully');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to delete subscription: ' + error.message, 'error');
            }
        }

        // Plan functions
        async function createPlan() {
            const name = document.getElementById('planName').value;
            const price = parseFloat(document.getElementById('planPrice').value);
            const interval = document.getElementById('planInterval').value;
            const maxRequests = parseInt(document.getElementById('planMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('planMaxTokens').value);
            
            if (!name || !price || !maxRequests || !maxTokens) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/plans', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        price,
                        interval,
                        currency: 'USD',
                        max_requests_per_interval: maxRequests,
                        max_tokens_per_request: maxTokens,
                        has_api_access: document.getElementById('planApiAccess').checked,
                        has_priority_support: document.getElementById('planPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('planAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan created successfully');
                document.getElementById('planName').value = '';
                document.getElementById('planPrice').value = '';
                document.getElementById('planMaxRequests').value = '';
                document.getElementById('planMaxTokens').value = '';
                document.getElementById('planApiAccess').checked = false;
                document.getElementById('planPrioritySupport').checked = false;
                document.getElementById('planAdvancedAnalytics').checked = false;
                await loadPlans();
            } catch (error) {
                showAlert('Failed to create plan: ' + error.message, 'error');
            }
        }

        async function editPlan(planId) {
            try {
                const plans = await apiCall('/admin/plans');
                const plan = plans.find(p => p.id === planId);
                
                if (!plan) {
                    showAlert('Plan not found', 'error');
                    return;
                }
                
                editingPlanId = planId;
                document.getElementById('editPlanName').value = plan.name;
                document.getElementById('editPlanPrice').value = plan.price;
                document.getElementById('editPlanInterval').value = plan.interval;
                document.getElementById('editPlanMaxRequests').value = plan.max_requests_per_interval;
                document.getElementById('editPlanMaxTokens').value = plan.max_tokens_per_request;
                document.getElementById('editPlanApiAccess').checked = plan.has_api_access;
                document.getElementById('editPlanPrioritySupport').checked = plan.has_priority_support;
                document.getElementById('editPlanAdvancedAnalytics').checked = plan.has_advanced_analytics;
                openModal('editPlanModal');
            } catch (error) {
                showAlert('Failed to load plan: ' + error.message, 'error');
            }
        }

        async function savePlanChanges() {
            try {
                await apiCall(`/admin/plans/${editingPlanId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editPlanName').value,
                        price: parseFloat(document.getElementById('editPlanPrice').value),
                        interval: document.getElementById('editPlanInterval').value,
                        currency: 'USD',
                        max_requests_per_interval: parseInt(document.getElementById('editPlanMaxRequests').value),
                        max_tokens_per_request: parseInt(document.getElementById('editPlanMaxTokens').value),
                        has_api_access: document.getElementById('editPlanApiAccess').checked,
                        has_priority_support: document.getElementById('editPlanPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('editPlanAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan updated successfully');
                closeModal('editPlanModal');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to update plan: ' + error.message, 'error');
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Are you sure you want to delete this plan?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/plans/${planId}`, { method: 'DELETE' });
                showAlert('Plan deleted successfully');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to delete plan: ' + error.message, 'error');
            }
        }

        // Policy functions
        async function createPolicy() {
            const name = document.getElementById('policyName').value;
            const description = document.getElementById('policyDescription').value;
            const maxRequests = parseInt(document.getElementById('policyMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('policyMaxTokens').value);
            
            if (!name) {
                showAlert('Policy name is required', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/policies', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        rule_type: 'rate_limit',
                        target_resource: '*',
                        target_role: 'user',
                        config: { maxRequests, maxTokens }
                    })
                });
                
                showAlert('Policy created successfully');
                document.getElementById('policyName').value = '';
                document.getElementById('policyDescription').value = '';
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to create policy: ' + error.message, 'error');
            }
        }

        async function deletePolicy(id) {
            if (!confirm('Are you sure you want to delete this policy?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/policies/${id}`, { method: 'DELETE' });
                showAlert('Policy deleted successfully');
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to delete policy: ' + error.message, 'error');
            }
        }

        // Agent functions
        async function loadAgents() {
            try {
                document.getElementById('agentsTable').innerHTML = '<div class="loading">Loading agents</div>';
                const agents = await apiCall('/admin/agents?active_only=false');
                
                if (!agents || agents.length === 0) {
                    document.getElementById('agentsTable').innerHTML = '<div class="empty-state">No agents found</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                agents.forEach(agent => {
                    const statusBadge = agent.is_active ? 
                        '<span class="badge badge-success">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const createdDate = new Date(agent.created_at).toLocaleDateString();
                    
                    html += `
                        <tr>
                            <td>${agent.id}</td>
                            <td>${agent.name}</td>
                            <td>${agent.slug}</td>
                            <td>${agent.model_name}</td>
                            <td>${statusBadge}</td>
                            <td>${createdDate}</td>
                            <td>
                                <button onclick="editAgent(${agent.id})" class="btn-small">Edit</button>
                                <button onclick="deleteAgent(${agent.id})" class="btn-small btn-danger">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('agentsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('agentsTable').innerHTML = `<div class="error">Failed to load agents: ${error.message}</div>`;
            }
        }

        async function createAgent() {
            const name = document.getElementById('agentName').value.trim();
            const slug = document.getElementById('agentSlug').value.trim();
            const description = document.getElementById('agentDescription').value.trim();
            const model = document.getElementById('agentModel').value;
            const temperature = parseFloat(document.getElementById('agentTemperature').value);
            const maxTokens = parseInt(document.getElementById('agentMaxTokens').value);
            const isActive = document.getElementById('agentActive').checked;
            const isPublic = document.getElementById('agentPublic').checked;
            
            if (!name || !slug) {
                showAlert('Name and slug are required', 'error');
                return;
            }
            
            if (isNaN(temperature) || isNaN(maxTokens)) {
                showAlert('Temperature and max tokens must be valid numbers', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/agents', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        slug,
                        description: description || null,
                        model_name: model,
                        temperature,
                        max_tokens: maxTokens,
                        is_active: isActive,
                        is_public: isPublic
                    })
                });
                
                showAlert('Agent created successfully');
                document.getElementById('agentName').value = '';
                document.getElementById('agentSlug').value = '';
                document.getElementById('agentDescription').value = '';
                document.getElementById('agentModel').value = 'gpt-4';
                document.getElementById('agentTemperature').value = '0.7';
                document.getElementById('agentMaxTokens').value = '2000';
                document.getElementById('agentActive').checked = true;
                document.getElementById('agentPublic').checked = false;
                
                await loadAgents();
            } catch (error) {
                showAlert('Failed to create agent: ' + error.message, 'error');
            }
        }

        let editingAgentId = null;

        async function editAgent(agentId) {
            try {
                const agent = await apiCall(`/admin/agents/${agentId}`);
                
                editingAgentId = agentId;
                document.getElementById('editAgentName').value = agent.name;
                document.getElementById('editAgentDescription').value = agent.description || '';
                document.getElementById('editAgentModel').value = agent.model_name;
                document.getElementById('editAgentTemperature').value = agent.temperature;
                document.getElementById('editAgentMaxTokens').value = agent.max_tokens;
                document.getElementById('editAgentActive').checked = agent.is_active;
                document.getElementById('editAgentPublic').checked = agent.is_public;
                
                openModal('editAgentModal');
            } catch (error) {
                showAlert('Failed to load agent: ' + error.message, 'error');
            }
        }

        async function saveAgentChanges() {
            if (!editingAgentId) return;
            
            try {
                await apiCall(`/admin/agents/${editingAgentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editAgentName').value,
                        description: document.getElementById('editAgentDescription').value || null,
                        model_name: document.getElementById('editAgentModel').value,
                        temperature: parseFloat(document.getElementById('editAgentTemperature').value),
                        max_tokens: parseInt(document.getElementById('editAgentMaxTokens').value),
                        is_active: document.getElementById('editAgentActive').checked,
                        is_public: document.getElementById('editAgentPublic').checked
                    })
                });
                
                showAlert('Agent updated successfully');
                closeModal('editAgentModal');
                editingAgentId = null;
                await loadAgents();
            } catch (error) {
                showAlert('Failed to update agent: ' + error.message, 'error');
            }
        }

        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}`, { method: 'DELETE' });
                showAlert('Agent deleted successfully');
                await loadAgents();
            } catch (error) {
                showAlert('Failed to delete agent: ' + error.message, 'error');
            }
        }

        // Prompt functions
        async function loadAgentsDropdown() {
            try {
                const agents = await apiCall('/agents');
                const select = document.getElementById('agentSelect');
                
                if (!agents || agents.length === 0) {
                    select.innerHTML = '<option value="">No agents available</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">-- Choose an agent --</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Failed to load agents: ' + error.message, 'error');
            }
        }

        async function loadAgentPrompts() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                document.getElementById('promptsList').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('promptsList').style.display = 'block';
                document.getElementById('promptsTable').innerHTML = '<div class="loading">Loading prompts</div>';
                
                const prompts = await apiCall(`/admin/agents/${agentId}/prompts`);
                
                if (!prompts || prompts.length === 0) {
                    document.getElementById('promptsTable').innerHTML = '<div class="empty-state">No prompt versions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>System Prompt</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                prompts.forEach(prompt => {
                    const statusBadge = prompt.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const systemPreview = prompt.system_prompt.substring(0, 50) + (prompt.system_prompt.length > 50 ? '...' : '');
                    
                    tableHtml += `
                        <tr>
                            <td>${prompt.name}</td>
                            <td>${prompt.version}</td>
                            <td>${systemPreview}</td>
                            <td>${statusBadge}</td>
                            <td>${new Date(prompt.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    ${!prompt.is_active ? `<button class="btn-small btn-view" onclick="activatePrompt(${prompt.id})">Activate</button>` : ''}
                                    <button class="btn-small btn-delete" onclick="deletePrompt(${prompt.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('promptsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load prompts: ' + error.message, 'error');
            }
        }

        async function createPrompt() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                showAlert('Please select an agent first', 'error');
                return;
            }
            
            const name = document.getElementById('promptName').value;
            const version = document.getElementById('promptVersion').value || '1.0.0';
            const systemPrompt = document.getElementById('promptSystem').value;
            const userTemplate = document.getElementById('promptTemplate').value;
            const isActive = document.getElementById('promptActive').checked;
            
            if (!name || !systemPrompt || !userTemplate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}/prompts`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        version,
                        system_prompt: systemPrompt,
                        user_template: userTemplate,
                        variables: [],
                        is_active: isActive
                    })
                });
                
                showAlert('Prompt version created successfully');
                document.getElementById('promptName').value = '';
                document.getElementById('promptVersion').value = '1.0.0';
                document.getElementById('promptSystem').value = '';
                document.getElementById('promptTemplate').value = '';
                document.getElementById('promptActive').checked = false;
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to create prompt: ' + error.message, 'error');
            }
        }

        async function activatePrompt(promptId) {
            if (!confirm('Are you sure you want to activate this prompt version? The current active version will be deactivated.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}/activate`, {
                    method: 'POST'
                });
                
                showAlert('Prompt version activated successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to activate prompt: ' + error.message, 'error');
            }
        }

        async function deletePrompt(promptId) {
            if (!confirm('Are you sure you want to delete this prompt version?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}`, { method: 'DELETE' });
                showAlert('Prompt version deleted successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to delete prompt: ' + error.message, 'error');
            }
        }
        function viewOrg(id) {
            window.open(`/admin/organizations/${id}`, '_blank');
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
        }

        async function loadCurrentUser() {
            try {
                const user = await apiCall('/auth/me');
                if (user) {
                    document.getElementById('adminName').textContent = user.email;
                    if (!user.is_superuser) {
                        showAlert('Warning: You do not have admin privileges', 'warning');
                    }
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadDashboard();
            await loadAgents();
            await loadAgentsDropdown();
        });
    </script>
</body>
</html>