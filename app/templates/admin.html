<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - {{ t('site_name') }}</title>
    <link rel="stylesheet" href="/static/css/style.css?v=2.0">
    <link rel="stylesheet" href="/static/css/admin.css?v=1.0">
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">{{ t('site_name') }} Admin</a>
            <div class="nav-right">
                <a href="/dashboard" class="btn btn-secondary">User Dashboard</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </nav>
    </header>

    <div class="admin-container">
        <div id="alertContainer"></div>
        
        <div class="admin-header">
            <h1>Admin Panel</h1>
            <div class="section-subtitle">
                Logged in as <strong id="adminName">Admin</strong>
            </div>
        </div>

        <div class="admin-tabs" role="tablist" aria-label="Admin sections">
            <button class="admin-tab active" onclick="switchTab('dashboard')" role="tab" aria-selected="true" aria-controls="dashboard">Dashboard</button>
            <button class="admin-tab" onclick="switchTab('agents')" role="tab" aria-selected="false" aria-controls="agents">Agents</button>
            <button class="admin-tab" onclick="switchTab('prompts')" role="tab" aria-selected="false" aria-controls="prompts">Prompts</button>
            <button class="admin-tab" onclick="switchTab('users')" role="tab" aria-selected="false" aria-controls="users">Users</button>
            <button class="admin-tab" onclick="switchTab('subscriptions')" role="tab" aria-selected="false" aria-controls="subscriptions">Subscriptions</button>
            <button class="admin-tab" onclick="switchTab('plans')" role="tab" aria-selected="false" aria-controls="plans">Plans</button>
            <button class="admin-tab" onclick="switchTab('paddle')" role="tab" aria-selected="false" aria-controls="paddle">Paddle</button>
            <button class="admin-tab" onclick="switchTab('policies')" role="tab" aria-selected="false" aria-controls="policies">Policies</button>
            <button class="admin-tab" onclick="switchTab('organizations')" role="tab" aria-selected="false" aria-controls="organizations">Organizations</button>
            <button class="admin-tab" onclick="switchTab('llm-models')" role="tab" aria-selected="false" aria-controls="llm-models">LLM Models</button>
            <button class="admin-tab" onclick="switchTab('logs')" role="tab" aria-selected="false" aria-controls="logs">Usage Logs</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active" role="tabpanel" aria-labelledby="dashboard-tab">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Loading statistics</div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents" class="tab-content" role="tabpanel" aria-labelledby="agents-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Agent Management</h2>
                    <button onclick="loadAgentModelsForSelect('agentModel'); openModal('createAgentModal')" class="btn-primary">+ Create New Agent</button>
                </div>
                <div id="agentsTable" class="loading">Loading agents...</div>
            </div>
        </div>

        <!-- Prompts Tab -->
        <div id="prompts" class="tab-content" role="tabpanel" aria-labelledby="prompts-tab">
            <div class="data-table">
                <h2>Prompt Versions Management</h2>
                <div class="form-group">
                    <label>Select Agent</label>
                    <select id="agentSelect" onchange="loadAgentPrompts()">
                        <option value="">-- Choose an agent --</option>
                    </select>
                </div>
                <div id="promptsList" class="hidden">
                    <div class="section-header">
                        <button onclick="openModal('createPromptModal')" class="btn-primary">+ Create New Prompt Version</button>
                    </div>
                    <div id="promptsTable" class="loading">Loading prompts</div>
                </div>
            </div>
        </div>
        <div id="users" class="tab-content" role="tabpanel" aria-labelledby="users-tab">
            <div class="data-table">
                <h2>User Management</h2>
                <div id="usersTable" class="loading">Loading users</div>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions" class="tab-content" role="tabpanel" aria-labelledby="subscriptions-tab">
            <div class="data-table">
                <h2>Subscription Management</h2>
                <div id="subscriptionsTable" class="loading">Loading subscriptions</div>
            </div>
        </div>

        <!-- Plans Tab -->
        <div id="plans" class="tab-content" role="tabpanel" aria-labelledby="plans-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Subscription Plans</h2>
                    <button onclick="openModal('createPlanModal')" class="btn-primary">+ Create New Plan</button>
                </div>
                <div id="plansTable" class="loading">Loading plans</div>
            </div>
        </div>
        
        <!-- Policies Tab -->
        <div id="policies" class="tab-content" role="tabpanel" aria-labelledby="policies-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Policies</h2>
                    <button onclick="openModal('createPolicyModal')" class="btn-primary">+ Create New Policy</button>
                </div>
                <div id="policiesTable" class="loading">Loading policies</div>
            </div>
        </div>

        <!-- Organizations Tab -->
        <div id="organizations" class="tab-content" role="tabpanel" aria-labelledby="organizations-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Organizations</h2>
                    <button onclick="openModal('createOrgModal')" class="btn-primary">+ Create New Organization</button>
                </div>
                <div id="organizationsTable" class="loading">Loading organizations</div>
            </div>
        </div>

        <!-- LLM Models Tab -->
        <div id="llm-models" class="tab-content" role="tabpanel" aria-labelledby="llm-models-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>LLM Models</h2>
                    <button class="btn-primary" onclick="showCreateLLMModelModal()">+ Add Model</button>
                </div>
                <div id="llmModelsTable" class="loading">Loading LLM models</div>
            </div>
        </div>

        <!-- Paddle Management Tab -->
        <div id="paddle" class="tab-content" role="tabpanel" aria-labelledby="paddle-tab">
            <!-- Paddle Configuration -->
            <div class="data-table">
                <div class="section-header">
                    <h2>Paddle Configuration</h2>
                    <button class="btn-primary" onclick="validatePaddleConfig()">üîç Validate Config</button>
                </div>
                <div id="paddleConfigStatus" class="info-box"></div>
            </div>

            <!-- Paddle Plans Management -->
            <div class="data-table">
                <div class="section-header">
                    <h2>Paddle Plans Sync</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="checkMissingPriceIds()">üîó Check Missing Price IDs</button>
                        <button class="btn-primary" onclick="showLinkPaddlePriceModal()">‚ûï Link Paddle Price</button>
                        <button class="btn-secondary" onclick="syncPaddlePlans()">üîÑ Sync All Plans</button>
                    </div>
                </div>
                <div id="paddlePlansStatus"></div>
                <div id="missingPriceIdsTable"></div>
            </div>

            <!-- Billing Accounts Dashboard -->
            <div class="data-table">
                <div class="section-header">
                    <h2>Billing Accounts</h2>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="billingStatusFilter" placeholder="Filter by status..." style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button class="btn-secondary" onclick="loadBillingAccounts()">üîç Filter</button>
                        <button class="btn-primary" onclick="detectDrift()">‚ö†Ô∏è Detect Drift</button>
                        <button class="btn-secondary" onclick="syncAllBillingAccounts()">üîÑ Sync All</button>
                    </div>
                </div>
                <div id="billingAccountsTable" class="loading">Loading billing accounts...</div>
            </div>

            <!-- Paddle Reconciliation -->
            <div class="data-table">
                <div class="section-header">
                    <h2>Paddle Reconciliation</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="reconcileSubscriptions()">üîÑ Reconcile Now</button>
                        <button class="btn-secondary" onclick="checkBillingStatus()">üìä Check Status</button>
                        <button class="btn-secondary" onclick="autoBackfill()">‚ö° Auto Backfill</button>
                    </div>
                </div>
                <div id="reconciliationResults"></div>
            </div>

            <!-- Paddle Subscription Management (Sandbox Testing) -->
            <div class="data-table">
                <div class="section-header">
                    <h2>üß™ Paddle Subscription Management (Sandbox)</h2>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">
                        Test Paddle API operations: add/remove items, upgrade/downgrade, pause/resume, cancel
                    </p>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Select Billing Account:</label>
                    <select id="testSubscriptionSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">Loading accounts...</option>
                    </select>
                    <button class="btn-secondary" onclick="loadTestSubscriptionAccounts()" style="margin-top: 10px;">üîÑ Refresh List</button>
                </div>
                
                <div id="subscriptionManagementPanel" style="display: none;">
                    <!-- Current Items Display -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px;">
                        <h3 style="margin-top: 0;">Current Subscription Items</h3>
                        <div id="currentSubscriptionItems" class="loading">Select account to view items</div>
                        <button class="btn-secondary" onclick="refreshCurrentItems()" style="margin-top: 10px;">üîÑ Refresh Items</button>
                    </div>

                    <!-- Action Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="showSubscriptionAction('addItems')">‚ûï Add Items</button>
                        <button class="btn-secondary" onclick="showSubscriptionAction('removeItems')">‚ûñ Remove Items</button>
                        <button class="btn-secondary" onclick="showSubscriptionAction('replaceItems')">üîÑ Replace Items</button>
                        <button class="btn-secondary" onclick="showSubscriptionAction('pause')">‚è∏Ô∏è Pause</button>
                        <button class="btn-secondary" onclick="showSubscriptionAction('resume')">‚ñ∂Ô∏è Resume</button>
                        <button class="btn-secondary" onclick="showSubscriptionAction('cancel')">‚ùå Cancel</button>
                    </div>

                    <!-- Add Items Form -->
                    <div id="addItemsForm" class="action-form" style="display: none;">
                        <h3>Add Items to Subscription</h3>
                        <div class="form-group">
                            <label>Price IDs (comma-separated):</label>
                            <input type="text" id="addItemsPriceIds" placeholder="pri_01abc123,pri_02def456">
                            <small>Example: pri_01abc123,pri_02def456</small>
                        </div>
                        <div class="form-group">
                            <label>Proration Mode:</label>
                            <select id="addItemsProration">
                                <option value="prorated_immediately">Prorated Immediately (charge now)</option>
                                <option value="prorated_next_billing_period">Prorated Next Period</option>
                                <option value="full_immediately">Full Immediately</option>
                                <option value="full_next_billing_period">Full Next Period</option>
                                <option value="do_not_bill">Do Not Bill</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="executeAddItems()">‚ûï Add Items</button>
                    </div>

                    <!-- Remove Items Form -->
                    <div id="removeItemsForm" class="action-form" style="display: none;">
                        <h3>Remove Items from Subscription</h3>
                        <div class="form-group">
                            <label>Price IDs to Remove (comma-separated):</label>
                            <input type="text" id="removeItemsPriceIds" placeholder="pri_01abc123,pri_02def456">
                        </div>
                        <div class="form-group">
                            <label>Proration Mode:</label>
                            <select id="removeItemsProration">
                                <option value="prorated_immediately">Prorated Immediately (credit now)</option>
                                <option value="prorated_next_billing_period">Prorated Next Period</option>
                                <option value="full_immediately">Full Immediately</option>
                                <option value="full_next_billing_period">Full Next Period</option>
                                <option value="do_not_bill">Do Not Bill</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="executeRemoveItems()">‚ûñ Remove Items</button>
                    </div>

                    <!-- Replace Items Form -->
                    <div id="replaceItemsForm" class="action-form" style="display: none;">
                        <h3>Replace All Subscription Items</h3>
                        <div class="form-group">
                            <label>New Price IDs (comma-separated):</label>
                            <input type="text" id="replaceItemsPriceIds" placeholder="pri_01abc123,pri_02def456">
                            <small>‚ö†Ô∏è This will replace ALL current items with these new ones</small>
                        </div>
                        <div class="form-group">
                            <label>Proration Mode:</label>
                            <select id="replaceItemsProration">
                                <option value="prorated_immediately">Prorated Immediately</option>
                                <option value="prorated_next_billing_period">Prorated Next Period</option>
                                <option value="full_immediately">Full Immediately</option>
                                <option value="full_next_billing_period">Full Next Period</option>
                                <option value="do_not_bill">Do Not Bill</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="executeReplaceItems()">üîÑ Replace Items</button>
                    </div>

                    <!-- Pause Form -->
                    <div id="pauseForm" class="action-form" style="display: none;">
                        <h3>Pause Subscription</h3>
                        <div class="form-group">
                            <label>Effective From:</label>
                            <select id="pauseEffectiveFrom">
                                <option value="next_billing_period">Next Billing Period</option>
                                <option value="immediately">Immediately</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Auto Resume At (optional):</label>
                            <input type="datetime-local" id="pauseResumeAt">
                            <small>Leave empty for manual resume</small>
                        </div>
                        <button class="btn-primary" onclick="executePause()">‚è∏Ô∏è Pause Subscription</button>
                    </div>

                    <!-- Resume Form -->
                    <div id="resumeForm" class="action-form" style="display: none;">
                        <h3>Resume Subscription</h3>
                        <div class="form-group">
                            <label>Effective From:</label>
                            <select id="resumeEffectiveFrom">
                                <option value="immediately">Immediately</option>
                                <option value="next_billing_period">Next Billing Period</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="executeResume()">‚ñ∂Ô∏è Resume Subscription</button>
                    </div>

                    <!-- Cancel Form -->
                    <div id="cancelForm" class="action-form" style="display: none;">
                        <h3>Cancel Subscription</h3>
                        <div class="form-group">
                            <label>Effective From:</label>
                            <select id="cancelEffectiveFrom">
                                <option value="next_billing_period">Next Billing Period (access continues)</option>
                                <option value="immediately">Immediately (access stops now)</option>
                            </select>
                        </div>
                        <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 15px;">
                            ‚ö†Ô∏è <strong>Warning:</strong> This action cannot be undone. The subscription will be canceled.
                        </div>
                        <button class="btn-primary" onclick="executeCancel()" style="background: #dc3545;">‚ùå Cancel Subscription</button>
                    </div>

                    <!-- Results Display -->
                    <div id="subscriptionActionResults" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Webhook Events Log -->
            <div class="data-table">
                <div class="section-header">
                    <h2>Paddle Webhook Events</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="webhookEventType" onchange="loadWebhookEvents()">
                            <option value="">All Event Types</option>
                            <option value="subscription.activated">subscription.activated</option>
                            <option value="subscription.updated">subscription.updated</option>
                            <option value="subscription.canceled">subscription.canceled</option>
                            <option value="subscription.paused">subscription.paused</option>
                            <option value="subscription.resumed">subscription.resumed</option>
                            <option value="transaction.completed">transaction.completed</option>
                            <option value="transaction.paid">transaction.paid</option>
                        </select>
                        <select id="webhookStatus" onchange="loadWebhookEvents()">
                            <option value="">All Statuses</option>
                            <option value="RECEIVED">Received</option>
                            <option value="PROCESSED">Processed</option>
                            <option value="FAILED">Failed</option>
                            <option value="SKIPPED">Skipped</option>
                        </select>
                        <input type="number" id="webhookLimit" value="50" min="10" max="500" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button class="btn-secondary" onclick="loadWebhookEvents()">üîç Filter</button>
                        <button class="btn-primary" onclick="loadWebhookStats()">üìä Stats</button>
                    </div>
                </div>
                <div id="webhookStatsBox"></div>
                <div id="webhookEventsTable" class="loading">Loading webhook events...</div>
            </div>
        </div>

        <!-- Usage Logs Tab -->
        <div id="logs" class="tab-content" role="tabpanel" aria-labelledby="logs-tab">
            <div class="data-table">
                <div class="section-header">
                    <h2>Usage Logs</h2>
                    <div class="logs-filters">
                        <input type="text" id="logsSearch" placeholder="Search by endpoint or user..." onkeyup="filterLogs()">
                        <select id="logsDays" onchange="loadLogs()">
                            <option value="1">Last 24 hours</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <input type="number" id="logsLimit" min="10" max="500" value="100" placeholder="Limit" onchange="loadLogs()" style="width: 100px;">
                        <button onclick="loadLogs()" class="btn-secondary">Refresh</button>
                    </div>
                </div>
                <div id="logsTable" class="loading">Loading logs...</div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-bottom">
                <p>&copy; 2024 {{ t('site_name') }}. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editUserEmail" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="editUserActive"> Active
                </label>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="editUserAdmin"> Admin
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn-primary" onclick="saveUserChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editSubscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Subscription</h2>
                <button class="modal-close" onclick="closeModal('editSubscriptionModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization</label>
                <input type="text" id="editSubsOrg" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Plan</label>
                <select id="editSubsPlan">
                    <option value="">Loading plans...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editSubsStatus">
                    <option value="active">Active</option>
                    <option value="trialing">Trialing</option>
                    <option value="canceled">Canceled</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editSubscriptionModal')">Cancel</button>
                <button class="btn-primary" onclick="saveSubscriptionChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Plan</h2>
                <button class="modal-close" onclick="closeModal('editPlanModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="editPlanName">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="editPlanPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="editPlanInterval">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Requests (Paid)</label>
                    <input type="number" id="editPlanMaxRequests" min="1">
                </div>
                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="editPlanMaxTokens" min="1">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Free Requests Limit</label>
                    <input type="number" id="editPlanFreeRequests" min="0" placeholder="0 = no free requests">
                </div>
                <div class="form-group">
                    <label>Free Trial Days</label>
                    <input type="number" id="editPlanFreeTrial" min="0" placeholder="0 = no trial period">
                </div>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanApiAccess"> API Access
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanPrioritySupport"> Priority
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editPlanAdvancedAnalytics"> Advanced
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editPlanModal')">Cancel</button>
                <button class="btn-primary" onclick="savePlanChanges()">Save</button>
            </div>
        </div>
    </div>

    <div id="editAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Agent</h2>
                <button class="modal-close" onclick="closeModal('editAgentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="editAgentName">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editAgentDescription" placeholder="What does this agent do?"></textarea>
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="editAgentSystemPrompt" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Model</label>
                    <select id="editAgentModel">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Temperature</label>
                    <input type="number" id="editAgentTemperature" min="0" max="2" step="0.1">
                </div>
            </div>
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" id="editAgentMaxTokens" min="1">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editAgentActive"> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editAgentPublic"> Public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editAgentModal')">Cancel</button>
                <button class="btn-primary" onclick="saveAgentChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Agent Modal -->
    <div id="createAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Agent</h2>
                <button class="modal-close" onclick="closeModal('createAgentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="agentName" placeholder="e.g., Customer Support Bot">
            </div>
            <div class="form-group">
                <label>Slug (URL-friendly identifier)</label>
                <input type="text" id="agentSlug" placeholder="e.g., support-bot">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="agentDescription" placeholder="What does this agent do?"></textarea>
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="agentSystemPrompt" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Model</label>
                    <select id="agentModel">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Temperature</label>
                    <input type="number" id="agentTemperature" min="0" max="2" step="0.1" value="0.7">
                </div>
            </div>
            <div class="form-group">
                <label>Max Tokens</label>
                <input type="number" id="agentMaxTokens" min="1" value="2000">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="agentActive" checked> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="agentPublic"> Public
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createAgentModal')">Cancel</button>
                <button class="btn-primary" onclick="createAgent()">Create Agent</button>
            </div>
        </div>
    </div>

    <!-- Create Prompt Modal -->
    <div id="createPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Prompt Version</h2>
                <button class="modal-close" onclick="closeModal('createPromptModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Prompt Name</label>
                <input type="text" id="promptName" placeholder="e.g., Welcome Message">
            </div>
            <div class="form-group">
                <label>Version</label>
                <input type="text" id="promptVersion" placeholder="1.0.0" value="1.0.0">
            </div>
            <div class="form-group">
                <label>System Prompt</label>
                <textarea id="promptSystem" placeholder="You are a helpful assistant..."></textarea>
            </div>
            <div class="form-group">
                <label>User Template</label>
                <textarea id="promptTemplate" placeholder="Hello {name}, how can I help?"></textarea>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="promptActive"> Set as Active
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPromptModal')">Cancel</button>
                <button class="btn-primary" onclick="createPrompt()">Create Prompt</button>
            </div>
        </div>
    </div>

    <!-- Create Plan Modal -->
    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Plan</h2>
                <button class="modal-close" onclick="closeModal('createPlanModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Plan Name</label>
                <input type="text" id="planName" placeholder="e.g., Professional Plan">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Price</label>
                    <input type="number" id="planPrice" placeholder="9.99" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="planInterval">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Requests (Paid)</label>
                    <input type="number" id="planMaxRequests" placeholder="10000" min="1">
                </div>
                <div class="form-group">
                    <label>Max Tokens</label>
                    <input type="number" id="planMaxTokens" placeholder="4000" min="1">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Free Requests Limit</label>
                    <input type="number" id="planFreeRequests" min="0" placeholder="0 = no free requests">
                </div>
                <div class="form-group">
                    <label>Free Trial Days</label>
                    <input type="number" id="planFreeTrial" min="0" placeholder="0 = no trial">
                </div>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planApiAccess"> API Access
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planPrioritySupport"> Priority
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="planAdvancedAnalytics"> Analytics
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPlanModal')">Cancel</button>
                <button class="btn-primary" onclick="createPlan()">Create Plan</button>
            </div>
        </div>
    </div>

    <!-- Create Policy Modal -->
    <div id="createPolicyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Policy</h2>
                <button class="modal-close" onclick="closeModal('createPolicyModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Policy Name</label>
                <input type="text" id="policyName" placeholder="e.g., Free Plan Policy">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="policyDescription" placeholder="Policy description"></textarea>
            </div>
            <div class="form-group">
                <label>Max Requests Per Minute</label>
                <input type="number" id="policyMaxRequests" value="60">
            </div>
            <div class="form-group">
                <label>Max Tokens Per Request</label>
                <input type="number" id="policyMaxTokens" value="4000">
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createPolicyModal')">Cancel</button>
                <button class="btn-primary" onclick="createPolicy()">Create Policy</button>
            </div>
        </div>
    </div>

    <!-- Create LLM Model Modal -->
    <div id="createLLMModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New LLM Model</h2>
                <button class="modal-close" onclick="closeModal('createLLMModelModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Model Name (identifier)</label>
                <input type="text" id="llmModelName" placeholder="e.g., gpt-4, claude-3-sonnet">
            </div>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="llmModelDisplayName" placeholder="e.g., GPT-4 (OpenAI)">
            </div>
            <div class="form-group">
                <label>Provider</label>
                <select id="llmModelProvider">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="google">Google</option>
                </select>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="password" id="llmModelApiKey" placeholder="sk-...">
            </div>
            <div class="form-group">
                <label>API Base URL (optional)</label>
                <input type="text" id="llmModelApiBaseUrl" placeholder="https://api.openai.com/v1">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Tokens Limit</label>
                    <input type="number" id="llmModelMaxTokensLimit" min="1" value="4000" placeholder="4000">
                </div>
                <div class="form-group">
                    <label>Context Window</label>
                    <input type="number" id="llmModelContextWindow" min="1" value="8000" placeholder="8000">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="llmModelActive" checked> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="llmModelIsDefault"> Set as Default
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createLLMModelModal')">Cancel</button>
                <button class="btn-primary" onclick="createLLMModel()">Create Model</button>
            </div>
        </div>
    </div>

    <!-- Edit LLM Model Modal -->
    <div id="editLLMModelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit LLM Model</h2>
                <button class="modal-close" onclick="closeModal('editLLMModelModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="editLLMModelName" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="editLLMModelDisplayName">
            </div>
            <div class="form-group">
                <label>Provider</label>
                <input type="text" id="editLLMModelProvider" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>API Key (leave empty to keep current)</label>
                <input type="password" id="editLLMModelApiKey" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="form-group">
                <label>API Base URL (optional)</label>
                <input type="text" id="editLLMModelApiBaseUrl">
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Tokens Limit</label>
                    <input type="number" id="editLLMModelMaxTokensLimit" min="1">
                </div>
                <div class="form-group">
                    <label>Context Window</label>
                    <input type="number" id="editLLMModelContextWindow" min="1">
                </div>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editLLMModelActive"> Active
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editLLMModelIsDefault"> Set as Default
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editLLMModelModal')">Cancel</button>
                <button class="btn-primary" onclick="saveLLMModelChanges()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Organization Modal -->
    <div id="createOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Organization</h2>
                <button class="modal-close" onclick="closeModal('createOrgModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization Name</label>
                <input type="text" id="orgName" placeholder="e.g., Acme Corp">
            </div>
            <div class="form-group">
                <label>Slug (URL-friendly identifier)</label>
                <input type="text" id="orgSlug" placeholder="e.g., acme-corp">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="orgDescription" placeholder="Organization description"></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Users</label>
                    <input type="number" id="orgMaxUsers" min="1" value="10">
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="orgActive" checked> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('createOrgModal')">Cancel</button>
                <button class="btn-primary" onclick="createOrg()">Create Organization</button>
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div id="editOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Organization</h2>
                <button class="modal-close" onclick="closeModal('editOrgModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Organization Name</label>
                <input type="text" id="editOrgName">
            </div>
            <div class="form-group">
                <label>Slug</label>
                <input type="text" id="editOrgSlug" readonly class="readonly-input">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editOrgDescription"></textarea>
            </div>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Max Users</label>
                    <input type="number" id="editOrgMaxUsers" min="1">
                </div>
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="editOrgActive"> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('editOrgModal')">Cancel</button>
                <button class="btn-primary" onclick="saveOrgChanges()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentTab = 'dashboard';
        let editingUserId = null;
        let editingSubscriptionId = null;
        let editingPlanId = null;

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('access_token');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // API call helper
        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            try {
                const response = await fetch(API_BASE + endpoint, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 403) {
                    showAlert('Access denied. Admin privileges required.', 'error');
                    return null;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            event.target.classList.add('active');
            event.target.setAttribute('aria-selected', 'true');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab data
            loadTabData(tabName);
        }

        // Load tab data
        async function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'agents':
                    await loadAgents();
                    break;
                case 'prompts':
                    await loadAgentsDropdown();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'subscriptions':
                    await loadSubscriptions();
                    break;
                case 'plans':
                    await loadPlans();
                    break;
                case 'paddle':
                    await loadPaddleTab();
                    break;
                case 'policies':
                    await loadPolicies();
                    break;
                case 'organizations':
                    await loadOrganizations();
                    break;
                case 'llm-models':
                    await loadLLMModels();
                    break;
                case 'logs':
                    await loadLogs();
                    break;
            }
        }

        // Load dashboard statistics
        async function loadDashboard() {
            try {
                const stats = await apiCall('/admin/dashboard/stats');
                
                if (!stats) return;
                
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">${stats.total_users || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Subscriptions</h3>
                        <div class="value">${stats.active_subscriptions || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Organizations</h3>
                        <div class="value">${stats.total_organizations || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Month)</h3>
                        <div class="value">$${parseFloat(stats.revenue_month || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Revenue (Today)</h3>
                        <div class="value">$${parseFloat(stats.revenue_today || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>API Requests (Month)</h3>
                        <div class="value">${stats.api_requests_month || 0}</div>
                    </div>
                `;
                
                document.getElementById('statsGrid').innerHTML = statsHtml;
            } catch (error) {
                showAlert('Failed to load statistics: ' + error.message, 'error');
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const users = await apiCall('/admin/users');
                
                if (!users || users.length === 0) {
                    document.getElementById('usersTable').innerHTML = '<div class="empty-state">No users found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                users.forEach(user => {
                    const statusBadge = user.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const roleBadge = user.is_superuser ? 
                        '<span class="badge badge-admin">Admin</span>' : 
                        '<span class="badge">User</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.email}</td>
                            <td>${user.username || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>${roleBadge}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editUser(${user.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteUser(${user.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load users: ' + error.message, 'error');
            }
        }

        // Load subscriptions
        async function loadSubscriptions() {
            try {
                const subs = await apiCall('/admin/subscriptions');
                
                if (!subs || subs.length === 0) {
                    document.getElementById('subscriptionsTable').innerHTML = '<div class="empty-state">No subscriptions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Organization</th>
                                <th>Users</th>
                                <th>Plan</th>
                                <th>Status</th>
                                <th>Total Spent</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                subs.forEach(sub => {
                    const statusClass = sub.status === 'active' ? 'badge-active' : 
                                       sub.status === 'canceled' ? 'badge-inactive' : 'badge-pending';
                    
                    tableHtml += `
                        <tr>
                            <td>${sub.id}</td>
                            <td>${sub.organization_name} (#${sub.organization_id})</td>
                            <td>${sub.user_count || 0}</td>
                            <td>${sub.plan_name || 'Free'}</td>
                            <td><span class="badge ${statusClass}">${sub.status}</span></td>
                            <td>$${parseFloat(sub.total_spent || 0).toFixed(2)}</td>
                            <td>${new Date(sub.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editSubscription(${sub.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteSubscription(${sub.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('subscriptionsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load subscriptions: ' + error.message, 'error');
            }
        }

        // Load plans
        async function loadPlans() {
            try {
                const plans = await apiCall('/admin/plans');
                
                if (!plans || plans.length === 0) {
                    document.getElementById('plansTable').innerHTML = '<div class="empty-state">No plans found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Interval</th>
                                <th>Max Requests</th>
                                <th>Max Tokens</th>
                                <th>Features</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                plans.forEach(plan => {
                    const features = [];
                    if (plan.has_api_access) features.push('API');
                    if (plan.has_priority_support) features.push('Support');
                    if (plan.has_advanced_analytics) features.push('Analytics');
                    
                    tableHtml += `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>$${parseFloat(plan.price).toFixed(2)}</td>
                            <td>${plan.interval}</td>
                            <td>${plan.max_requests_per_interval}</td>
                            <td>${plan.max_tokens_per_request}</td>
                            <td>${features.length ? features.join(', ') : 'None'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="managePlanAgents(${plan.id})">Agents</button>
                                    <button class="btn-small btn-edit" onclick="editPlan(${plan.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deletePlan(${plan.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('plansTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load plans: ' + error.message, 'error');
            }
        }

        // Load policies
        async function loadPolicies() {
            try {
                const policies = await apiCall('/admin/policies');
                
                if (!policies || policies.length === 0) {
                    document.getElementById('policiesTable').innerHTML = '<div class="empty-state">No policies found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Target</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                policies.forEach(policy => {
                    const statusBadge = policy.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    
                    tableHtml += `
                        <tr>
                            <td>${policy.id}</td>
                            <td>${policy.name}</td>
                            <td>${policy.rule_type}</td>
                            <td>${policy.target_resource}</td>
                            <td>${policy.priority}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-delete" onclick="deletePolicy(${policy.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('policiesTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load policies: ' + error.message, 'error');
            }
        }

        // Load organizations
        async function loadOrganizations() {
            try {
                document.getElementById('organizationsTable').innerHTML = '<div class="loading">Loading organizations</div>';
                const orgs = await apiCall('/admin/organizations');
                
                if (!orgs || orgs.length === 0) {
                    document.getElementById('organizationsTable').innerHTML = '<div class="empty-state">No organizations found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Members</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                orgs.forEach(org => {
                    tableHtml += `
                        <tr>
                            <td>${org.id}</td>
                            <td>${org.name}</td>
                            <td><code>${org.slug}</code></td>
                            <td>${org.member_count || 0}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-small btn-edit" onclick="editOrg(${org.id})">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteOrg(${org.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('organizationsTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('organizationsTable').innerHTML = `<div class="error">Failed to load organizations: ${error.message}</div>`;
            }
        }

        // User functions
        async function editUser(userId) {
            try {
                editingUserId = userId;
                const user = await apiCall(`/admin/users/${userId}`);
                
                document.getElementById('editUserEmail').value = user.email;
                document.getElementById('editUserActive').checked = user.is_active;
                document.getElementById('editUserAdmin').checked = user.is_superuser;
                openModal('editUserModal');
            } catch (error) {
                showAlert('Failed to load user details: ' + error.message, 'error');
            }
        }

        async function saveUserChanges() {
            try {
                await apiCall(`/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_active: document.getElementById('editUserActive').checked,
                        is_superuser: document.getElementById('editUserAdmin').checked
                    })
                });
                
                showAlert('User updated successfully');
                closeModal('editUserModal');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to update user: ' + error.message, 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action marks the user as inactive.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/users/${userId}`, { method: 'DELETE' });
                showAlert('User deleted successfully');
                await loadUsers();
            } catch (error) {
                showAlert('Failed to delete user: ' + error.message, 'error');
            }
        }

        // Subscription functions
        async function editSubscription(subId) {
            try {
                editingSubscriptionId = subId;
                
                // Load full subscription details
                const sub = await apiCall(`/admin/subscriptions/${subId}`);
                
                // Load plans into dropdown
                const plans = await apiCall('/admin/plans');
                const planSelect = document.getElementById('editSubsPlan');
                planSelect.innerHTML = '';
                
                if (plans && plans.length > 0) {
                    plans.forEach(plan => {
                        const option = document.createElement('option');
                        option.value = plan.id;
                        option.textContent = `${plan.name} - $${plan.price}/${plan.interval}`;
                        if (plan.id === sub.plan_id) {
                            option.selected = true;
                        }
                        planSelect.appendChild(option);
                    });
                } else {
                    planSelect.innerHTML = '<option value="">No plans available</option>';
                }
                
                document.getElementById('editSubsOrg').value = sub.organization_name;
                document.getElementById('editSubsStatus').value = sub.status;
                
                openModal('editSubscriptionModal');
            } catch (error) {
                showAlert('Failed to load subscription details: ' + error.message, 'error');
            }
        }

        async function saveSubscriptionChanges() {
            try {
                const planId = parseInt(document.getElementById('editSubsPlan').value);
                const status = document.getElementById('editSubsStatus').value;
                
                const updateData = {
                    subscription_status: status
                };
                
                if (planId) {
                    updateData.subscription_plan_id = planId;
                }
                
                await apiCall(`/admin/subscriptions/${editingSubscriptionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                showAlert('Subscription updated successfully');
                closeModal('editSubscriptionModal');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to update subscription: ' + error.message, 'error');
            }
        }

        async function deleteSubscription(subId) {
            if (!confirm('Are you sure you want to delete this subscription? This will cancel it.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/subscriptions/${subId}`, { method: 'DELETE' });
                showAlert('Subscription deleted successfully');
                await loadSubscriptions();
            } catch (error) {
                showAlert('Failed to delete subscription: ' + error.message, 'error');
            }
        }

        // Plan functions
        async function createPlan() {
            const name = document.getElementById('planName').value;
            const price = parseFloat(document.getElementById('planPrice').value);
            const interval = document.getElementById('planInterval').value;
            const maxRequests = parseInt(document.getElementById('planMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('planMaxTokens').value);
            const freeRequests = parseInt(document.getElementById('planFreeRequests').value) || 0;
            const freeTrial = parseInt(document.getElementById('planFreeTrial').value) || 0;
            
            if (!name || !price || !maxRequests || !maxTokens) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/plans', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        price,
                        interval,
                        currency: 'USD',
                        max_requests_per_interval: maxRequests,
                        max_tokens_per_request: maxTokens,
                        free_requests_limit: freeRequests,
                        free_trial_days: freeTrial,
                        has_api_access: document.getElementById('planApiAccess').checked,
                        has_priority_support: document.getElementById('planPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('planAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan created successfully');
                document.getElementById('planName').value = '';
                document.getElementById('planPrice').value = '';
                document.getElementById('planMaxRequests').value = '';
                document.getElementById('planMaxTokens').value = '';
                document.getElementById('planFreeRequests').value = '';
                document.getElementById('planFreeTrial').value = '';
                document.getElementById('planApiAccess').checked = false;
                document.getElementById('planPrioritySupport').checked = false;
                document.getElementById('planAdvancedAnalytics').checked = false;
                
                closeModal('createPlanModal');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to create plan: ' + error.message, 'error');
            }
        }

        async function editPlan(planId) {
            try {
                const plans = await apiCall('/admin/plans');
                const plan = plans.find(p => p.id === planId);
                
                if (!plan) {
                    showAlert('Plan not found', 'error');
                    return;
                }
                
                editingPlanId = planId;
                document.getElementById('editPlanName').value = plan.name;
                document.getElementById('editPlanPrice').value = plan.price;
                document.getElementById('editPlanInterval').value = plan.interval;
                document.getElementById('editPlanMaxRequests').value = plan.max_requests_per_interval;
                document.getElementById('editPlanMaxTokens').value = plan.max_tokens_per_request;
                document.getElementById('editPlanFreeRequests').value = plan.free_requests_limit || 0;
                document.getElementById('editPlanFreeTrial').value = plan.free_trial_days || 0;
                document.getElementById('editPlanApiAccess').checked = plan.has_api_access;
                document.getElementById('editPlanPrioritySupport').checked = plan.has_priority_support;
                document.getElementById('editPlanAdvancedAnalytics').checked = plan.has_advanced_analytics;
                openModal('editPlanModal');
            } catch (error) {
                showAlert('Failed to load plan: ' + error.message, 'error');
            }
        }

        async function savePlanChanges() {
            try {
                await apiCall(`/admin/plans/${editingPlanId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editPlanName').value,
                        price: parseFloat(document.getElementById('editPlanPrice').value),
                        interval: document.getElementById('editPlanInterval').value,
                        currency: 'USD',
                        max_requests_per_interval: parseInt(document.getElementById('editPlanMaxRequests').value),
                        max_tokens_per_request: parseInt(document.getElementById('editPlanMaxTokens').value),
                        free_requests_limit: parseInt(document.getElementById('editPlanFreeRequests').value) || 0,
                        free_trial_days: parseInt(document.getElementById('editPlanFreeTrial').value) || 0,
                        has_api_access: document.getElementById('editPlanApiAccess').checked,
                        has_priority_support: document.getElementById('editPlanPrioritySupport').checked,
                        has_advanced_analytics: document.getElementById('editPlanAdvancedAnalytics').checked
                    })
                });
                
                showAlert('Plan updated successfully');
                closeModal('editPlanModal');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to update plan: ' + error.message, 'error');
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Are you sure you want to delete this plan?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/plans/${planId}`, { method: 'DELETE' });
                showAlert('Plan deleted successfully');
                await loadPlans();
            } catch (error) {
                showAlert('Failed to delete plan: ' + error.message, 'error');
            }
        }

        // Manage plan-agent relationships
        async function managePlanAgents(planId) {
            try {
                // Load plan details, all agents and plan's current agents
                const [plan, allAgents, planAgentIds] = await Promise.all([
                    apiCall(`/admin/plans/${planId}`),
                    apiCall('/admin/agents'),
                    apiCall(`/admin/plans/${planId}/agents`)
                ]);
                
                let html = `
                    <div>
                        <h3>Manage Agents for "${plan.name}"</h3>
                        <p class="section-subtitle">Select which agents are included in this plan:</p>
                `;
                
                allAgents.forEach(agent => {
                    const isIncluded = planAgentIds.includes(agent.id);
                    html += `
                        <div class="agent-list-item">
                            <div class="agent-list-item-info">
                                <strong>${agent.name}</strong>
                                <div class="agent-description">${agent.description || 'No description'}</div>
                            </div>
                            <button 
                                class="${isIncluded ? 'btn-small btn-delete' : 'btn-small btn-primary'}" 
                                onclick="${isIncluded ? `removePlanAgent(${planId}, ${agent.id})` : `addPlanAgent(${planId}, ${agent.id})`}">
                                ${isIncluded ? 'Remove' : 'Add'}
                            </button>
                        </div>
                    `;
                });
                
                html += `
                        <button class="btn-primary" onclick="closeModal('planAgentsModal')">Done</button>
                    </div>
                `;
                
                // Create modal if it doesn't exist
                let modal = document.getElementById('planAgentsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'planAgentsModal';
                    modal.className = 'modal';
                    modal.innerHTML = '<div class="modal-content" id="planAgentsContent"></div>';
                    document.body.appendChild(modal);
                }
                
                document.getElementById('planAgentsContent').innerHTML = html;
                openModal('planAgentsModal');
            } catch (error) {
                showAlert('Failed to load plan agents: ' + error.message, 'error');
            }
        }

        async function addPlanAgent(planId, agentId) {
            try {
                await apiCall(`/admin/plans/${planId}/agents/${agentId}`, { method: 'POST' });
                showAlert('Agent added to plan');
                await managePlanAgents(planId); // Refresh
            } catch (error) {
                showAlert('Failed to add agent: ' + error.message, 'error');
            }
        }

        async function removePlanAgent(planId, agentId) {
            try {
                await apiCall(`/admin/plans/${planId}/agents/${agentId}`, { method: 'DELETE' });
                showAlert('Agent removed from plan');
                await managePlanAgents(planId); // Refresh
            } catch (error) {
                showAlert('Failed to remove agent: ' + error.message, 'error');
            }
        }

        // Policy functions
        async function createPolicy() {
            const name = document.getElementById('policyName').value;
            const description = document.getElementById('policyDescription').value;
            const maxRequests = parseInt(document.getElementById('policyMaxRequests').value);
            const maxTokens = parseInt(document.getElementById('policyMaxTokens').value);
            
            if (!name) {
                showAlert('Policy name is required', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/policies', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        rule_type: 'rate_limit',
                        target_resource: '*',
                        target_role: 'user',
                        config: { maxRequests, maxTokens }
                    })
                });
                
                showAlert('Policy created successfully');
                document.getElementById('policyName').value = '';
                document.getElementById('policyDescription').value = '';
                
                closeModal('createPolicyModal');
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to create policy: ' + error.message, 'error');
            }
        }

        async function deletePolicy(id) {
            if (!confirm('Are you sure you want to delete this policy?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/policies/${id}`, { method: 'DELETE' });
                showAlert('Policy deleted successfully');
                await loadPolicies();
            } catch (error) {
                showAlert('Failed to delete policy: ' + error.message, 'error');
            }
        }

        // Agent functions
        async function loadAgents() {
            try {
                document.getElementById('agentsTable').innerHTML = '<div class="loading">Loading agents</div>';
                const agents = await apiCall('/admin/agents?active_only=false');
                
                if (!agents || agents.length === 0) {
                    document.getElementById('agentsTable').innerHTML = '<div class="empty-state">No agents found</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Slug</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                agents.forEach(agent => {
                    const statusBadge = agent.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const createdDate = new Date(agent.created_at).toLocaleDateString();
                    
                    html += `
                        <tr>
                            <td>${agent.id}</td>
                            <td>${agent.name}</td>
                            <td>${agent.slug}</td>
                            <td>${agent.model_name}</td>
                            <td>${statusBadge}</td>
                            <td>${createdDate}</td>
                            <td>
                                <button onclick="editAgent(${agent.id})" class="btn-small">Edit</button>
                                <button onclick="deleteAgent(${agent.id})" class="btn-small btn-danger">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('agentsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('agentsTable').innerHTML = `<div class="error">Failed to load agents: ${error.message}</div>`;
            }
        }

        async function loadAgentModelsForSelect(selectId) {
            try {
                const models = await apiCall('/admin/llm-models');
                const selectElement = document.getElementById(selectId);
                selectElement.innerHTML = '';
                
                if (models && models.length > 0) {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.setAttribute('data-id', model.id);
                        option.textContent = model.display_name || model.name;
                        selectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No models available';
                    selectElement.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                const selectElement = document.getElementById(selectId);
                selectElement.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        async function createAgent() {
            const name = document.getElementById('agentName').value.trim();
            const slug = document.getElementById('agentSlug').value.trim();
            const description = document.getElementById('agentDescription').value.trim();
            const systemPrompt = document.getElementById('agentSystemPrompt').value.trim();
            const modelSelect = document.getElementById('agentModel');
            const modelName = modelSelect.value;
            const llmModelId = parseInt(modelSelect.selectedOptions[0].getAttribute('data-id'));
            const temperature = parseFloat(document.getElementById('agentTemperature').value);
            const maxTokens = parseInt(document.getElementById('agentMaxTokens').value);
            const isActive = document.getElementById('agentActive').checked;
            const isPublic = document.getElementById('agentPublic').checked;
            
            if (!name || !slug) {
                showAlert('Name and slug are required', 'error');
                return;
            }
            
            if (isNaN(temperature) || isNaN(maxTokens) || isNaN(llmModelId)) {
                showAlert('Temperature, max tokens, and model must be valid', 'error');
                return;
            }
            
            try {
                await apiCall('/admin/agents', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        slug,
                        description: description || null,
                        system_prompt: systemPrompt || 'You are a helpful assistant',
                        llm_model_id: llmModelId,
                        model_name: modelName,
                        temperature,
                        max_tokens: maxTokens,
                        is_active: isActive,
                        is_public: isPublic
                    })
                });
                
                showAlert('Agent created successfully');
                document.getElementById('agentName').value = '';
                document.getElementById('agentSlug').value = '';
                document.getElementById('agentDescription').value = '';
                document.getElementById('agentSystemPrompt').value = '';
                document.getElementById('agentModel').value = 'gpt-4';
                document.getElementById('agentTemperature').value = '0.7';
                document.getElementById('agentMaxTokens').value = '2000';
                document.getElementById('agentActive').checked = true;
                document.getElementById('agentPublic').checked = false;
                
                closeModal('createAgentModal');
                await loadAgents();
            } catch (error) {
                showAlert('Failed to create agent: ' + error.message, 'error');
            }
        }

        let editingAgentId = null;

        async function editAgent(agentId) {
            try {
                // Load models into select before opening modal
                await loadAgentModelsForSelect('editAgentModel');
                
                const agent = await apiCall(`/admin/agents/${agentId}`);
                
                editingAgentId = agentId;
                document.getElementById('editAgentName').value = agent.name;
                document.getElementById('editAgentDescription').value = agent.description || '';
                document.getElementById('editAgentSystemPrompt').value = agent.system_prompt || '';
                // Set model by llm_model_id
                const modelSelect = document.getElementById('editAgentModel');
                Array.from(modelSelect.options).forEach(option => {
                    if (parseInt(option.getAttribute('data-id')) === agent.llm_model_id) {
                        option.selected = true;
                    }
                });
                document.getElementById('editAgentTemperature').value = agent.temperature;
                document.getElementById('editAgentMaxTokens').value = agent.max_tokens;
                document.getElementById('editAgentActive').checked = agent.is_active;
                document.getElementById('editAgentPublic').checked = agent.is_public;
                
                openModal('editAgentModal');
            } catch (error) {
                showAlert('Failed to load agent: ' + error.message, 'error');
            }
        }

        async function saveAgentChanges() {
            if (!editingAgentId) return;
            
            try {
                const modelSelect = document.getElementById('editAgentModel');
                const modelName = modelSelect.value;
                const llmModelId = parseInt(modelSelect.selectedOptions[0].getAttribute('data-id'));
                
                await apiCall(`/admin/agents/${editingAgentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('editAgentName').value,
                        description: document.getElementById('editAgentDescription').value || null,
                        system_prompt: document.getElementById('editAgentSystemPrompt').value || null,
                        llm_model_id: llmModelId,
                        model_name: modelName,
                        temperature: parseFloat(document.getElementById('editAgentTemperature').value),
                        max_tokens: parseInt(document.getElementById('editAgentMaxTokens').value),
                        is_active: document.getElementById('editAgentActive').checked,
                        is_public: document.getElementById('editAgentPublic').checked
                    })
                });
                
                showAlert('Agent updated successfully');
                closeModal('editAgentModal');
                editingAgentId = null;
                await loadAgents();
            } catch (error) {
                showAlert('Failed to update agent: ' + error.message, 'error');
            }
        }

        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}`, { method: 'DELETE' });
                showAlert('Agent deleted successfully');
                await loadAgents();
            } catch (error) {
                showAlert('Failed to delete agent: ' + error.message, 'error');
            }
        }

        // Prompt functions
        async function loadAgentsDropdown() {
            try {
                const agents = await apiCall('/agents');
                const select = document.getElementById('agentSelect');
                
                if (!agents || agents.length === 0) {
                    select.innerHTML = '<option value="">No agents available</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">-- Choose an agent --</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showAlert('Failed to load agents: ' + error.message, 'error');
            }
        }

        async function loadAgentPrompts() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                document.getElementById('promptsList').style.display = 'none';
                return;
            }
            
            try {
                document.getElementById('promptsList').style.display = 'block';
                document.getElementById('promptsTable').innerHTML = '<div class="loading">Loading prompts</div>';
                
                const prompts = await apiCall(`/admin/agents/${agentId}/prompts`);
                
                if (!prompts || prompts.length === 0) {
                    document.getElementById('promptsTable').innerHTML = '<div class="empty-state">No prompt versions found</div>';
                    return;
                }
                
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>System Prompt</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                prompts.forEach(prompt => {
                    const statusBadge = prompt.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const systemPreview = prompt.system_prompt.substring(0, 50) + (prompt.system_prompt.length > 50 ? '...' : '');
                    
                    tableHtml += `
                        <tr>
                            <td>${prompt.name}</td>
                            <td>${prompt.version}</td>
                            <td>${systemPreview}</td>
                            <td>${statusBadge}</td>
                            <td>${new Date(prompt.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    ${!prompt.is_active ? `<button class="btn-small btn-view" onclick="activatePrompt(${prompt.id})">Activate</button>` : ''}
                                    <button class="btn-small btn-delete" onclick="deletePrompt(${prompt.id})">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                document.getElementById('promptsTable').innerHTML = tableHtml;
            } catch (error) {
                showAlert('Failed to load prompts: ' + error.message, 'error');
            }
        }

        async function createPrompt() {
            const agentId = document.getElementById('agentSelect').value;
            if (!agentId) {
                showAlert('Please select an agent first', 'error');
                return;
            }
            
            const name = document.getElementById('promptName').value;
            const version = document.getElementById('promptVersion').value || '1.0.0';
            const systemPrompt = document.getElementById('promptSystem').value;
            const userTemplate = document.getElementById('promptTemplate').value;
            const isActive = document.getElementById('promptActive').checked;
            
            if (!name || !systemPrompt || !userTemplate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                await apiCall(`/admin/agents/${agentId}/prompts`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        version,
                        system_prompt: systemPrompt,
                        user_template: userTemplate,
                        variables: [],
                        is_active: isActive
                    })
                });
                
                showAlert('Prompt version created successfully');
                document.getElementById('promptName').value = '';
                document.getElementById('promptVersion').value = '1.0.0';
                document.getElementById('promptSystem').value = '';
                document.getElementById('promptTemplate').value = '';
                document.getElementById('promptActive').checked = false;
                
                closeModal('createPromptModal');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to create prompt: ' + error.message, 'error');
            }
        }

        async function activatePrompt(promptId) {
            if (!confirm('Are you sure you want to activate this prompt version? The current active version will be deactivated.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}/activate`, {
                    method: 'POST'
                });
                
                showAlert('Prompt version activated successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to activate prompt: ' + error.message, 'error');
            }
        }

        async function deletePrompt(promptId) {
            if (!confirm('Are you sure you want to delete this prompt version?')) {
                return;
            }
            
            try {
                await apiCall(`/admin/prompts/${promptId}`, { method: 'DELETE' });
                showAlert('Prompt version deleted successfully');
                await loadAgentPrompts();
            } catch (error) {
                showAlert('Failed to delete prompt: ' + error.message, 'error');
            }
        }
        function viewOrg(id) {
            window.open(`/admin/organizations/${id}`, '_blank');
        }

        async function createOrg() {
            const name = document.getElementById('orgName').value.trim();
            const slug = document.getElementById('orgSlug').value.trim();
            const description = document.getElementById('orgDescription').value.trim();
            const maxUsers = parseInt(document.getElementById('orgMaxUsers').value);
            const isActive = document.getElementById('orgActive').checked;

            if (!name || !slug) {
                showAlert('Name and slug are required', 'error');
                return;
            }

            try {
                await apiCall('/admin/organizations', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        slug,
                        description: description || null,
                        max_users: maxUsers,
                        is_active: isActive
                    })
                });

                showAlert('Organization created successfully', 'success');
                closeModal('createOrgModal');
                
                // Reset form
                document.getElementById('orgName').value = '';
                document.getElementById('orgSlug').value = '';
                document.getElementById('orgDescription').value = '';
                document.getElementById('orgMaxUsers').value = '10';
                document.getElementById('orgActive').checked = true;
                
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to create organization: ${error.message}`, 'error');
            }
        }

        let editingOrgId = null;

        async function editOrg(id) {
            try {
                const org = await apiCall(`/admin/organizations/${id}`);
                
                editingOrgId = id;
                document.getElementById('editOrgName').value = org.name;
                document.getElementById('editOrgSlug').value = org.slug;
                document.getElementById('editOrgDescription').value = org.description || '';
                document.getElementById('editOrgMaxUsers').value = org.max_users || 10;
                document.getElementById('editOrgActive').checked = org.is_active !== false;
                
                openModal('editOrgModal');
            } catch (error) {
                showAlert(`Failed to load organization: ${error.message}`, 'error');
            }
        }

        async function saveOrgChanges() {
            if (!editingOrgId) return;

            const name = document.getElementById('editOrgName').value.trim();
            const description = document.getElementById('editOrgDescription').value.trim();
            const maxUsers = parseInt(document.getElementById('editOrgMaxUsers').value);
            const isActive = document.getElementById('editOrgActive').checked;

            if (!name) {
                showAlert('Name is required', 'error');
                return;
            }

            try {
                await apiCall(`/admin/organizations/${editingOrgId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        max_users: maxUsers,
                        is_active: isActive
                    })
                });

                showAlert('Organization updated successfully', 'success');
                closeModal('editOrgModal');
                editingOrgId = null;
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to update organization: ${error.message}`, 'error');
            }
        }

        async function deleteOrg(id) {
            if (!confirm('Are you sure you want to delete this organization? This will fail if any users belong to it.')) {
                return;
            }

            try {
                await apiCall(`/admin/organizations/${id}`, { method: 'DELETE' });
                showAlert('Organization deleted successfully', 'success');
                await loadOrganizations();
            } catch (error) {
                showAlert(`Failed to delete organization: ${error.message}`, 'error');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
        }

        async function loadCurrentUser() {
            try {
                const user = await apiCall('/auth/me');
                if (user) {
                    document.getElementById('adminName').textContent = user.email;
                    if (!user.is_superuser) {
                        showAlert('Warning: You do not have admin privileges', 'warning');
                    }
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // LLM Models functions
        let editingLLMModelId = null;

        async function loadLLMModels() {
            try {
                document.getElementById('llmModelsTable').innerHTML = '<div class="loading">Loading LLM models</div>';
                const models = await apiCall('/admin/llm-models');
                
                if (!models || models.length === 0) {
                    document.getElementById('llmModelsTable').innerHTML = '<div class="empty-state">No LLM models found</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Provider</th>
                                <th>API Key</th>
                                <th>Max Tokens</th>
                                <th>Context</th>
                                <th>Status</th>
                                <th>Default</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                models.forEach(model => {
                    const statusBadge = model.is_active ? 
                        '<span class="badge badge-active">Active</span>' : 
                        '<span class="badge badge-inactive">Inactive</span>';
                    const defaultBadge = model.is_default ? 
                        '<span class="badge badge-active">Default</span>' : '';
                    
                    html += `
                        <tr>
                            <td>${model.id}</td>
                            <td>${model.display_name || model.name}</td>
                            <td>${model.provider}</td>
                            <td><code>${model.api_key}</code></td>
                            <td>${model.max_tokens_limit.toLocaleString()}</td>
                            <td>${model.context_window.toLocaleString()}</td>
                            <td>${statusBadge}</td>
                            <td>${defaultBadge}</td>
                            <td>
                                <button onclick="editLLMModel(${model.id})" class="btn-small btn-edit">Edit</button>
                                <button onclick="deleteLLMModel(${model.id})" class="btn-small btn-delete">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('llmModelsTable').innerHTML = html;
            } catch (error) {
                document.getElementById('llmModelsTable').innerHTML = `<div class="error">Failed to load LLM models: ${error.message}</div>`;
            }
        }

        function showCreateLLMModelModal() {
            document.getElementById('createLLMModelModal').classList.add('active');
        }

        async function createLLMModel() {
            const name = document.getElementById('llmModelName').value.trim();
            const displayName = document.getElementById('llmModelDisplayName').value.trim();
            const provider = document.getElementById('llmModelProvider').value;
            const apiKey = document.getElementById('llmModelApiKey').value.trim();
            const apiBaseUrl = document.getElementById('llmModelApiBaseUrl').value.trim() || null;
            const maxTokensLimit = parseInt(document.getElementById('llmModelMaxTokensLimit').value);
            const contextWindow = parseInt(document.getElementById('llmModelContextWindow').value);
            const isActive = document.getElementById('llmModelActive').checked;
            const isDefault = document.getElementById('llmModelIsDefault').checked;

            if (!name || !displayName || !apiKey) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                await apiCall('/admin/llm-models', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        display_name: displayName,
                        provider,
                        api_key: apiKey,
                        api_base_url: apiBaseUrl,
                        max_tokens_limit: maxTokensLimit,
                        context_window: contextWindow,
                        is_active: isActive,
                        is_default: isDefault
                    })
                });

                showAlert('LLM model created successfully', 'success');
                closeModal('createLLMModelModal');
                
                // Reset form
                document.getElementById('llmModelName').value = '';
                document.getElementById('llmModelDisplayName').value = '';
                document.getElementById('llmModelApiKey').value = '';
                document.getElementById('llmModelApiBaseUrl').value = '';
                document.getElementById('llmModelMaxTokensLimit').value = '4000';
                document.getElementById('llmModelContextWindow').value = '8000';
                document.getElementById('llmModelActive').checked = true;
                document.getElementById('llmModelIsDefault').checked = false;
                
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to create LLM model: ${error.message}`, 'error');
            }
        }

        async function editLLMModel(id) {
            try {
                const model = await apiCall(`/admin/llm-models/${id}`);
                
                editingLLMModelId = id;
                document.getElementById('editLLMModelName').value = model.name;
                document.getElementById('editLLMModelDisplayName').value = model.display_name || model.name;
                document.getElementById('editLLMModelProvider').value = model.provider;
                document.getElementById('editLLMModelApiKey').value = '';  // Don't show existing key
                document.getElementById('editLLMModelApiBaseUrl').value = model.api_base_url || '';
                document.getElementById('editLLMModelMaxTokensLimit').value = model.max_tokens_limit;
                document.getElementById('editLLMModelContextWindow').value = model.context_window;
                document.getElementById('editLLMModelActive').checked = model.is_active;
                document.getElementById('editLLMModelIsDefault').checked = model.is_default;
                
                document.getElementById('editLLMModelModal').classList.add('active');
            } catch (error) {
                showAlert(`Failed to load LLM model: ${error.message}`, 'error');
            }
        }

        async function saveLLMModelChanges() {
            if (!editingLLMModelId) return;

            const displayName = document.getElementById('editLLMModelDisplayName').value.trim();
            const apiKey = document.getElementById('editLLMModelApiKey').value.trim();
            const apiBaseUrl = document.getElementById('editLLMModelApiBaseUrl').value.trim() || null;
            const maxTokensLimit = parseInt(document.getElementById('editLLMModelMaxTokensLimit').value);
            const contextWindow = parseInt(document.getElementById('editLLMModelContextWindow').value);
            const isActive = document.getElementById('editLLMModelActive').checked;
            const isDefault = document.getElementById('editLLMModelIsDefault').checked;

            try {
                const updateData = {
                    display_name: displayName,
                    api_base_url: apiBaseUrl,
                    max_tokens_limit: maxTokensLimit,
                    context_window: contextWindow,
                    is_active: isActive,
                    is_default: isDefault
                };

                // Only include api_key if it was changed
                if (apiKey) {
                    updateData.api_key = apiKey;
                }

                await apiCall(`/admin/llm-models/${editingLLMModelId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                showAlert('LLM model updated successfully', 'success');
                closeModal('editLLMModelModal');
                editingLLMModelId = null;
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to update LLM model: ${error.message}`, 'error');
            }
        }

        async function deleteLLMModel(id) {
            if (!confirm('Are you sure you want to delete this LLM model? This will fail if any agents are using it.')) {
                return;
            }

            try {
                await apiCall(`/admin/llm-models/${id}`, { method: 'DELETE' });
                showAlert('LLM model deleted successfully', 'success');
                await loadLLMModels();
            } catch (error) {
                showAlert(`Failed to delete LLM model: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentUser();
            await loadDashboard();
            await loadAgents();
            await loadAgentsDropdown();
        });

        // Usage Logs Functions
        let allLogs = [];

        async function loadLogs() {
            try {
                const days = document.getElementById('logsDays').value || 7;
                const limit = document.getElementById('logsLimit').value || 100;
                
                const response = await apiCall(`/billing/usage-records?days=${days}&limit=${limit}`, { method: 'GET' });
                
                if (!response || !Array.isArray(response)) {
                    document.getElementById('logsTable').innerHTML = '<p class="error">No logs found</p>';
                    return;
                }

                // Sort by created_at descending (newest first)
                allLogs = response.sort((a, b) => {
                    const dateA = new Date(a.created_at);
                    const dateB = new Date(b.created_at);
                    return dateB - dateA;
                });

                displayLogs(allLogs);
            } catch (error) {
                document.getElementById('logsTable').innerHTML = `<p class="error">Error loading logs: ${error.message}</p>`;
            }
        }

        function displayLogs(logs) {
            if (!logs || logs.length === 0) {
                document.getElementById('logsTable').innerHTML = '<p class="no-data">No logs found</p>';
                return;
            }

            let html = `
                <table class="data-grid">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Endpoint</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Response Time (ms)</th>
                            <th>Tokens</th>
                            <th>Cost</th>
                            <th>User</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            logs.forEach(log => {
                const date = new Date(log.created_at);
                const timeStr = date.toLocaleString();
                const statusClass = log.status_code >= 400 ? 'error' : log.status_code >= 300 ? 'warning' : 'success';
                const tokens = log.total_tokens || 0;
                const cost = log.cost ? parseFloat(log.cost).toFixed(4) : '0.0000';
                const errorMsg = log.error_message ? `<span title="${log.error_message}">Error</span>` : '-';

                html += `
                    <tr>
                        <td><small>${timeStr}</small></td>
                        <td><code>${log.endpoint || '-'}</code></td>
                        <td>${log.method || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${log.status_code}</span></td>
                        <td>${log.response_time_ms}ms</td>
                        <td>${tokens}</td>
                        <td>$${cost}</td>
                        <td><small>${log.user_id || '-'}</small></td>
                        <td>${errorMsg}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('logsTable').innerHTML = html;
        }

        function filterLogs() {
            const searchText = document.getElementById('logsSearch').value.toLowerCase();
            
            if (!searchText) {
                displayLogs(allLogs);
                return;
            }

            const filtered = allLogs.filter(log => {
                const endpoint = (log.endpoint || '').toLowerCase();
                const userId = String(log.user_id || '').toLowerCase();
                const errorMsg = (log.error_message || '').toLowerCase();
                
                return endpoint.includes(searchText) || 
                       userId.includes(searchText) || 
                       errorMsg.includes(searchText);
            });

            displayLogs(filtered);
        }

        // ============================================
        // PADDLE MANAGEMENT FUNCTIONS
        // ============================================

        async function loadPaddleTab() {
            await Promise.all([
                validatePaddleConfig(),
                loadBillingAccounts(),
                loadWebhookEvents(),
                loadTestSubscriptionAccounts()
            ]);
        }

        // Paddle Configuration
        async function validatePaddleConfig() {
            const statusDiv = document.getElementById('paddleConfigStatus');
            statusDiv.innerHTML = '<div class="loading">Validating Paddle configuration...</div>';
            
            try {
                const response = await fetch('/admin/paddle/validate-config', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to validate configuration');
                }
                
                const data = await response.json();
                
                let html = '<div style="padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">';
                html += '<h3 style="margin: 0 0 10px 0; color: #1e40af;">Paddle Configuration Status</h3>';
                html += `<p><strong>Environment:</strong> ${data.environment || 'N/A'}</p>`;
                html += `<p><strong>Vendor ID:</strong> ${data.vendor_id || 'Not set'}</p>`;
                html += `<p><strong>API Key:</strong> ${data.api_key_configured ? '‚úÖ Configured' : '‚ùå Not configured'}</p>`;
                html += `<p><strong>Webhook Secret:</strong> ${data.webhook_secret_configured ? '‚úÖ Configured' : '‚ùå Not configured'}</p>`;
                
                if (data.validation_errors && data.validation_errors.length > 0) {
                    html += '<div style="margin-top: 10px; padding: 10px; background: #fee; border-left: 3px solid #dc2626;">';
                    html += '<strong>‚ö†Ô∏è Validation Errors:</strong><ul style="margin: 5px 0;">';
                    data.validation_errors.forEach(err => {
                        html += `<li>${err}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += '</div>';
                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Paddle Plans Management
        async function checkMissingPriceIds() {
            const tableDiv = document.getElementById('missingPriceIdsTable');
            tableDiv.innerHTML = '<div class="loading">Checking for missing Price IDs...</div>';
            
            try {
                const response = await fetch('/admin/plans/paddle/missing-price-ids', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to check price IDs');
                
                const plans = await response.json();
                
                if (plans.length === 0) {
                    tableDiv.innerHTML = '<div class="success-box">‚úÖ All plans have Paddle Price IDs configured!</div>';
                    return;
                }
                
                let html = '<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
                html += `<h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è ${plans.length} Plans Missing Price IDs</h4>`;
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f8f9fa; text-align: left;">';
                html += '<th style="padding: 8px; border-bottom: 2px solid #dee2e6;">Plan ID</th>';
                html += '<th style="padding: 8px; border-bottom: 2px solid #dee2e6;">Name</th>';
                html += '<th style="padding: 8px; border-bottom: 2px solid #dee2e6;">Price</th>';
                html += '<th style="padding: 8px; border-bottom: 2px solid #dee2e6;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                plans.forEach(plan => {
                    html += '<tr style="border-bottom: 1px solid #e9ecef;">';
                    html += `<td style="padding: 8px;">${plan.id}</td>`;
                    html += `<td style="padding: 8px;">${plan.name}</td>`;
                    html += `<td style="padding: 8px;">$${plan.price}/${plan.interval}</td>`;
                    html += `<td style="padding: 8px;"><button class="btn-secondary" data-plan-id="${plan.id}" data-plan-name="${plan.name}" onclick="handleLinkPriceClick(event)">üîó Link</button></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                tableDiv.innerHTML = html;
            } catch (error) {
                tableDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        function showLinkPaddlePriceModal(planId = null, planName = '') {
            const html = `
                <div class="modal-backdrop" onclick="closeModal()"></div>
                <div class="modal">
                    <div class="modal-header">
                        <h2>üîó Link Paddle Price ID</h2>
                        <button class="modal-close" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        ${planId ? `<p><strong>Plan:</strong> ${planName} (ID: ${planId})</p>` : ''}
                        <form id="linkPaddleForm" onsubmit="linkPaddlePrice(event, ${planId})">
                            ${!planId ? '<div class="form-group"><label>Plan ID *</label><input type="number" name="plan_id" required></div>' : ''}
                            <div class="form-group">
                                <label>Paddle Price ID *</label>
                                <input type="text" name="paddle_price_id" placeholder="pri_01..." required>
                            </div>
                            <div class="modal-footer">
                                <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                                <button type="submit" class="btn-primary">Link Price ID</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div');
            container.className = 'modal-container';
            container.innerHTML = html;
            document.body.appendChild(container);
        }

        function handleLinkPriceClick(event) {
            const btn = event.currentTarget;
            const planId = parseInt(btn.dataset.planId);
            const planName = btn.dataset.planName || '';
            showLinkPaddlePriceModal(planId, planName);
        }

        async function linkPaddlePrice(event, planId = null) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const payload = {
                plan_id: planId || parseInt(formData.get('plan_id')),
                paddle_price_id: formData.get('paddle_price_id')
            };
            
            try {
                const response = await fetch('/admin/plans/link-paddle', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to link price');
                }
                
                const data = await response.json();
                showAlert(`‚úÖ Plan "${data.name}" linked to Paddle price ${data.paddle_price_id}`, 'success');
                closeModal();
                checkMissingPriceIds();
            } catch (error) {
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function syncPaddlePlans() {
            if (!confirm('This will sync all plans with Paddle. Continue?')) return;
            
            const statusDiv = document.getElementById('paddlePlansStatus');
            statusDiv.innerHTML = '<div class="loading">Syncing plans with Paddle...</div>';
            
            try {
                const response = await fetch('/admin/plans/sync-paddle', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to sync plans');
                
                const data = await response.json();
                
                let html = '<div style="margin-top: 15px; padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">';
                html += `<h4 style="margin: 0 0 10px 0;">‚úÖ ${data.message}</h4>`;
                html += `<p><strong>Synced:</strong> ${data.synced_count} plans</p>`;
                
                if (data.errors && data.errors.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; font-weight: bold;">‚ö†Ô∏è Errors</summary><ul>';
                    data.errors.forEach(err => html += `<li>${err}</li>`);
                    html += '</ul></details>';
                }
                
                html += '</div>';
                statusDiv.innerHTML = html;
                
                setTimeout(() => statusDiv.innerHTML = '', 10000);
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Billing Accounts Dashboard
        async function loadBillingAccounts() {
            const tableDiv = document.getElementById('billingAccountsTable');
            tableDiv.innerHTML = '<div class="loading">Loading billing accounts...</div>';
            
            const statusFilter = document.getElementById('billingStatusFilter')?.value || '';
            const url = statusFilter ? `/admin/subscriptions?limit=100&skip=0` : '/admin/subscriptions?limit=100&skip=0';
            // Note: filtering by status is done client-side below
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load billing accounts');
                
                let accounts = await response.json();
                
                // Filter by status if provided
                if (statusFilter) {
                    accounts = accounts.filter(acc => acc.status.toLowerCase().includes(statusFilter.toLowerCase()));
                }
                
                if (accounts.length === 0) {
                    tableDiv.innerHTML = '<div class="info-box">No billing accounts found.</div>';
                    return;
                }
                
                let html = '<table class="data-table"><thead><tr>';
                html += '<th>ID</th><th>User</th><th>Plan</th><th>Status</th><th>Paddle Sub ID</th><th>Current Period</th><th>Actions</th>';
                html += '</tr></thead><tbody>';
                
                accounts.forEach(acc => {
                    const statusClass = acc.status === 'active' ? 'badge-success' : acc.status === 'canceled' ? 'badge-error' : 'badge-warning';
                    html += '<tr>';
                    html += `<td>${acc.id}</td>`;
                    html += `<td>${acc.user_email || acc.user_id}</td>`;
                    html += `<td>${acc.plan_name || 'N/A'}</td>`;
                    html += `<td><span class="badge ${statusClass}">${acc.status || 'unknown'}</span></td>`;
                    html += `<td>${acc.paddle_subscription_id || 'N/A'}</td>`;
                    html += `<td>${acc.current_period_start ? new Date(acc.current_period_start).toLocaleDateString() : 'N/A'} - ${acc.current_period_end ? new Date(acc.current_period_end).toLocaleDateString() : 'N/A'}</td>`;
                    html += `<td><button class="btn-secondary" onclick="viewBillingAccountDetails(${acc.id})">üëÅÔ∏è View</button></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            } catch (error) {
                tableDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        function closeBillingDetailsModal() {
            const modal = document.getElementById('billing-details-modal');
            if (modal) modal.remove();
        }

        async function viewBillingAccountDetails(accountId) {
            try {
                const response = await fetch(`/admin/subscriptions/${accountId}/details`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load account details');
                
                const data = await response.json();
                
                let html = `
                    <div class="modal-backdrop" onclick="closeBillingDetailsModal()"></div>
                    <div class="modal" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>üí≥ Billing Account Details</h2>
                            <button class="modal-close" onclick="closeBillingDetailsModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <h3>Local Database</h3>
                            <table style="width: 100%; margin-bottom: 20px;">
                                <tr><td><strong>ID:</strong></td><td>${data.database.id}</td></tr>
                                <tr><td><strong>User:</strong></td><td>${data.database.user_email} (${data.database.user_id})</td></tr>
                                <tr><td><strong>Plan:</strong></td><td>${data.database.plan_name}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge">${data.database.status}</span></td></tr>
                                <tr><td><strong>Paddle Subscription ID:</strong></td><td>${data.database.paddle_subscription_id || 'N/A'}</td></tr>
                                <tr><td><strong>Current Period:</strong></td><td>${data.database.current_period_start} - ${data.database.current_period_end}</td></tr>
                            </table>
                            
                            ${data.paddle ? `
                                <h3>Paddle API</h3>
                                <table style="width: 100%;">
                                    <tr><td><strong>Status:</strong></td><td><span class="badge">${data.paddle.status}</span></td></tr>
                                    <tr><td><strong>Next Billed:</strong></td><td>${data.paddle.next_billed_at || 'N/A'}</td></tr>
                                    <tr><td><strong>Billing Cycle:</strong></td><td>${data.paddle.billing_cycle || 'N/A'}</td></tr>
                                    <tr><td><strong>Paused At:</strong></td><td>${data.paddle.paused_at || 'N/A'}</td></tr>
                                    <tr><td><strong>Canceled At:</strong></td><td>${data.paddle.canceled_at || 'N/A'}</td></tr>
                                </table>
                            ` : '<p class="warning-box">‚ö†Ô∏è No data from Paddle API</p>'}
                            
                            ${data.discrepancies && data.discrepancies.length > 0 ? `
                                <div class="error-box" style="margin-top: 15px;">
                                    <h4>‚ö†Ô∏è Discrepancies Found:</h4>
                                    <ul>${data.discrepancies.map(d => `<li>${d}</li>`).join('')}</ul>
                                </div>
                            ` : '<div class="success-box" style="margin-top: 15px;">‚úÖ No discrepancies detected</div>'}
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.id = 'billing-details-modal';
                container.className = 'modal-container';
                container.innerHTML = html;
                document.body.appendChild(container);
            } catch (error) {
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function closeBillingDetailsModal() {
            const modal = document.getElementById('billing-details-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function detectDrift() {
            if (!confirm('This will check all billing accounts for discrepancies with Paddle. Continue?')) return;
            
            const tableDiv = document.getElementById('billingAccountsTable');
            const originalContent = tableDiv.innerHTML;
            tableDiv.innerHTML = '<div class="loading">Detecting drift in billing accounts...</div>';
            
            try {
                const response = await fetch('/admin/subscriptions/paddle/drift-detection', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to detect drift');
                
                const data = await response.json();
                
                let html = '<div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
                html += `<h4>üìä Drift Detection Results</h4>`;
                html += `<p><strong>Total Checked:</strong> ${data.total_checked}</p>`;
                html += `<p><strong>Accounts with Drift:</strong> ${data.accounts_with_drift.length}</p>`;
                
                if (data.accounts_with_drift.length > 0) {
                    html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; font-weight: bold;">View Details</summary>';
                    html += '<ul style="margin-top: 10px;">';
                    data.accounts_with_drift.forEach(acc => {
                        html += `<li><strong>Account ${acc.account_id}:</strong> ${acc.discrepancies.join(', ')}</li>`;
                    });
                    html += '</ul></details>';
                }
                
                html += '</div>';
                
                tableDiv.innerHTML = html + originalContent;
            } catch (error) {
                tableDiv.innerHTML = originalContent;
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function syncAllBillingAccounts() {
            if (!confirm('This will sync all billing accounts with Paddle. This may take a while. Continue?')) return;
            
            const tableDiv = document.getElementById('billingAccountsTable');
            const originalContent = tableDiv.innerHTML;
            tableDiv.innerHTML = '<div class="loading">Syncing all billing accounts...</div>';
            
            try {
                const response = await fetch('/admin/subscriptions/reconcile', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fix_drift: true })
                });
                
                if (!response.ok) throw new Error('Failed to sync accounts');
                
                const data = await response.json();
                
                showAlert(`‚úÖ Synced ${data.successful} accounts. Failed: ${data.failed}, Skipped: ${data.skipped}`, 'success');
                
                await loadBillingAccounts();
            } catch (error) {
                tableDiv.innerHTML = originalContent;
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Paddle Reconciliation
        async function reconcileSubscriptions() {
            if (!confirm('This will reconcile all subscriptions with Paddle. Continue?')) return;
            
            const resultsDiv = document.getElementById('reconciliationResults');
            resultsDiv.innerHTML = '<div class="loading">Reconciling subscriptions...</div>';
            
            try {
                const response = await fetch('/admin/subscriptions/reconcile', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fix_drift: true })
                });
                
                if (!response.ok) throw new Error('Failed to reconcile');
                
                const data = await response.json();
                
                let html = '<div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin-top: 15px;">';
                html += `<h4>‚úÖ Reconciliation Complete</h4>`;
                html += `<p><strong>Total Processed:</strong> ${data.total_processed}</p>`;
                html += `<p><strong>Successful:</strong> ${data.successful}</p>`;
                html += `<p><strong>Failed:</strong> ${data.failed}</p>`;
                html += `<p><strong>Skipped:</strong> ${data.skipped}</p>`;
                
                if (data.details && data.details.length > 0) {
                    html += '<details><summary style="cursor: pointer; margin-top: 10px;">View Details</summary><ul>';
                    data.details.forEach(detail => html += `<li>${JSON.stringify(detail)}</li>`);
                    html += '</ul></details>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                setTimeout(() => resultsDiv.innerHTML = '', 15000);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkBillingStatus() {
            const resultsDiv = document.getElementById('reconciliationResults');
            resultsDiv.innerHTML = '<div class="loading">Checking billing status...</div>';
            
            try {
                const response = await fetch('/admin/paddle/billing-status', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to check status');
                
                const data = await response.json();
                
                let html = '<div style="padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px; margin-top: 15px;">';
                html += '<h4>üìä Billing Status Overview</h4>';
                html += `<p><strong>Total Active Subscriptions:</strong> ${data.total_active}</p>`;
                html += `<p><strong>Subscriptions with Paddle ID:</strong> ${data.with_paddle_id}</p>`;
                html += `<p><strong>Subscriptions without Paddle ID:</strong> ${data.without_paddle_id}</p>`;
                html += `<p><strong>Recently Updated:</strong> ${data.recently_synced} (last 24h)</p>`;
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
                setTimeout(() => resultsDiv.innerHTML = '', 10000);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function autoBackfill() {
            if (!confirm('This will automatically backfill missing Paddle subscription IDs. Continue?')) return;
            
            const resultsDiv = document.getElementById('reconciliationResults');
            resultsDiv.innerHTML = '<div class="loading">Running auto-backfill...</div>';
            
            try {
                const response = await fetch('/admin/paddle/auto-backfill-paddle-ids', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to backfill');
                
                const data = await response.json();
                
                let html = '<div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin-top: 15px;">';
                html += `<h4>‚úÖ ${data.message}</h4>`;
                html += `<p><strong>Backfilled:</strong> ${data.backfilled_count}</p>`;
                
                if (data.errors && data.errors.length > 0) {
                    html += '<details><summary style="cursor: pointer; margin-top: 10px;">‚ö†Ô∏è Errors</summary><ul>';
                    data.errors.forEach(err => html += `<li>${err}</li>`);
                    html += '</ul></details>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                setTimeout(() => resultsDiv.innerHTML = '', 15000);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ============================================================================
        // Paddle Subscription Management (Sandbox Testing)
        // ============================================================================
        
        let selectedBillingAccountId = null;
        
        async function loadTestSubscriptionAccounts() {
            const select = document.getElementById('testSubscriptionSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                const response = await fetch('/admin/subscriptions?limit=100', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load accounts');
                
                const accounts = await response.json();
                
                // Filter only accounts with Paddle subscription
                const paddleAccounts = accounts.filter(acc => acc.paddle_subscription_id);
                
                if (paddleAccounts.length === 0) {
                    select.innerHTML = '<option value="">No accounts with Paddle subscriptions found</option>';
                    return;
                }
                
                select.innerHTML = '<option value="">-- Select an account --</option>';
                paddleAccounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = `${acc.organization_name} (${acc.status}) - ${acc.paddle_subscription_id}`;
                    select.appendChild(option);
                });
                
                select.onchange = () => {
                    selectedBillingAccountId = select.value;
                    if (selectedBillingAccountId) {
                        document.getElementById('subscriptionManagementPanel').style.display = 'block';
                        refreshCurrentItems();
                    } else {
                        document.getElementById('subscriptionManagementPanel').style.display = 'none';
                    }
                };
                
            } catch (error) {
                select.innerHTML = '<option value="">Error loading accounts</option>';
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function refreshCurrentItems() {
            if (!selectedBillingAccountId) return;
            
            const itemsDiv = document.getElementById('currentSubscriptionItems');
            itemsDiv.innerHTML = '<div class="loading">Loading current items...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/items`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load items');
                
                const data = await response.json();
                const items = data.items || [];
                
                if (items.length === 0) {
                    itemsDiv.innerHTML = '<p>No items found</p>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">';
                html += '<th style="padding: 10px; text-align: left;">Price ID</th>';
                html += '<th style="padding: 10px; text-align: left;">Product</th>';
                html += '<th style="padding: 10px; text-align: right;">Quantity</th>';
                html += '<th style="padding: 10px; text-align: left;">Status</th>';
                html += '</tr></thead><tbody>';
                
                items.forEach(item => {
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                    html += `<td style="padding: 10px;"><code>${item.price_id}</code></td>`;
                    html += `<td style="padding: 10px;">${item.product_name || 'N/A'}</td>`;
                    html += `<td style="padding: 10px; text-align: right;">${item.quantity}</td>`;
                    html += `<td style="padding: 10px;"><span class="badge">${item.status || 'active'}</span></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top: 10px; font-size: 14px; color: #666;">`;
                html += `<strong>Subscription Status:</strong> ${data.status} | `;
                html += `<strong>Next Billing:</strong> ${data.next_billed_at || 'N/A'}`;
                html += `</div>`;
                
                itemsDiv.innerHTML = html;
                
            } catch (error) {
                itemsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function showSubscriptionAction(action) {
            // Hide all forms
            document.querySelectorAll('.action-form').forEach(form => form.style.display = 'none');
            document.getElementById('subscriptionActionResults').innerHTML = '';
            
            // Show selected form
            const formMap = {
                'addItems': 'addItemsForm',
                'removeItems': 'removeItemsForm',
                'replaceItems': 'replaceItemsForm',
                'pause': 'pauseForm',
                'resume': 'resumeForm',
                'cancel': 'cancelForm'
            };
            
            const formId = formMap[action];
            if (formId) {
                document.getElementById(formId).style.display = 'block';
            }
        }
        
        async function executeAddItems() {
            if (!selectedBillingAccountId) return;
            
            const priceIds = document.getElementById('addItemsPriceIds').value.trim();
            const proration = document.getElementById('addItemsProration').value;
            
            if (!priceIds) {
                showAlert('‚ùå Please enter price IDs', 'error');
                return;
            }
            
            const items = priceIds.split(',').map(id => ({
                price_id: id.trim(),
                quantity: 1
            }));
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Adding items...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/add-items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items, proration_billing_mode: proration })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to add items');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                    </div>
                `;
                
                // Refresh items list
                setTimeout(() => refreshCurrentItems(), 1000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function executeRemoveItems() {
            if (!selectedBillingAccountId) return;
            
            const priceIds = document.getElementById('removeItemsPriceIds').value.trim();
            const proration = document.getElementById('removeItemsProration').value;
            
            if (!priceIds) {
                showAlert('‚ùå Please enter price IDs to remove', 'error');
                return;
            }
            
            const price_ids = priceIds.split(',').map(id => id.trim());
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Removing items...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/remove-items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ price_ids, proration_billing_mode: proration })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to remove items');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                    </div>
                `;
                
                setTimeout(() => refreshCurrentItems(), 1000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function executeReplaceItems() {
            if (!selectedBillingAccountId) return;
            
            const priceIds = document.getElementById('replaceItemsPriceIds').value.trim();
            const proration = document.getElementById('replaceItemsProration').value;
            
            if (!priceIds) {
                showAlert('‚ùå Please enter price IDs', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è This will replace ALL current items. Continue?')) return;
            
            const items = priceIds.split(',').map(id => ({
                price_id: id.trim(),
                quantity: 1
            }));
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Replacing items...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/update-items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items, proration_billing_mode: proration })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update items');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                        <p><strong>Items Count:</strong> ${data.items_count}</p>
                    </div>
                `;
                
                setTimeout(() => refreshCurrentItems(), 1000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function executePause() {
            if (!selectedBillingAccountId) return;
            
            const effectiveFrom = document.getElementById('pauseEffectiveFrom').value;
            const resumeAtInput = document.getElementById('pauseResumeAt').value;
            
            const body = { effective_from: effectiveFrom };
            if (resumeAtInput) {
                body.resume_at = new Date(resumeAtInput).toISOString();
            }
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Pausing subscription...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/pause`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to pause');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                        <p><strong>Resume At:</strong> ${data.resume_at}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function executeResume() {
            if (!selectedBillingAccountId) return;
            
            const effectiveFrom = document.getElementById('resumeEffectiveFrom').value;
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Resuming subscription...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/resume`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ effective_from: effectiveFrom })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to resume');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function executeCancel() {
            if (!selectedBillingAccountId) return;
            
            const effectiveFrom = document.getElementById('cancelEffectiveFrom').value;
            
            if (!confirm(`‚ö†Ô∏è Cancel subscription (${effectiveFrom})? This cannot be undone!`)) return;
            
            const resultsDiv = document.getElementById('subscriptionActionResults');
            resultsDiv.innerHTML = '<div class="loading">Canceling subscription...</div>';
            
            try {
                const response = await fetch(`/admin/subscriptions/${selectedBillingAccountId}/paddle/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ effective_from: effectiveFrom })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to cancel');
                }
                
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="success-box" style="margin-top: 15px;">
                        <h4>‚úÖ ${data.message}</h4>
                        <p><strong>Status:</strong> ${data.paddle_status}</p>
                        <p><strong>Effective:</strong> ${data.effective_from}</p>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Webhook Events
        async function loadWebhookEvents() {
            const tableDiv = document.getElementById('webhookEventsTable');
            tableDiv.innerHTML = '<div class="loading">Loading webhook events...</div>';
            
            const eventType = document.getElementById('webhookEventType')?.value || '';
            const status = document.getElementById('webhookStatus')?.value || '';
            const limit = document.getElementById('webhookLimit')?.value || '50';
            
            const params = new URLSearchParams();
            if (eventType) params.append('event_type', eventType);
            if (status) params.append('status', status);
            params.append('limit', limit);
            
            try {
                const response = await fetch(`/admin/webhooks?${params}`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load webhook events');
                
                const events = await response.json();
                
                if (events.length === 0) {
                    tableDiv.innerHTML = '<div class="info-box">No webhook events found.</div>';
                    return;
                }
                
                let html = '<table class="data-table"><thead><tr>';
                html += '<th>ID</th><th>Event Type</th><th>Status</th><th>Billing Account</th><th>Received At</th><th>Processed At</th><th>Actions</th>';
                html += '</tr></thead><tbody>';
                
                events.forEach(evt => {
                    const statusClass = evt.status === 'PROCESSED' ? 'badge-success' : 
                                       evt.status === 'FAILED' ? 'badge-error' : 
                                       evt.status === 'SKIPPED' ? 'badge-warning' : 'badge-info';
                    html += '<tr>';
                    html += `<td>${evt.id}</td>`;
                    html += `<td>${evt.event_type}</td>`;
                    html += `<td><span class="badge ${statusClass}">${evt.status}</span></td>`;
                    html += `<td>${evt.billing_account_id || 'N/A'}</td>`;
                    html += `<td>${new Date(evt.received_at).toLocaleString()}</td>`;
                    html += `<td>${evt.processed_at ? new Date(evt.processed_at).toLocaleString() : 'N/A'}</td>`;
                    html += `<td><button class="btn-secondary" onclick="viewWebhookDetails(${evt.id})">üëÅÔ∏è View</button> `;
                    if (evt.status === 'FAILED') {
                        html += `<button class="btn-primary" onclick="reprocessWebhook(${evt.id})">üîÑ Retry</button>`;
                    }
                    html += '</td></tr>';
                });
                
                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            } catch (error) {
                tableDiv.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function viewWebhookDetails(eventId) {
            try {
                const response = await fetch(`/admin/webhooks/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load webhook details');
                
                const event = await response.json();
                
                const html = `
                    <div class="modal-backdrop" onclick="closeModal()"></div>
                    <div class="modal" style="max-width: 900px;">
                        <div class="modal-header">
                            <h2>üì® Webhook Event Details</h2>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <table style="width: 100%; margin-bottom: 20px;">
                                <tr><td><strong>ID:</strong></td><td>${event.id}</td></tr>
                                <tr><td><strong>Paddle Event ID:</strong></td><td>${event.paddle_event_id}</td></tr>
                                <tr><td><strong>Event Type:</strong></td><td>${event.event_type}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge">${event.status}</span></td></tr>
                                <tr><td><strong>Billing Account ID:</strong></td><td>${event.billing_account_id || 'N/A'}</td></tr>
                                <tr><td><strong>Received At:</strong></td><td>${new Date(event.received_at).toLocaleString()}</td></tr>
                                <tr><td><strong>Processed At:</strong></td><td>${event.processed_at ? new Date(event.processed_at).toLocaleString() : 'N/A'}</td></tr>
                                <tr><td><strong>Signature Valid:</strong></td><td>${event.signature_valid ? '‚úÖ Yes' : '‚ùå No'}</td></tr>
                            </table>
                            
                            ${event.error_message ? `
                                <div class="error-box">
                                    <h4>‚ùå Error Message:</h4>
                                    <pre style="white-space: pre-wrap; word-wrap: break-word;">${event.error_message}</pre>
                                </div>
                            ` : ''}
                            
                            <details style="margin-top: 15px;">
                                <summary style="cursor: pointer; font-weight: bold;">üì¶ Event Payload</summary>
                                <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px;">${JSON.stringify(event.payload, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.className = 'modal-container';
                container.innerHTML = html;
                document.body.appendChild(container);
            } catch (error) {
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function reprocessWebhook(eventId) {
            if (!confirm('Reprocess this webhook event?')) return;
            
            try {
                const response = await fetch(`/admin/webhooks/${eventId}/reprocess`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to reprocess');
                }
                
                const data = await response.json();
                showAlert(`‚úÖ ${data.message}`, 'success');
                await loadWebhookEvents();
            } catch (error) {
                showAlert(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function loadWebhookStats() {
            const statsBox = document.getElementById('webhookStatsBox');
            statsBox.innerHTML = '<div class="loading">Loading webhook statistics...</div>';
            
            try {
                const response = await fetch('/admin/webhooks/stats', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const stats = await response.json();
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">';
                
                Object.entries(stats.by_status).forEach(([status, count]) => {
                    const colorMap = {
                        'RECEIVED': '#17a2b8',
                        'PROCESSED': '#28a745',
                        'FAILED': '#dc3545',
                        'SKIPPED': '#ffc107'
                    };
                    const color = colorMap[status] || '#6c757d';
                    
                    html += `<div style="padding: 15px; background: ${color}22; border-left: 4px solid ${color}; border-radius: 4px;">`;
                    html += `<div style="font-size: 24px; font-weight: bold; color: ${color};">${count}</div>`;
                    html += `<div style="color: #666; text-transform: capitalize;">${status}</div>`;
                    html += '</div>';
                });
                
                html += '</div>';
                
                html += '<details style="margin-top: 10px;"><summary style="cursor: pointer; font-weight: bold;">üìä By Event Type</summary>';
                html += '<table style="width: 100%; margin-top: 10px;"><thead><tr><th>Event Type</th><th>Count</th></tr></thead><tbody>';
                
                Object.entries(stats.by_event_type).forEach(([type, count]) => {
                    html += `<tr><td>${type}</td><td>${count}</td></tr>`;
                });
                
                html += '</tbody></table></details>';
                
                statsBox.innerHTML = html;
                
                setTimeout(() => statsBox.innerHTML = '', 15000);
            } catch (error) {
                statsBox.innerHTML = `<div class="error-box">‚ùå Error: ${error.message}</div>`;
            }
        }

    </script>
</body>
</html>