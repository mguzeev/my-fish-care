# üöÄ –î–ï–ô–°–¢–í–ò–ï: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è middleware

## ‚ö° –°–†–û–ß–ù–û

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç —Å 500 –æ—à–∏–±–∫–∞–º–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.  
**–ù—É–∂–Ω–∞ –°–†–û–ß–ù–ê–Ø –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞!**

---

## –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç

```
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
  GET / ‚Üí 500 TypeError
  GET /auth/me ‚Üí 500 TypeError
  –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:
  GET / ‚Üí 200 –∏–ª–∏ 404 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
  GET /auth/me ‚Üí 200 (—Ä–∞–±–æ—Ç–∞–µ—Ç)
  –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
```

---

## 1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–í—ã–±—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ –∫–∞–∫ –∑–∞–ø—É—â–µ–Ω–æ:

### –í–∞—Ä–∏–∞–Ω—Ç A: Systemd (Linux —Å–µ—Ä–≤–∏—Å)
```bash
sudo systemctl restart bot-generic

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status bot-generic

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
sudo journalctl -u bot-generic -n 50 -f
```

### –í–∞—Ä–∏–∞–Ω—Ç B: Docker Compose
```bash
cd /path/to/bot-generic
docker-compose down
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
docker-compose logs -f
```

### –í–∞—Ä–∏–∞–Ω—Ç C: PM2
```bash
pm2 stop all
pm2 start all
pm2 status

# –õ–æ–≥–∏
pm2 logs
```

### –í–∞—Ä–∏–∞–Ω—Ç D: –í—Ä—É—á–Ω—É—é (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
```bash
# –í —Ç–µ–∫—É—â–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –Ω–∞–∂–∞—Ç—å Ctrl+C

# –ü–æ—Ç–æ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

## 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# 1. –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç
curl http://localhost:8000/health
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 200

# 2. –¢–µ—Å—Ç –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
curl http://localhost:8000/
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å 200 –∏–ª–∏ 404, –ù–ï 500!

# 3. –¢–µ—Å—Ç —Å —Ç–æ–∫–µ–Ω–æ–º
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8000/auth/me
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å 200 (–µ—Å–ª–∏ token –≤–∞–ª–∏–¥–µ–Ω)

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8000/auth/me
psql -h localhost -U postgres -d bot_generic -c \
  "SELECT COUNT(*) FROM usage_records WHERE created_at > NOW() - INTERVAL '1 minute';"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0
```

---

## 3. –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
journalctl -u bot-generic -n 100 | grep -i error

# –ò–ª–∏ Docker –ª–æ–≥–∏
docker logs bot-generic | tail -100

# –ò–ª–∏ PM2 –ª–æ–≥–∏
pm2 logs
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
grep -n "return response" app/usage/tracker.py
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ –∫–æ–Ω—Ü–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ 82)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –ø—É—Å—Ç—ã—Ö return
grep -n "^[[:space:]]*return$" app/usage/tracker.py
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∏—á–µ–≥–æ
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```bash
python3 -m py_compile app/usage/tracker.py
# –î–æ–ª–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫
```

---

## 4. –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Å–∫–æ–ø–∏–ø–∞—Å—Ç—å—Ç–µ)

### Linux/Mac
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd
sudo systemctl restart bot-generic && \
  sleep 2 && \
  curl http://localhost:8000/health && \
  echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
```

### Docker
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å docker
cd /path/to/bot-generic && \
  docker-compose restart app && \
  sleep 3 && \
  curl http://localhost:8000/health && \
  echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
```

### –í—Ä—É—á–Ω—É—é
```bash
# –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤—Ä—É—á–Ω—É—é
# Ctrl+C –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
# –ü–æ—Ç–æ–º:
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
# –ñ–¥–∞—Ç—å –ø–æ–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è:
# INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–§–∞–π–ª:** `app/usage/tracker.py`

**–û—à–∏–±–∫–∞:** Middleware –≤–æ–∑–≤—Ä–∞—â–∞–ª None –≤–º–µ—Å—Ç–æ Response  
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ try-finally —Å return  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –ª–æ–≥–∏–∫–∞, return –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å–ª–µ finally  

**–î–µ—Ç–∞–ª–∏:** —Å–º–æ—Ç—Ä–∏—Ç–µ `MIDDLEWARE_FIX.md`

---

## –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

‚úÖ –í—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ  
‚úÖ GET / –Ω–µ –±—É–¥–µ—Ç 500 –æ—à–∏–±–∫–æ–π  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ usage_records –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å  
‚úÖ Dashboard –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥–∏  

---

## –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å

1. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ: `MIDDLEWARE_FIX_SUMMARY.md`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –ª–æ–≥–∏ –≤—ã—à–µ
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

---

## üéØ TL;DR

```
1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å:    sudo systemctl restart bot-generic
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:        curl http://localhost:8000/health
3. –ï—Å–ª–∏ 200:         ‚úÖ –≥–æ—Ç–æ–≤–æ!
4. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: journalctl -u bot-generic | tail
```

**–°–†–û–ß–ù–û –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å!** ‚ö°
