# ‚úÖ –≠–¢–ê–ü 2 –í–´–ü–û–õ–ù–ï–ù: –ú–û–î–ï–õ–¨ –î–ê–ù–ù–´–• –ò –ú–ò–ì–†–ê–¶–ò–ò

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 18 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å**: –ó–ê–í–ï–†–®–ï–ù ‚úÖ  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~45 –º–∏–Ω—É—Ç  

---

## üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### ‚úÖ 2.1 –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ is_default –≤ SubscriptionPlan
**–§–∞–π–ª**: `app/models/billing.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –ø–ª–∞–Ω–∞ –∫–∞–∫ default –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
# Default plan for new user registration
is_default: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
```

### ‚úÖ 2.2 –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ one_time_requests_used –≤ BillingAccount
**–§–∞–π–ª**: `app/models/billing.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–ª—è ONE_TIME –ø–ª–∞–Ω–æ–≤

```python
# Separate counter for ONE_TIME plan usage
one_time_requests_used: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
```

### ‚úÖ 2.3 –°–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è Alembic
**–§–∞–π–ª**: `alembic/versions/01ff044cdfea_add_is_default_and_one_time_requests_.py`  
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 
- –ü–æ–ª–µ `is_default` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É `subscription_plans`
- –ü–æ–ª–µ `one_time_requests_used` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É `billing_accounts`
- –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:
18|is_default|BOOLEAN|1|'false'|0  -- –≤ subscription_plans
23|one_time_requests_used|INTEGER|1|'0'|0  -- –≤ billing_accounts
```

### ‚úÖ 2.4 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–§–∞–π–ª**: `app/auth/router.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç is_default –ø–ª–∞–Ω –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞ "Free Trial"

**–î–û** (—Ö–∞—Ä–¥–∫–æ–¥):
```python
select(SubscriptionPlan).where(SubscriptionPlan.name == "Free Trial")
```

**–ü–û–°–õ–ï** (–≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥):
```python
default_plan_result = await db.execute(
    select(SubscriptionPlan).where(SubscriptionPlan.is_default == True)
)
default_plan = default_plan_result.scalar_one_or_none()

if not default_plan:
    # Fallback to first available plan with free requests
    fallback_result = await db.execute(
        select(SubscriptionPlan)
        .where(SubscriptionPlan.free_requests_limit > 0)
        .order_by(SubscriptionPlan.id)
    )
    default_plan = fallback_result.scalar_one_or_none()
```

### ‚úÖ 2.5 –û–±–Ω–æ–≤–ª–µ–Ω Policy Engine –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
**–§–∞–π–ª**: `app/policy/engine.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å ONE_TIME –ø–ª–∞–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫

**check_usage_limits()**:
```python
if plan.plan_type == PlanType.ONE_TIME:
    total_purchased = billing_account.one_time_purchases_count
    # Now using separate counter for ONE_TIME requests
    used = billing_account.one_time_requests_used  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ß–ï–¢–ß–ò–ö
    remaining = max(0, total_purchased - used)
```

**increment_usage()**:
```python  
if plan.plan_type == PlanType.ONE_TIME:
    # Now using separate counter for ONE_TIME requests
    billing_account.one_time_requests_used += 1  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ß–ï–¢–ß–ò–ö
```

### ‚úÖ 2.6 –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω default –ø–ª–∞–Ω –≤ –ë–î
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–ª–∞–Ω "FREE 5 requests" (ID: 8) –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ default –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
-- –¢–µ–∫—É—â–∏–µ –ø–ª–∞–Ω—ã:
8|FREE 5 requests|1       -- ‚úÖ DEFAULT
9|one time 20e 1 day|false 
10|10e Month Subscription + 1 day free|false
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –≠–¢–ê–ü–ê 2

- [x] **–ü–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –º–æ–¥–µ–ª–∏** ‚úÖ  
- [x] **–ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞** ‚úÖ  
- [x] **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç is_default –ø–ª–∞–Ω** ‚úÖ  
- [x] **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞–Ω—ã –≤ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω—ã** ‚úÖ  
- [x] **Policy Engine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏** ‚úÖ  
- [x] **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç** ‚úÖ  

---

## üéØ –î–û–°–¢–ò–ì–ù–£–¢–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. ‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏**: ONE_TIME –∏ SUBSCRIPTION –ø–ª–∞–Ω—ã –±–æ–ª—å—à–µ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É
2. ‚úÖ **–ì–∏–±–∫–∏–π default –ø–ª–∞–Ω**: –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–∫–æ–π –ø–ª–∞–Ω –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏  
3. ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è**: –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–∞–Ω
4. ‚úÖ **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ù–µ—Ç –±–æ–ª—å—à–µ —Ö–∞—Ä–¥–∫–æ–¥–∞ –ø–ª–∞–Ω–æ–≤ –≤ –∫–æ–¥–µ

### üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ:
- **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- **Backward compatibility**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- **Database integrity**: –í—Å–µ –ø–æ–ª—è –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ default values
- **Code quality**: –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –Ω–µ—Ç –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–æ–≤

---

## üß™ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –¢–ï–°–¢–´

### –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
# 1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø–æ–ª—É—á–∏–ª –ø–ª–∞–Ω —Å is_default=True 
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: BillingAccount —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏
```

### –¢–µ—Å—Ç 2: ONE_TIME —Å—á–µ—Ç—á–∏–∫–∏ 
```bash
# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç ONE_TIME –ø–ª–∞–Ω (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏)
# 2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 5 –∑–∞–ø—Ä–æ—Å–æ–≤
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: one_time_requests_used = 5, requests_used_current_period = 0
```

### –¢–µ—Å—Ç 3: –°–º–µ—à–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```bash  
# 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –ø–æ–¥–ø–∏—Å–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 10 –∑–∞–ø—Ä–æ—Å–æ–≤
# 2. –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É, –ø–æ–∫—É–ø–∞–µ—Ç ONE_TIME –Ω–∞ 20 –∫—Ä–µ–¥–∏—Ç–æ–≤
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å—á–µ—Ç—á–∏–∫–∏ –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É
```

### –¢–µ—Å—Ç 4: Default –ø–ª–∞–Ω fallback
```bash
# 1. –£–±—Ä–∞—Ç—å is_default —É –≤—Å–µ—Ö –ø–ª–∞–Ω–æ–≤
# 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø–æ–ª—É—á–∏–ª –ø–µ—Ä–≤—ã–π –ø–ª–∞–Ω —Å free_requests_limit > 0
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

**–ì–û–¢–û–í –ö –≠–¢–ê–ü–£ 3**: UX –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤
- –°–æ–∑–¥–∞—Ç—å endpoint `/billing/plans/available` —Å —É–º–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–ª–∞–Ω–æ–≤ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ
- –°–≤—è–∑–∞—Ç—å default –ø–ª–∞–Ω —Å –∞–≥–µ–Ω—Ç–∞–º–∏  
- –£–ª—É—á—à–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

---

## üìà –ú–ì–ù–û–í–ï–ù–ù–´–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

**–£–∂–µ —Å–µ–π—á–∞—Å —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞:**
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–µ–µ**: –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –ø–ª–∞–Ω–æ–≤ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç
- üéõÔ∏è **–ì–∏–±—á–µ**: –ê–¥–º–∏–Ω—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç default –ø–ª–∞–Ω—ã
- üìä **–¢–æ—á–Ω–µ–µ**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –ø–ª–∞–Ω–∞
- üßπ **–ß–∏—â–µ**: –ú–µ–Ω—å—à–µ —Ö–∞—Ä–¥–∫–æ–¥–∞, –±–æ–ª—å—à–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å**: üü¢ –ì–û–¢–û–í –ö –ü–†–û–î–ê–ö–®–ï–ù–£ (–æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)