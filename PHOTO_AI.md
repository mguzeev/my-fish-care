# План работы: Добавление функции отправки фото в AI

## Цель
Реализовать возможность отправки фотографий в AI агента через все каналы (веб, телеграм и т.д.) с автоматическим выбором первого доступного агента.

---

## Этап 1: Анализ и подготовка

### 1.1 Изучение текущей архитектуры
- [x] Изучить структуру каналов (web, telegram)
- [x] Изучить схемы запросов к агентам (AgentInvokeRequest)
- [x] Изучить систему локализации (i18n)
- [ ] Изучить поддержку мультимодальных моделей в LLM провайдерах
- [ ] Изучить лимиты и хранение файлов

### 1.2 Технические решения
- [x] **Определить формат хранения изображений**: Файловая система
  - MVP: Хранение в `./media/uploads/` (относительно корня проекта)
  - Фаза 2: Добавить запись метаданных в БД (таблица `uploaded_files`)
  - Фаза 3: Миграция на S3/Object Storage (опционально)
- [x] **Способ обработки изображений**: 
  - MVP: Загрузка → Сохранение в `./media/uploads/` → Чтение и конвертация в base64 → Передача в LLM
  - Фаза 2: Настроить nginx для статической раздачи + передача URL (опционально)
- [x] **Максимальный размер файла**: 10 МБ для MVP (20 МБ для премиум в Фазе 2)
- [x] **Поддерживаемые форматы**: JPEG, PNG, WebP, GIF (валидация по MIME type и magic bytes)
- [x] **TTL для файлов**: Без TTL в MVP (ручное управление)
- [x] **Очистка файлов в MVP**: Без автоочистки (Фаза 2: cron job или celery task)

### 1.3 Оценка изменений
- [ ] Миграция БД (если нужна)
- [ ] Изменения в API схемах
- [ ] Изменения в каждом канале
- [ ] Изменения в локализации
- [ ] Изменения в UI/UX

---

## Этап 2: Изменения в базе данных и моделях

### 2.1 Миграция БД
**MVP (без таблицы uploaded_files):**
- [ ] Добавить флаг `supports_vision: bool` в таблицу `llm_models`
- [ ] Добавить флаг `supports_vision: bool` в таблицу `agents` (опционально, можно брать из llm_model)
- [ ] Добавить поле `has_image: bool` в таблицу `usage_records` для отслеживания
- [ ] Создать алембик миграцию
- [ ] Протестировать миграцию

**Фаза 2 (запись метаданных в БД):**
- [ ] Создать таблицу `uploaded_files`:
  ```sql
  uploaded_files:
    - id (PK)
    - user_id (FK)
    - file_path (путь в ФС)
    - file_name (оригинальное имя)
    - file_type (MIME type: image/jpeg, image/png, etc.)
**MVP:**
- [ ] Обновить модель `LLMModel` (добавить `supports_vision: bool`)
- [ ] Обновить модель `UsageRecord` (добавить `has_image: bool`)

**Фаза 2:**
- [ ] Создать модель `UploadedFile` с полями из миграции
- [ ] Обновить модель `UsageRecord` (добавить `uploaded_file_id: Optional[int]`
    - expires_at (для автоочистки)
    - is_deleted (soft delete)
  ```
- [ ] Добавить связь в `usage_records`: `uploaded_file_id` (FK, nullable)
- [ ] Создать алембик миграцию

### 2.2 Обновление моделей SQLAlchemy
- [ ] Создать модель `UploadedFile` (если нужно постоянное хранение)
- [ ] Обновить модель `UsageRecord` (добавить флаг has_image)

---

## Этап 3: Обновление API схем (Pydantic)

### 3.1 Схема запроса к агенту
**Файл:** `app/agents/schemas.py`

- [ ] Обновить `AgentInvokeRequest`:
  ```python
  class AgentInvokeRequest(BaseModel):
      input: str = Field(..., description="User input text")
      image_url: Optional[str] = Field(None, description="URL or base64 encoded image")
      image_data: Optional[str] = Field(None, description="Base64 encoded image data")
      variables: Dict[str, Any] = Field(default_factory=dict)
      stream: bool = Field(False)
      # Убрать поле agent_id - будет использоваться первый доступный
  ```
- [ ] Добавить валидацию: или `image_url`, или `image_data`, не оба сразу
- [ ] Добавить валидацию размера base64 данных (например, макс 10 МБ)

### 3.2 Схема ответа
- [ ] Добавить информацию о том, была ли обработана картинка:
  ```python
  class AgentResponse(BaseModel):
      agent_id: int
      output: str
      model: str
      processed_image: bool = False  # новое поле
      usage: Optional[UsageInfo] = None
      usage_tokens: Optional[int] = None
  ```

---

## Этап 4: Логика выбора агента

### 4.1 Реализация функции получения первого доступного агента
**Файл:** `app/agents/router.py` или новый `app/agents/selection.py`

- [ ] Создать функцию `get_first_available_agent(db: AsyncSession, user: User) -> Agent`:
  - Получить список активных агентов
  - Проверить доступ через policy_engine
  - Проверить поддержку мультимодальности (если картинка прикреплена)
  - Вернуть первого подходящего агента
- [ ] Обработать случай, когда нет доступных агентов (ошибка 403 или 404)

### 4.2 Обновить эндпоинт вызова агента
**Файл:** `app/agents/router.py`

- [ ] Изменить маршрут с `/{agent_id}/invoke` на `/invoke`
- [ ] Убрать параметр `agent_id` из пути
- [ ] Добавить вызов `get_first_available_agent()` внутри функции
- [ ] Передать image_url/image_data в runtime агента

---

## Этап 5: Обновление runtime агента

### 5.1 Поддержка изображений в LLM API
**Файл:** `app/agents/runtime.py`

- [ ] Изучить документацию API для мультимодальных моделей:
  - OpenAI (GPT-4 Vision)
  - Anthropic Claude (Vision)
  - Google Gemini
  - Другие
- [ ] Обновить функцию вызова LLM для передачи изображений
- [ ] Добавить обработку форматов:
  - Base64 encoded image
  - URL изображения
- [ ] Добавить обработку ошибок (неподдерживаемый формат, размер)

### 5.2 Проверка поддержки мультимодальности
- [ ] Добавить флаг `supports_vision` в модель `Agent` или `LLMModel`
- [ ] Проверять этот флаг при выборе агента с изображением
- [ ] Создать алембик миграцию для добавления флага

---

## Этап 6: Локализация

### 6.1 Добавление новых строк перевода
**Файлы:** 
- `app/i18n/strings/en.json`
- `app/i18n/strings/ru.json`
- `app/i18n/strings/uk.json` (если есть)

**Новые ключи:**
- `photo.upload_prompt` - "Отправьте фото или изображение"
- `photo.processing` - "Обрабатываю изображение..."
- `photo.error.too_large` - "Файл слишком большой (макс {max_size} МБ)"
- `photo.error.invalid_format` - "Неподдерживаемый формат. Используйте JPG, PNG или WebP"
- `photo.error.upload_failed` - "Ошибка загрузки файла"
- `photo.error.no_vision_agent` - "Нет доступных агентов с поддержкой изображений"
- `photo.success` - "Изображение получено"
- `agent.auto_selected` - "Автоматически выбран агент: {agent_name}"

### 6.2 Обновление текстов в каналах
**Файл:** `app/channels/texts.py`

- [ ] Добавить функции для новых текстов:
  ```python
  def photo_upload_prompt(locale: str = "en") -> str:
      return i18n.t("photo.upload_prompt", locale=locale)
  
  def photo_processing(locale: str = "en") -> str:
      return i18n.t("photo.processing", locale=locale)
  
  # и т.д.
  ```

---

## Этап 7: Веб-канал (Web API)

### 7.1 API для загрузки файлов
**Файл:** `app/channels/web.py`

- [ ] Добавить эндпоинт для загрузки файлов:
  ```python
  @router.post("/upload-image")
  async def upload_image(
      file: UploadFile,
      current_user: User = Depends(get_current_active_user)
  ):
      # Валидация формата
      # Валидация размера
      # Сохранение файла или конвертация в base64
      # Возврат URL или base64
  ```

### 7.2 API для отправки сообщения с изображением
- [ ] Обновить существующий эндпоинт или создать новый:
  ```python
  @router.post("/chat")
  async def web_chat(
      message: str,
      image_data: Optional[str] = None,
      current_user: User = Depends(get_current_active_user),
      db: AsyncSession = Depends(get_async_session)
  ):
      # Получить первого доступного агента
      # Вызвать агента с текстом и изображением
      # Вернуть ответ
  ```

### 7.3 Фронтенд (HTML/JavaScript)
**Файл:** `app/static/` или новый HTML файл

- [ ] Добавить input для загрузки файлов:
  ```html
  <input type="file" accept="image/*" id="imageInput">
  ```
- [ ] Добавить предпросмотр загруженного изображения
- [ ] Обработать отправку формы с изображением
- [ ] Показать состояние загрузки
- [ ] Убрать селектор агента из UI
- [ ] Показать автоматически выбранного агента

### 7.4 Локализация UI
- [ ] Добавить переводы для кнопок и подсказок в шаблоны

---

## Этап 8: Телеграм канал

### 8.1 Обработчик фотографий
**Файл:** `app/channels/telegram.py`

- [ ] Добавить обработчик для фото:
  ```python
  async def handle_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
      # Получить наибольшее фото из массива
      # Скачать файл через bot.get_file()
      # Конвертировать в base64 или сохранить URL
      # Получить caption как текст сообщения
      # Получить пользователя из БД
      # Получить первого доступного агента
      # Вызвать агента
      # Отправить ответ
  ```
- [ ] Зарегистрировать обработчик:
  ```python
  self.application.add_handler(
      MessageHandler(filters.PHOTO, self.handle_photo)
  )
  ```

### 8.2 Обновление текстов
- [ ] Использовать локализованные сообщения из `texts.py`
- [ ] Показать уведомление "Обрабатываю изображение..."
- [ ] Показать выбранного агента (опционально)

### 8.3 Обработка ошибок
- [ ] Файл слишком большой
- [ ] Неподдерживаемый формат
- [ ] Нет доступных агентов с vision
- [ ] Ошибка API

---

## Этап 9: Другие каналы

### 9.1 WhatsApp (если реализован)
- [ ] Аналогично Telegram: обработчик медиа-сообщений
- [ ] Скачивание и обработка файлов
- [ ] Локализация

### 9.2 Public API
**Файл:** `app/channels/` или отдельный роутер

- [ ] Документировать новый эндпоинт с поддержкой изображений
- [ ] Добавить примеры в OpenAPI/Swagger
- [ ] Обновить README для разработчиков

---

## Этап 10: Политики доступа и лимиты

### 10.1 Обновление policy engine
**Файл:** `app/policy/engine.py`

- [ ] Добавить проверку на поддержку изображений агентом
- [ ] Добавить лимиты на количество запросов с изображениями
- [ ] Добавить лимиты на размер файлов в разных тарифах

### 10.2 Обновление планов (тарифов)
- [ ] Определить, какие планы поддерживают отправку изображений
- [ ] Добавить поля в модель `SubscriptionPlan`:
  - `supports_images: bool`
  - `max_image_size_mb: int`
  - `max_images_per_day: int`
- [ ] Создать алембик миграцию

### 10.3 Обновление UsageRecord
- [ ] Добавить подсчет использования с изображениями отдельно
- [ ] Обновить аналитику

---

## Этап 11: Хранение и очистка файлов

### 11.1 Стратегия хранения
- [ ] Определить: временное хранение или постоянное
- [ ] Выбрать место хранения:
  - Локальная файловая система (`/tmp`, `/uploads`)
  - S3/MinIO/Object Storage
  - Только base64 в памяти (без хранения)

### 11.2 Очистка временных файлов
- [ ] Создать фоновую задачу для очистки старых файлов
- [ ] Добавить CRON или периодический таск
- [ ] Установить TTL (например, 24 часа)

### 11.3 Security
- [ ] Валидация типов файлов (magic bytes, не только расширение)
- [ ] Санитизация имен файлов
- [ ] Ограничение размера
- [ ] Rate limiting для загрузок

---

## Этап 12: Тестирование

### 12.1 Unit тесты
**Создать:** `tests/test_photo_upload.py`

- [ ] Тест валидации формата изображения
- [ ] Тест валидации размера
- [ ] Тест конвертации в base64
- [ ] Тест выбора первого доступного агента
- [ ] Тест обработки изображения в runtime

### 12.2 Интеграционные тесты
- [ ] Тест полного flow веб-канала
- [ ] Тест полного flow телеграм-канала
- [ ] Тест политик доступа с изображениями
- [ ] Тест лимитов

### 12.3 E2E тесты
**Обновить:** `tests/test_e2e_flow.py`

- [ ] Сценарий: пользователь отправляет фото через веб
- [ ] Сценарий: пользователь отправляет фото через телеграм
- [ ] Сценарий: превышение лимитов
- [ ] Сценарий: нет доступных агентов с vision

### 12.4 Ручное тестирование
- [ ] Протестировать в веб-интерфейсе
- [ ] Протестировать в телеграм-боте
- [ ] Протестировать с разными форматами (JPG, PNG, WebP, HEIC)
- [ ] Протестировать с большими файлами
- [ ] Протестировать локализацию (переключение языков)

---

## Этап 13: Документация

### 13.1 Обновление технической документации
- [ ] Обновить `ARCHITECTURE_AND_COMPONENTS.md`
  - Описать обработку мультимодальных запросов
  - Описать выбор агента
- [ ] Создать `PHOTO_UPLOAD_GUIDE.md`
  - Инструкции по настройке хранилища
  - Поддерживаемые форматы
  - Лимиты
- [ ] Обновить `README.md`
  - Добавить информацию о новой функции

### 13.2 API документация
- [ ] Обновить OpenAPI схемы (Swagger)
- [ ] Добавить примеры запросов с изображениями
- [ ] Документировать коды ошибок

### 13.3 Пользовательская документация
- [ ] Создать руководство для пользователей
- [ ] Добавить скриншоты
- [ ] Перевести на все поддерживаемые языки

---

## Этап 14: Деплой и мониторинг

### 14.1 Подготовка к деплою
- [ ] Обновить `requirements.txt` (если нужны новые библиотеки)
- [ ] Обновить environment variables (.env.example)
- [ ] Создать инструкции по миграции БД
- [ ] Обновить nginx.conf (если нужны изменения для загрузки файлов)

### 14.2 Мониторинг
- [ ] Добавить логирование для загрузки файлов
- [ ] Добавить метрики:
  - Количество запросов с изображениями
  - Средний размер файлов
  - Ошибки обработки
- [ ] Настроить алерты на превышение лимитов хранилища

### 14.3 Деплой
- [ ] Деплой в staging
- [ ] Прогон тестов в staging
- [ ] Деплой в production
- [ ] Smoke тесты в production

---

## Этап 15: Оптимизация и улучшения (опционально)

### 15.1 Производительность
- [ ] Кэширование обработанных изображений
- [ ] Асинхронная обработка больших файлов
- [ ] Сжатие изображений перед отправкой в LLM

### 15.2 UX улучшения
- [ ] Drag & drop для загрузки файлов в веб
- [ ] Предпросмотр перед отправкой
- [ ] История отправленных изображений
- [ ] Возможность отправить несколько изображений

### 15.3 Дополнительные форматы
- [ ] Поддержка PDF (первая страница)
- [ ] Поддержка документов (скриншоты)
- [ ] Поддержка видео (ключевые кадры)

---

## Риски и ограничения

### Технические риски
- **Размер файлов:** Большие файлы могут замедлить обработку
- **Стоимость:** Vision модели дороже текстовых
- **Лимиты API:** Некоторые LLM провайдеры имеют ограничения на размер/количество изображений
- **Хранилище:** Нужно предусмотреть достаточно места

### Бизнес-ограничения
- **Тарифы:** Нужно определить, в каких планах доступна функция
- **Модерация:** Изображения могут содержать запрещенный контент
- **GDPR/Privacy:** Хранение фотографий пользователей

---

## Итоговый чеклист запуска

- [ ] Все миграции БД применены
- [ ] Все тесты пройдены (unit, integration, e2e)
- [ ] Документация обновлена
- [ ] Локализация на всех языках готова
- [ ] Веб-канал работает с фото
- [ ] Телеграм-канал работает с фото
- [ ] Политики доступа настроены
- [ ] Лимиты тарифов установлены
- [ ] Мониторинг и логирование настроены
- [ ] Staging протестирован
- [ ] Production деплой выполнен
- [ ] Пользовательская документация опубликована

---

## Приоритизация (рекомендуемая)

### MVP (Минимальный продукт)
1. Этапы 1-4: Подготовка и базовая инфраструктура
2. Этап 5: Runtime с поддержкой vision
3. Этап 7: Веб-канал (основной)
4. Этап 12: Базовое тестирование
5. Этап 14: Деплой

### Фаза 2
6. Этап 8: Телеграм-канал
7. Этап 6: Полная локализация
8. Этап 10: Политики и лимиты
9. Этап 13: Документация

### Фаза 3
10. Этап 9: Другие каналы
11. Этап 11: Хранение и очистка
12. Этап 15: Оптимизации

---

## Оценка времени

- **MVP (Фаза 1):** 2-3 недели
- **Фаза 2:** 1-2 недели
- **Фаза 3:** 1 неделя

**Общее время:** 4-6 недель (в зависимости от команды и приоритетов)

---

*Документ создан: 21 января 2026*
