# ðŸ› ï¸ ÐŸÐ›ÐÐ Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð‘Ð˜Ð›Ð›Ð˜ÐÐ“ÐžÐ’ÐžÐ™ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«

**Ð”Ð°Ñ‚Ð°**: 18 ÑÐ½Ð²Ð°Ñ€Ñ 2026  
**ÐžÑÐ½Ð¾Ð²Ð°Ð½Ð¾ Ð½Ð°**: BILLING_AUDIT_REPORT.md  
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: Ð“ÐžÐ¢ÐžÐ’ Ðš Ð Ð•ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð˜

---

## ðŸ“‹ ÐžÐ‘Ð—ÐžÐ  Ð­Ð¢ÐÐŸÐžÐ’

| Ð­Ñ‚Ð°Ð¿ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ | Ð’Ñ€ÐµÐ¼Ñ | ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ |
|------|----------|-------|-------------|
| **1** | ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³Ð° | ~2-3 Ñ‡ | ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž |
| **2** | ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ | ~1-2 Ñ‡ | ðŸŸ¡ Ð’ÐÐ–ÐÐž |
| **3** | UX Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿Ð»Ð°Ð½Ð¾Ð² | ~2 Ñ‡ | ðŸŸ¢ Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐ˜Ð¯ |
| **4** | Ð ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ | ~1 Ñ‡ | ðŸ”µ OPTIONAL |

**ÐžÐ±Ñ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ**: ~6-8 Ñ‡Ð°ÑÐ¾Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ + Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

---

# ðŸš¨ Ð­Ð¢ÐÐŸ 1: ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð‘Ð˜Ð›Ð›Ð˜ÐÐ“Ð
> **Ð¦ÐµÐ»ÑŒ**: Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð»Ð¾Ð¼Ð°ÑŽÑ‚ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÑƒ  
> **Ð’Ñ€ÐµÐ¼Ñ**: ~2-3 Ñ‡Ð°ÑÐ°  
> **ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚**: ÐœÐÐšÐ¡Ð˜ÐœÐÐ›Ð¬ÐÐ«Ð™

## 1.1 Ð‘Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ Ð¿Ñ€Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ

**Ð¤Ð°Ð¹Ð»**: `app/billing/router.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `subscribe()`  
**ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸**: `ba = BillingAccount(organization_id=current_user.organization_id)`

```python
# Ð”ÐžÐ‘ÐÐ’Ð˜Ð¢Ð¬ Ð­Ð¢Ð£ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ£:
if plan.plan_type == PlanType.ONE_TIME:
    if ba.subscription_plan_id and ba.subscription_status in (SubscriptionStatus.ACTIVE, SubscriptionStatus.TRIALING):
        current_plan = await db.execute(select(SubscriptionPlan).where(SubscriptionPlan.id == ba.subscription_plan_id))
        current_plan = current_plan.scalar_one_or_none()
        if current_plan and current_plan.plan_type == PlanType.SUBSCRIPTION:
            raise HTTPException(
                status_code=400, 
                detail="Cannot purchase credits while subscription is active. Cancel subscription first to buy additional credits."
            )
```

## 1.2 Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ webhook Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº

**Ð¤Ð°Ð¹Ð»**: `app/webhooks/router.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `handle_transaction_completed()`  
**Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸**: ~562-566

```python
# Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð¬ Ð­Ð¢Ð˜ Ð¡Ð¢Ð ÐžÐšÐ˜:
# billing_account.subscription_plan_id = plan.id  # âŒ Ð£Ð‘Ð ÐÐ¢Ð¬
# billing_account.subscription_status = SubscriptionStatus.ACTIVE  # âŒ Ð£Ð‘Ð ÐÐ¢Ð¬
# billing_account.subscription_start_date = datetime.utcnow()  # âŒ Ð£Ð‘Ð ÐÐ¢Ð¬

# ÐÐ Ð­Ð¢Ð˜:
# Increment cumulative count
if plan.one_time_limit:
    billing_account.one_time_purchases_count += plan.one_time_limit
    logger.info(f"Incremented one_time_purchases_count to {billing_account.one_time_purchases_count}")

# Update transaction info only
billing_account.last_transaction_id = transaction_id
billing_account.last_webhook_event_id = event_id
```

## 1.3 Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Policy Engine

**Ð¤Ð°Ð¹Ð»**: `app/policy/engine.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `check_usage_limits()`  
**Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸**: ~175-178

```python
# Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð¬:
if plan.plan_type == PlanType.ONE_TIME:
    total_purchased = billing_account.one_time_purchases_count
    used = billing_account.requests_used_current_period  # âŒ ÐÐ•Ð’Ð•Ð ÐÐ«Ð™ Ð¡Ð§ÐÐ¢Ð§Ð˜Ðš

# ÐÐ:
if plan.plan_type == PlanType.ONE_TIME:
    total_purchased = billing_account.one_time_purchases_count
    used = billing_account.one_time_requests_used  # âœ… ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð™ Ð¡Ð§ÐÐ¢Ð§Ð˜Ðš
```

**âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•**: Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ñ `one_time_requests_used` Ð² Ð¼Ð¾Ð´ÐµÐ»ÑŒ (ÑÐ¼. Ð­Ñ‚Ð°Ð¿ 2)

## 1.4 Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ increment_usage Ð² Policy Engine

**Ð¤Ð°Ð¹Ð»**: `app/policy/engine.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `increment_usage()`  
**ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸**: `if plan.plan_type == PlanType.ONE_TIME:`

```python
# Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð¬:
billing_account.requests_used_current_period += 1

# ÐÐ:
billing_account.one_time_requests_used += 1
```

---

## âœ… ÐšÐ Ð˜Ð¢Ð•Ð Ð˜Ð˜ Ð“ÐžÐ¢ÐžÐ’ÐÐžÐ¡Ð¢Ð˜ Ð­Ð¢ÐÐŸÐ 1:
- [ ] ÐÐµÐ»ÑŒÐ·Ñ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ ONE_TIME Ð¿Ð»Ð°Ð½ Ð¿Ñ€Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ
- [ ] ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ ÐÐ• Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ subscription_plan_id
- [ ] ONE_TIME Ð¿Ð»Ð°Ð½Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÑ‡Ñ‘Ñ‚Ñ‡Ð¸Ðº (Ð¿Ð¾ÑÐ»Ðµ Ð­Ñ‚Ð°Ð¿Ð° 2)
- [ ] Webhook'Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ Ð¾Ð±Ð° Ñ‚Ð¸Ð¿Ð° Ð¿Ð»Ð°Ð½Ð¾Ð²

---

# ðŸ”§ Ð­Ð¢ÐÐŸ 2: ÐœÐžÐ”Ð•Ð›Ð¬ Ð”ÐÐÐÐ«Ð¥ Ð˜ ÐœÐ˜Ð“Ð ÐÐ¦Ð˜Ð˜
> **Ð¦ÐµÐ»ÑŒ**: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð»Ñ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸  
> **Ð’Ñ€ÐµÐ¼Ñ**: ~1-2 Ñ‡Ð°ÑÐ°  
> **ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚**: Ð’Ð«Ð¡ÐžÐšÐ˜Ð™

## 2.1 Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ðµ is_default Ð² SubscriptionPlan

**Ð¤Ð°Ð¹Ð»**: `app/models/billing.py`  
**Ð’ ÐºÐ»Ð°ÑÑ**: `SubscriptionPlan`

```python
# Ð”ÐžÐ‘ÐÐ’Ð˜Ð¢Ð¬ ÐŸÐžÐ›Ð•:
is_default: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
```

## 2.2 Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ðµ one_time_requests_used Ð² BillingAccount

**Ð¤Ð°Ð¹Ð»**: `app/models/billing.py`  
**Ð’ ÐºÐ»Ð°ÑÑ**: `BillingAccount`

```python
# Ð”ÐžÐ‘ÐÐ’Ð˜Ð¢Ð¬ ÐŸÐžÐ›Ð•:
one_time_requests_used: Mapped[int] = mapped_column(Integer, default=0, nullable=False)
```

## 2.3 Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Alembic

```bash
cd /home/mguzieiev/maks/bot-generic
alembic revision -m "add_is_default_and_one_time_requests_used"
```

**Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸**:
```python
def upgrade() -> None:
    # Add is_default to subscription_plans
    op.add_column('subscription_plans', sa.Column('is_default', sa.Boolean(), nullable=False, server_default='false'))
    
    # Add one_time_requests_used to billing_accounts
    op.add_column('billing_accounts', sa.Column('one_time_requests_used', sa.Integer(), nullable=False, server_default='0'))

def downgrade() -> None:
    op.drop_column('billing_accounts', 'one_time_requests_used')
    op.drop_column('subscription_plans', 'is_default')
```

## 2.4 Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

**Ð¤Ð°Ð¹Ð»**: `app/auth/router.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `register()`  
**Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸**: ~104-120 (Ð¿Ð¾Ð¸ÑÐº Free Trial Ð¿Ð»Ð°Ð½Ð°)

```python
# Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð¬:
free_trial_plan_result = await db.execute(
    select(SubscriptionPlan).where(SubscriptionPlan.name == "Free Trial")
)

# ÐÐ:
default_plan_result = await db.execute(
    select(SubscriptionPlan).where(SubscriptionPlan.is_default == True)
)
default_plan = default_plan_result.scalar_one_or_none()

if not default_plan:
    # Fallback to first available plan with free requests
    fallback_result = await db.execute(
        select(SubscriptionPlan)
        .where(SubscriptionPlan.free_requests_limit > 0)
        .order_by(SubscriptionPlan.id)
    )
    default_plan = fallback_result.scalar_one_or_none()
```

---

## âœ… ÐšÐ Ð˜Ð¢Ð•Ð Ð˜Ð˜ Ð“ÐžÐ¢ÐžÐ’ÐÐžÐ¡Ð¢Ð˜ Ð­Ð¢ÐÐŸÐ 2:
- [ ] ÐŸÐ¾Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸
- [ ] ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð°
- [ ] Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ is_default Ð¿Ð»Ð°Ð½
- [ ] Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð»Ð°Ð½Ñ‹ Ð² Ð‘Ð” Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹

---

# ðŸŽ¨ Ð­Ð¢ÐÐŸ 3: UX Ð˜ Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯ ÐŸÐ›ÐÐÐžÐ’
> **Ð¦ÐµÐ»ÑŒ**: Ð£Ð»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ð¾Ð¿Ñ‹Ñ‚ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸  
> **Ð’Ñ€ÐµÐ¼Ñ**: ~2 Ñ‡Ð°ÑÐ°  
> **ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚**: Ð¡Ð Ð•Ð”ÐÐ˜Ð™

## 3.1 Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ endpoint Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ð½Ð¾Ð²

**Ð¤Ð°Ð¹Ð»**: `app/billing/router.py`  
**ÐÐ¾Ð²Ñ‹Ð¹ endpoint**: `/billing/plans/available`

```python
@router.get("/plans/available")
async def get_available_plans_for_user(
    current_user: User = Depends(get_current_active_user),
    db: AsyncSession = Depends(get_db)
):
    """Get plans available for purchase by current user based on their subscription state."""
    
    # Get user's billing account
    ba = await db.execute(
        select(BillingAccount).where(BillingAccount.organization_id == current_user.organization_id)
    )
    billing_account = ba.scalar_one_or_none()
    
    has_active_subscription = (
        billing_account 
        and billing_account.subscription_plan_id 
        and billing_account.subscription_status in [SubscriptionStatus.ACTIVE, SubscriptionStatus.TRIALING]
    )
    
    query = select(SubscriptionPlan).order_by(SubscriptionPlan.price)
    
    if has_active_subscription:
        # Only show SUBSCRIPTION plans for upgrade/downgrade
        query = query.where(SubscriptionPlan.plan_type == PlanType.SUBSCRIPTION)
        # Exclude current plan
        query = query.where(SubscriptionPlan.id != billing_account.subscription_plan_id)
    else:
        # Show all valid plans
        pass
    
    result = await db.execute(query)
    plans = result.scalars().all()
    
    # Filter only valid plans
    valid_plans = []
    for plan in plans:
        # Check if plan has agents
        if len(plan.agents) == 0:
            continue
        # Check if has paddle_price_id (if billing enabled)
        if settings.paddle_billing_enabled and not plan.paddle_price_id:
            continue
        valid_plans.append(plan)
    
    return [
        {
            "id": plan.id,
            "name": plan.name,
            "plan_type": plan.plan_type.value,
            "interval": plan.interval.value,
            "price": float(plan.price),
            "currency": plan.currency,
            "max_requests_per_interval": plan.max_requests_per_interval,
            "max_tokens_per_request": plan.max_tokens_per_request,
            "free_requests_limit": plan.free_requests_limit,
            "free_trial_days": plan.free_trial_days,
            "one_time_limit": plan.one_time_limit,
            "agent_count": len(plan.agents),
            "has_api_access": plan.has_api_access,
            "has_priority_support": plan.has_priority_support,
            "has_advanced_analytics": plan.has_advanced_analytics,
        }
        for plan in valid_plans
    ]
```

## 3.2 Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÑŽ Ð¿Ð»Ð°Ð½Ð¾Ð² Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ

**Ð¤Ð°Ð¹Ð»**: `app/billing/router.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `subscribe()`  
**ÐŸÐ¾ÑÐ»Ðµ**: `if not plan:`

```python
# Ð”ÐžÐ‘ÐÐ’Ð˜Ð¢Ð¬ Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð˜:
# Check if plan has agents
if len(plan.agents) == 0:
    raise HTTPException(
        status_code=400, 
        detail="Plan has no agents assigned. Contact administrator."
    )

# Check if plan has valid Paddle configuration (when billing enabled)
if settings.paddle_billing_enabled and not plan.paddle_price_id:
    raise HTTPException(
        status_code=400, 
        detail="Plan is missing payment configuration. Contact administrator."
    )

# Check if user is not trying to subscribe to same plan
if (ba.subscription_plan_id == plan.id 
    and ba.subscription_status in [SubscriptionStatus.ACTIVE, SubscriptionStatus.TRIALING]):
    raise HTTPException(
        status_code=400, 
        detail="You are already subscribed to this plan."
    )
```

## 3.3 Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒ default Ð¿Ð»Ð°Ð½ Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸

**Ð¡ÐºÑ€Ð¸Ð¿Ñ‚**: `scripts/setup_default_plan.py`

```python
"""Link default plan with basic agents."""
import asyncio
from app.core.database import AsyncSessionLocal
from app.models.billing import SubscriptionPlan  
from app.models.agent import Agent
from sqlalchemy import select

async def setup_default_plan():
    """Ensure default plan is linked with at least one agent."""
    async with AsyncSessionLocal() as db:
        # Find default plan
        result = await db.execute(
            select(SubscriptionPlan).where(SubscriptionPlan.is_default == True)
        )
        default_plan = result.scalar_one_or_none()
        
        if not default_plan:
            print("âŒ No default plan found")
            return
            
        # Find basic agents
        agent_result = await db.execute(
            select(Agent).where(Agent.is_active == True)
        )
        agents = agent_result.scalars().all()
        
        if not agents:
            print("âŒ No active agents found")
            return
            
        # Link first agent to default plan if not linked
        if len(default_plan.agents) == 0:
            default_plan.agents.append(agents[0])
            await db.commit()
            print(f"âœ… Linked agent '{agents[0].name}' to default plan '{default_plan.name}'")
        else:
            print(f"âœ… Default plan '{default_plan.name}' already has {len(default_plan.agents)} agents")

if __name__ == "__main__":
    asyncio.run(setup_default_plan())
```

---

## âœ… ÐšÐ Ð˜Ð¢Ð•Ð Ð˜Ð˜ Ð“ÐžÐ¢ÐžÐ’ÐÐžÐ¡Ð¢Ð˜ Ð­Ð¢ÐÐŸÐ 3:
- [ ] Endpoint `/billing/plans/available` Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð½Ñ‹
- [ ] ÐŸÑ€Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ Ð½Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ ONE_TIME Ð¿Ð»Ð°Ð½Ñ‹  
- [ ] Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¿Ð»Ð°Ð½Ð¾Ð² Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
- [ ] Default Ð¿Ð»Ð°Ð½ ÑÐ²ÑÐ·Ð°Ð½ Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼Ð¸

---

# ðŸ”„ Ð­Ð¢ÐÐŸ 4: Ð Ð•Ð¤ÐÐšÐ¢ÐžÐ Ð˜ÐÐ“ Ð˜ ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—ÐÐ¦Ð˜Ð¯
> **Ð¦ÐµÐ»ÑŒ**: Ð£Ð»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñƒ Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ  
> **Ð’Ñ€ÐµÐ¼Ñ**: ~1 Ñ‡Ð°Ñ  
> **ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚**: ÐÐ˜Ð—ÐšÐ˜Ð™ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ)

## 4.1 Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Paddle Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹

**Ð¤Ð°Ð¹Ð»**: `app/billing/router.py`  
**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ**: `subscribe()`

```python
# Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð¬ ÐµÐ´Ð¸Ð½Ñ‹Ð¹ Ð²Ñ‹Ð·Ð¾Ð²:
transaction = _as_dict(
    await paddle.create_subscription(  # âŒ Ð”Ð›Ð¯ Ð’Ð¡Ð•Ð¥ Ð¢Ð˜ÐŸÐžÐ’
        customer_id=ba.paddle_customer_id,
        price_id=plan.paddle_price_id,
    )
)

# ÐÐ Ð ÐÐ—Ð”Ð•Ð›Ð•ÐÐ˜Ð• ÐŸÐž Ð¢Ð˜ÐŸÐÐœ:
if plan.plan_type == PlanType.SUBSCRIPTION:
    # For recurring subscriptions
    transaction = _as_dict(
        await paddle.create_subscription(
            customer_id=ba.paddle_customer_id,
            price_id=plan.paddle_price_id,
        )
    )
else:  # PlanType.ONE_TIME
    # For one-time purchases
    transaction = _as_dict(
        await paddle.create_transaction(
            customer_id=ba.paddle_customer_id,
            price_id=plan.paddle_price_id,
        )
    )
```

## 4.2 Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ computed properties Ð´Ð»Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð»Ð°Ð½Ð¾Ð²

**Ð¤Ð°Ð¹Ð»**: `app/models/billing.py`  
**Ð’ ÐºÐ»Ð°ÑÑ**: `SubscriptionPlan`

```python
@property
def is_valid(self) -> bool:
    """Check if plan is valid for purchase."""
    return (
        len(self.agents) > 0 and 
        (not settings.paddle_billing_enabled or self.paddle_price_id is not None) and
        self.price >= 0
    )

@property  
def validation_errors(self) -> List[str]:
    """Get list of validation errors."""
    errors = []
    if len(self.agents) == 0:
        errors.append("No agents assigned to this plan")
    if settings.paddle_billing_enabled and not self.paddle_price_id:
        errors.append("Missing Paddle price configuration") 
    if self.price < 0:
        errors.append("Invalid price")
    return errors
```

## 4.3 Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº

**ÐœÐ¾Ð´ÐµÐ»ÑŒ**: `app/models/billing.py`

```python
class OneTimePurchase(Base):
    """History of one-time credit purchases."""
    
    __tablename__ = "one_time_purchases"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    billing_account_id: Mapped[int] = mapped_column(
        Integer, ForeignKey("billing_accounts.id", ondelete="CASCADE"), nullable=False
    )
    plan_id: Mapped[int] = mapped_column(
        Integer, ForeignKey("subscription_plans.id", ondelete="SET NULL"), nullable=True
    )
    
    # Purchase details
    credits_purchased: Mapped[int] = mapped_column(Integer, nullable=False)
    price_paid: Mapped[Decimal] = mapped_column(Numeric(10, 2), nullable=False)
    currency: Mapped[str] = mapped_column(String(3), default="USD", nullable=False)
    
    # Paddle details
    paddle_transaction_id: Mapped[Optional[str]] = mapped_column(String(100))
    
    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, nullable=False)
    
    # Relationships
    billing_account: Mapped["BillingAccount"] = relationship("BillingAccount")
    plan: Mapped[Optional["SubscriptionPlan"]] = relationship("SubscriptionPlan")
```

---

## âœ… ÐšÐ Ð˜Ð¢Ð•Ð Ð˜Ð˜ Ð“ÐžÐ¢ÐžÐ’ÐÐžÐ¡Ð¢Ð˜ Ð­Ð¢ÐÐŸÐ 4:
- [ ] Paddle API Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° Ð¿Ð»Ð°Ð½Ð°
- [ ] Computed properties Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚  
- [ ] Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ
- [ ] ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð½Ðµ ÑƒÑ…ÑƒÐ´ÑˆÐ¸Ð»Ð°ÑÑŒ

---

# ðŸ§ª ÐŸÐ›ÐÐ Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯

## ÐŸÐ¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ:

### Ð­Ñ‚Ð°Ð¿ 1:
1. âœ… Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ â†’ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ default Ð¿Ð»Ð°Ð½
2. âœ… ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ â†’ Ð½ÐµÐ»ÑŒÐ·Ñ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ ONE_TIME  
3. âœ… ÐžÑ‚Ð¼ÐµÐ½Ð° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ â†’ Ð¼Ð¾Ð¶Ð½Ð¾ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ ONE_TIME
4. âœ… ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ° â†’ ÐÐ• Ð»Ð¾Ð¼Ð°ÐµÑ‚ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ
5. âœ… Webhook Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° â†’ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð´Ð»Ñ Ð¾Ð±Ð¾Ð¸Ñ… Ñ‚Ð¸Ð¿Ð¾Ð²

### Ð­Ñ‚Ð°Ð¿ 2:  
1. âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº
2. âœ… ÐÐ¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ default Ð¿Ð»Ð°Ð½
3. âœ… Ð¡Ñ‡Ñ‘Ñ‚Ñ‡Ð¸ÐºÐ¸ ONE_TIME Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾

### Ð­Ñ‚Ð°Ð¿ 3:
1. âœ… `/billing/plans/available` Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð»Ð°Ð½Ñ‹
2. âœ… Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð½Ñ‹
3. âœ… UX Ð»Ð¾Ð³Ð¸Ñ‡ÐµÐ½ Ð¸ Ð¿Ð¾Ð½ÑÑ‚ÐµÐ½

### Ð­Ñ‚Ð°Ð¿ 4:
1. âœ… Paddle API Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹  
2. âœ… Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ
3. âœ… ÐÐµÑ‚ Ñ€ÐµÐ³Ñ€ÐµÑÑÐ¸Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

---

# ðŸ“Š ÐœÐ•Ð¢Ð Ð˜ÐšÐ˜ Ð£Ð¡ÐŸÐ•Ð¥Ð

## Ð‘Ð¸Ð·Ð½ÐµÑ-Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸:
- ðŸŽ¯ **0 Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº** Ð¸Ð·-Ð·Ð° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ð»Ð°Ð½Ð¾Ð²
- ðŸ“ˆ **Ð£Ð²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ARPU** Ð·Ð° ÑÑ‡Ñ‘Ñ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÑ‡Ñ‘Ñ‚Ð° ONE_TIME Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº  
- ðŸ˜Š **Ð¡Ð½Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð¶Ð°Ð»Ð¾Ð±** Ð½Ð° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³Ð¾Ð¼

## Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸:
- ðŸ› **0 ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº** Ð² Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³Ðµ
- âš¡ **< 500ms** Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚ÐºÐ»Ð¸ÐºÐ° Ð±Ð¸Ð»Ð»Ð¸Ð½Ð³Ð¾Ð²Ñ‹Ñ… API
- ðŸ“Š **100% ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ** webhook Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

---

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: ðŸ“‹ Ð“ÐžÐ¢ÐžÐ’ Ðš Ð Ð•ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð˜
**Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³**: ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ Ð­Ñ‚Ð°Ð¿Ð° 1 - ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ