# üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´: –°—á–µ—Ç—á–∏–∫ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ù–µ –†–∞–±–æ—Ç–∞–µ—Ç

## üî¥ –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞ #1: UsageMiddleware –û–¢–ö–õ–Æ–ß–ï–ù–ê –≤ Debug —Ä–µ–∂–∏–º–µ
**–§–∞–π–ª:** `app/main.py`, —Å—Ç—Ä–æ–∫–∞ 97
```python
# Usage tracking middleware (non-blocking, low priority)
if not settings.debug:
    # Only add in production to avoid test issues
    app.add_middleware(UsageMiddleware)
```

**–°—Ç–∞—Ç—É—Å:** üî¥ **–ö–†–ò–¢–ò–ß–ù–û**
- `settings.debug = True` (–∏–∑ `.env` —Ñ–∞–π–ª–∞)
- Middleware **–Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è** –ø—Ä–∏ DEBUG=true
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–æ

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ü–∞–º—è—Ç–∏ (In-Memory Cache)
**–§–∞–π–ª:** `app/policy/engine.py`, —Å—Ç—Ä–æ–∫–∞ 20
```python
class PolicyEngine:
    def __init__(self):
        # in-memory rate limit counters: {(user_id, key): (reset_ts, count)}
        self._rate: dict[Tuple[int, str], Tuple[float, int]] = {}
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê**
- Rate limits —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - **–≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è**
- –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –°—á–µ—Ç—á–∏–∫–∏ –≤ UsageMiddleware
**–§–∞–π–ª:** `app/usage/tracker.py`
```python
record = UsageRecord(
    user_id=user.id,
    endpoint=path,
    method=request.method,
    channel="api",
    model_name=None,
    prompt_tokens=0,           # ‚Üê –í—Å–µ–≥–¥–∞ 0!
    completion_tokens=0,       # ‚Üê –í—Å–µ–≥–¥–∞ 0!
    total_tokens=0,            # ‚Üê –í—Å–µ–≥–¥–∞ 0!
    response_time_ms=duration_ms,
    status_code=status_code,
    cost=0,                    # ‚Üê –í—Å–µ–≥–¥–∞ 0!
    error_message=error_message,
    meta=None,
)
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê**
- Tokens –∏ cost **–≤—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ 0**
- UsageMiddleware –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ LLM response –¥–∞–Ω–Ω—ã–º
- –¢–æ–∫–µ–Ω—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ policy_engine.increment_usage()

---

## üìä –ì–¥–µ –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. **API Middleware (–ù–ï –†–ê–ë–û–¢–ê–ï–¢ –≤ Debug)**
```
Request ‚Üí UsageMiddleware (–µ—Å–ª–∏ not DEBUG) ‚Üí Log to DB
```
**–°—Ç–∞—Ç—É—Å:** üî¥ –û—Ç–∫–ª—é—á–µ–Ω–∞ –≤ debug

**–õ–æ–≥–∏—Ä—É–µ—Ç:**
- endpoint, method, status_code, response_time_ms
- **–ù–û:** tokens = 0, cost = 0

---

### 2. **Agent Invocation (–†–ê–ë–û–¢–ê–ï–¢)**
```
Agent /invoke ‚Üí policy_engine.increment_usage() ‚Üí Update BillingAccount
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

**–õ–æ–≥–∏—Ä—É–µ—Ç:**
- Increment free_requests_used –ò–õ–ò requests_used_current_period
- **–ù–û:** –ù–µ –ø–∏—à–µ—Ç –≤ UsageRecord —Ç–∞–±–ª–∏—Ü—É

---

## üêõ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

**–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏:**

1. **UsageMiddleware** (–≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä API)
   - –û—Ç–∫–ª—é—á–µ–Ω –≤ DEBUG —Ä–µ–∂–∏–º–µ ‚ùå
   - –õ–æ–≥–∏—Ä—É–µ—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤ ‚ö†Ô∏è

2. **PolicyEngine** (—Å—á–µ—Ç—á–∏–∫ –±–∏–ª–ª–∏–Ω–≥–∞)
   - –†–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
   - –ù–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª–∏ –≤ UsageRecord ‚ö†Ô∏è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è (DEBUG mode)
- –¢–æ–∫–µ–Ω—ã –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö
- –î–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç—å UsageMiddleware –≤—Å–µ–≥–¥–∞ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç DEBUG)
```python
# –í app/main.py, –∑–∞–º–µ–Ω–∏—Ç—å:
if not settings.debug:
    app.add_middleware(UsageMiddleware)

# –ù–∞:
app.add_middleware(UsageMiddleware)
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ Rate Limiter –∏–∑ –ø–∞–º—è—Ç–∏ –≤ Redis (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) –∏–ª–∏ –ë–î
```python
# –í–º–µ—Å—Ç–æ:
self._rate: dict[Tuple[int, str], Tuple[float, int]] = {}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
# - Redis –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã (–ª—É—á—à–µ)
# - –ë–î –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
```

### –®–∞–≥ 3: –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ AgentRuntime
```python
# –ü—Ä–∏ –≤—ã–∑–æ–≤–µ agent_runtime.run():
# - –ó–∞—Ö–≤–∞—Ç–∏—Ç—å usage data –∏–∑ OpenAI response
# - –ü–µ—Ä–µ–¥–∞—Ç—å –≤ policy_engine.increment_usage()
# - –ó–∞–ø–∏—Å–∞—Ç—å –≤ UsageRecord —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
```

### –®–∞–≥ 4: –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```
AgentInvoke
  ‚Üì
AgentRuntime.run()
  ‚Üì (–ø–æ–ª—É—á–∞–µ—Ç: prompt_tokens, completion_tokens, total_tokens)
  ‚Üì
PolicyEngine.increment_usage()
  ‚Üì (–æ–±–Ω–æ–≤–ª—è–µ—Ç BillingAccount)
  ‚Üì
UsageRecord.create() ‚Üê –í –ë–î —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```

---

## üìã –î–µ–π—Å—Ç–≤–∏—è –î–ª—è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (–°—Ä–æ—á–Ω—ã–µ)

**1. –í–∫–ª—é—á–∏—Ç—å middleware –≤ debug**
- –§–∞–π–ª: `app/main.py`
- –£–¥–∞–ª–∏—Ç—å —É—Å–ª–æ–≤–∏–µ `if not settings.debug:`
- Middleware –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞

**2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ UsageRecord**
```sql
SELECT COUNT(*) FROM usage_records;
SELECT * FROM usage_records ORDER BY created_at DESC LIMIT 10;
```

**3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å BillingAccount**
```sql
SELECT id, organization_id, free_requests_used, 
       requests_used_current_period, period_started_at 
FROM billing_accounts;
```

---

### üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ (–£–ª—É—á—à–µ–Ω–∏—è)

**1. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å rate limiter –∏–∑ –ø–∞–º—è—Ç–∏**
- –ï—Å–ª–∏ –µ—Å—Ç—å Redis - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ
- –ï—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î —Å expiring records

**2. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–æ–≤**
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å AgentRuntime –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ usage
- –ü–µ—Ä–µ–¥–∞—Ç—å –≤ UsageRecord

**3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã**
- Telegram (/invoke) - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è?
- Web (/invoke) - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è?

---

## ‚ùì –í–û–ü–†–û–°–´ –î–õ–Ø –í–ê–°

1. **DEBUG —Ä–µ–∂–∏–º –Ω—É–∂–µ–Ω –≤ production?**
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å —É—Å–ª–æ–≤–∏–µ
   - –ï—Å–ª–∏ –¥–∞ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è middleware

2. **–£ –≤–∞—Å –µ—Å—Ç—å Redis?**
   - –ï—Å–ª–∏ –¥–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è rate limiter
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —è —Å–æ–∑–¥–∞–º —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ë–î

3. **–ù—É–∂–Ω—ã —Ç–æ–∫–µ–Ω—ã –≤ UsageRecord?**
   - –ï—Å–ª–∏ –Ω—É–∂–Ω—ã ‚Üí —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è AgentRuntime
   - –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏?

4. **–ö–∞–∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞–≥–µ–Ω—Ç—ã?**
   - –ù—É–∂–Ω–∞ –ª–∏ –∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î?
   - –ò–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ?

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

```
1. ‚úÖ –í–∫–ª—é—á–∏—Ç—å middleware (2 –º–∏–Ω—É—Ç—ã)
   app/main.py - —É–¥–∞–ª–∏—Ç—å if not settings.debug

2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (5 –º–∏–Ω—É—Ç)
   SELECT * FROM usage_records ORDER BY created_at DESC

3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–ª–∏–Ω–≥ (5 –º–∏–Ω—É—Ç)
   SELECT * FROM billing_accounts

4. üîß –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å rate limiter (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   
5. üîß –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
```

---

**–°—Ç–∞–≤–ª—é –Ω–∞ –ø–∞—É–∑—É –∏ –∂–¥—É –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ß—Ç–æ –≤–∞–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ?**
